@page "/emulators"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Android
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IAndroidSdkService SdkService
@inject IAndroidSdkSettingsService SdkSettings
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject IFileSystemService FileSystem
@inject OperationModalService OperationModal
@inject BlazorToastService ToastService
@implements IDisposable
@inject IJSRuntime JS

<h1><i class="fas fa-desktop"></i> Android Emulators</h1>

<div class="sdk-path-bar">
    <i class="fas fa-folder"></i>
    @if (!string.IsNullOrEmpty(SdkService.SdkPath))
    {
        <span class="sdk-path-text">@SdkService.SdkPath</span>
        <button class="btn-copy" @onclick="@(() => CopyToClipboard(SdkService.SdkPath!))" title="Copy to clipboard">
            <i class="fas fa-copy"></i>
        </button>
        <button class="btn-reveal" @onclick="@(() => FileSystem.RevealInFileManager(SdkService.SdkPath!))" title="Reveal in Finder">
            <i class="fas fa-external-link-alt"></i>
        </button>
    }
    else if (isLoading)
    {
        <span class="sdk-path-text detecting"><i class="fas fa-spinner fa-spin"></i> Detecting SDK...</span>
    }
    else
    {
        <span class="sdk-path-text no-sdk">No SDK detected</span>
    }
    <a class="btn-link-settings" href="settings" title="Change SDK path in Settings">
        <i class="fas fa-cog"></i>
    </a>
</div>

<div class="toolbar">
    <button class="btn btn-primary" @onclick="() => RefreshEmulators(forceRefresh: true)" disabled="@isLoading">
        <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
    </button>
    <button class="btn btn-success" @onclick="ShowCreateDialog" disabled="@isLoading">
        <i class="fas fa-plus"></i> Create Emulator
    </button>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="status-bar @(statusMessage.StartsWith("Error") ? "error" : "")">
        @if (isStartingEmulator)
        {
            <span class="spinner"></span>
        }
        @statusMessage
    </div>
}

<div class="emulator-list">
    @if (isLoading && emulators.Count == 0)
    {
        <div class="loading-state">
            <div class="loading-spinner">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="loading-title">Loading Emulators</div>
            <div class="loading-description">Discovering Android Virtual Devices...</div>
        </div>
    }
    else if (emulators.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="empty-title">No emulators configured</div>
            <div class="empty-description">Click "Create Emulator" to set up a new Android Virtual Device</div>
        </div>
    }
    else
    {
        @foreach (var emulator in emulators)
        {
            var isRunning = runningEmulators.ContainsKey(emulator.Name);
            var isStarting = startingEmulators.Contains(emulator.Name);
            <div class="emulator-card @(isRunning ? "running" : "") @(isStarting ? "starting" : "")">
                <div class="emulator-icon">
                    @if (isStarting)
                    {
                        <span class="spinner-large"></span>
                    }
                    else
                    {
                        <span><i class="fas fa-mobile-alt"></i></span>
                    }
                </div>
                <div class="emulator-details">
                    <div class="emulator-name">@emulator.Name</div>
                    <div class="emulator-info">
                        @if (!string.IsNullOrEmpty(emulator.Device))
                        {
                            <span>@emulator.Device</span>
                        }
                        @if (!string.IsNullOrEmpty(emulator.Target))
                        {
                            <span>â€¢ @emulator.Target</span>
                        }
                    </div>
                    <div class="emulator-badges">
                        @if (isStarting)
                        {
                            <span class="badge badge-starting">Starting...</span>
                        }
                        else if (isRunning)
                        {
                            <span class="badge badge-success">Running</span>
                        }
                        @if (emulator.Properties.TryGetValue("hw.cpu.arch", out var arch))
                        {
                            <span class="badge badge-info">@arch</span>
                        }
                    </div>
                </div>
                <div class="emulator-actions">
                    @if (isStarting)
                    {
                        <button class="btn btn-secondary btn-icon" disabled>
                            <i class="fas fa-spinner fa-spin"></i>
                        </button>
                    }
                    else if (isRunning)
                    {
                        <button class="btn btn-warning btn-icon" @onclick="@(() => StopEmulator(emulator.Name))" disabled="@isLoading" title="Stop">
                            <i class="fas fa-stop"></i>
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success btn-icon" @onclick="@(() => StartEmulator(emulator.Name, false))" disabled="@isLoading" title="Start">
                            <i class="fas fa-play"></i>
                        </button>
                    }
                    <div class="emu-dropdown">
                        <button class="btn btn-secondary btn-icon emu-dropdown-toggle" @onclick="@(() => ToggleDropdown(emulator.Name))" @onclick:stopPropagation="true" title="More actions">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        @if (openDropdown == emulator.Name)
                        {
                            <div class="emu-dropdown-menu">
                                @if (!isRunning && !isStarting)
                                {
                                    <button class="emu-dropdown-item" @onclick="@(() => { openDropdown = null; StartEmulator(emulator.Name, true); })">
                                        <i class="fas fa-sync-alt"></i> Cold Boot
                                    </button>
                                    <div class="emu-dropdown-divider"></div>
                                }
                                <button class="emu-dropdown-item danger" @onclick="@(() => { openDropdown = null; DeleteEmulator(emulator.Name); })" disabled="@(isLoading || isRunning || isStarting)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@if (showCreateDialog)
{
    <div class="modal-overlay" id="create-emu-modal">
        <div class="modal" @onclick:stopPropagation="true" role="dialog" aria-modal="true" aria-labelledby="create-emu-title">
            <div class="modal-header">
                <h2 id="create-emu-title">Create New Emulator</h2>
                <button class="close-btn" @onclick="CloseCreateDialog">Ã—</button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(createProgress))
                {
                    <div class="create-progress">
                        <span class="spinner"></span>
                        <span>@createProgress</span>
                    </div>
                }
                <div class="form-group">
                    <label>Emulator Name</label>
                    <input type="text" @bind="newEmulatorName" placeholder="MyEmulator" disabled="@isCreating" />
                </div>
                <div class="form-group">
                    <label>System Image</label>
                    <select @bind="selectedSystemImage" disabled="@isCreating">
                        <option value="">Select a system image...</option>
                        @if (installedSystemImages.Count > 0)
                        {
                            <optgroup label="âœ“ Installed">
                                @foreach (var image in installedSystemImages)
                                {
                                    <option value="@image">@FormatSystemImage(image)</option>
                                }
                            </optgroup>
                        }
                        @if (availableSystemImages.Count > 0)
                        {
                            <optgroup label="ðŸ“¥ Available to Install">
                                @foreach (var image in availableSystemImages)
                                {
                                    <option value="@image">@FormatSystemImage(image)</option>
                                }
                            </optgroup>
                        }
                    </select>
                    @if (installedSystemImages.Count == 0 && availableSystemImages.Count == 0)
                    {
                        <div class="help-text">No system images found.</div>
                    }
                    else if (!string.IsNullOrEmpty(selectedSystemImage) && !installedSystemImages.Contains(selectedSystemImage))
                    {
                        <div class="help-text info">ðŸ“¥ This image will be downloaded and installed first</div>
                    }
                </div>
                <div class="form-group">
                    <label>Device Definition (optional)</label>
                    <select @bind="selectedDevice" disabled="@isCreating">
                        <option value="">Default</option>
                        @foreach (var device in deviceDefinitions)
                        {
                            <option value="@device.Id">@device.Name (@device.Oem)</option>
                        }
                    </select>
                </div>
                
                <!-- Advanced Options -->
                <details class="advanced-section">
                    <summary>Advanced Options</summary>
                    <div class="advanced-content">
                        <div class="form-group">
                            <label>RAM Size (MB)</label>
                            <select @bind="selectedRamSize" disabled="@isCreating">
                                <option value="">Default</option>
                                <option value="1024">1024 MB (1 GB)</option>
                                <option value="1536">1536 MB (1.5 GB)</option>
                                <option value="2048">2048 MB (2 GB)</option>
                                <option value="3072">3072 MB (3 GB)</option>
                                <option value="4096">4096 MB (4 GB)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Internal Storage (MB)</label>
                            <select @bind="selectedStorageSize" disabled="@isCreating">
                                <option value="">Default (800 MB)</option>
                                <option value="2048">2 GB</option>
                                <option value="4096">4 GB</option>
                                <option value="6144">6 GB</option>
                                <option value="8192">8 GB</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>SD Card Size</label>
                            <select @bind="selectedSdCardSize" disabled="@isCreating">
                                <option value="">None</option>
                                <option value="128M">128 MB</option>
                                <option value="256M">256 MB</option>
                                <option value="512M">512 MB</option>
                                <option value="1G">1 GB</option>
                                <option value="2G">2 GB</option>
                            </select>
                        </div>
                        @if (availableSkins.Count > 0)
                        {
                            <div class="form-group">
                                <label>Skin</label>
                                <select @bind="selectedSkin" disabled="@isCreating">
                                    <option value="">Default</option>
                                    @foreach (var skin in availableSkins)
                                    {
                                        <option value="@skin">@skin</option>
                                    }
                                </select>
                            </div>
                        }
                    </div>
                </details>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateDialog" disabled="@isCreating">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="CreateEmulator" disabled="@(string.IsNullOrEmpty(newEmulatorName) || string.IsNullOrEmpty(selectedSystemImage) || isCreating)">
                    @if (isCreating)
                    {
                        <span><i class="fas fa-spinner fa-spin"></i> Creating...</span>
                    }
                    else if (!string.IsNullOrEmpty(selectedSystemImage) && !installedSystemImages.Contains(selectedSystemImage))
                    {
                        <span><i class="fas fa-download"></i> Install & Create</span>
                    }
                    else
                    {
                        <span><i class="fas fa-plus"></i> Create</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

<style>
    h1 {
        margin-bottom: 20px;
        font-size: 1.75rem;
        color: var(--text-primary);
    }

    .sdk-path-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-tertiary);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        font-family: 'Consolas', 'Monaco', monospace;
    }
    .sdk-path-bar i.fa-folder { color: var(--accent-primary); }
    .sdk-path-text {
        flex: 1;
        color: var(--text-primary);
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sdk-path-text.detecting { color: var(--text-muted); font-style: italic; }
    .sdk-path-text.no-sdk { color: var(--text-secondary); font-style: italic; }

    .btn-link-settings {
        color: var(--text-secondary);
        padding: 4px 8px;
        font-size: 0.875rem;
        text-decoration: none;
        transition: color 0.15s;
    }
    .btn-link-settings:hover {
        color: var(--accent-primary);
    }

    .btn-reveal, .btn-copy {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 2px 6px;
        font-size: 0.75rem;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-reveal:hover, .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-hover);
    }

    .toolbar {
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
    }

    .status-bar {
        background: var(--bg-hover);
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-bar.error {
        background: var(--status-danger-bg);
        color: var(--status-danger-text);
    }

    .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--text-secondary);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .spinner-large {
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-success);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn i { font-size: 0.75rem; }

    .btn-primary { background-color: var(--accent-primary); color: var(--card-bg); }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-success { background-color: var(--accent-success); color: var(--card-bg); }
    .btn-success:hover:not(:disabled) { background-color: var(--accent-success-hover); }
    .btn-warning { background-color: var(--accent-warning); color: var(--card-bg); }
    .btn-warning:hover:not(:disabled) { background-color: var(--accent-warning-hover); }
    .btn-danger { background-color: var(--accent-danger); color: var(--card-bg); }
    .btn-danger:hover:not(:disabled) { background-color: var(--accent-danger-hover); }
    .btn-secondary { background-color: var(--text-secondary); color: var(--card-bg); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--text-muted); }
    .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .emulator-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .emulator-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: var(--card-shadow);
        border-left: 4px solid transparent;
    }

    .emulator-card.running {
        border-left-color: var(--accent-success);
    }

    .emulator-card.starting {
        border-left-color: var(--accent-warning);
        background: var(--status-warning-bg);
    }

    .emulator-icon {
        font-size: 2.25rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent-primary);
    }

    .emulator-icon i { font-size: 2rem; }

    .emulator-details {
        flex: 1;
    }

    .emulator-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .emulator-info {
        font-size: 0.8125rem;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .emulator-info span {
        margin-right: 8px;
    }

    .emulator-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .emulator-actions {
        display: flex;
        gap: 4px;
        align-items: center;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 0.8125rem;
    }
    .btn-icon i { font-size: 0.8125rem; margin: 0; }

    /* â”€â”€ Dropdown â”€â”€ */
    .emu-dropdown { position: relative; }
    .emu-dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        margin-top: 4px;
        min-width: 140px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        z-index: 100;
        padding: 4px 0;
    }
    .emu-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 7px 14px;
        border: none;
        background: none;
        color: var(--text-primary);
        font-size: 0.8125rem;
        cursor: pointer;
        text-align: left;
        transition: background 0.1s;
    }
    .emu-dropdown-item:hover:not(:disabled) { background: var(--bg-tertiary); }
    .emu-dropdown-item:disabled { opacity: 0.4; cursor: not-allowed; }
    .emu-dropdown-item i { font-size: 0.75rem; width: 14px; text-align: center; color: var(--text-secondary); }
    .emu-dropdown-item.danger { color: var(--accent-danger, #e53e3e); }
    .emu-dropdown-item.danger i { color: var(--accent-danger, #e53e3e); }
    .emu-dropdown-divider { height: 1px; background: var(--border-color); margin: 4px 0; }

    .badge {
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-success { background: var(--status-success-bg); color: var(--status-success-text); }
    .badge-info { background: var(--status-info-bg); color: var(--status-info-text); }
    .badge-starting { background: var(--status-warning-bg); color: var(--status-warning-text); }

    .empty-state {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 60px 40px;
        text-align: center;
        box-shadow: var(--card-shadow);
    }

    .empty-icon { font-size: 48px; margin-bottom: 16px; color: var(--text-secondary); }
    .empty-icon i { font-size: 48px; }
    .empty-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
    .empty-description { color: var(--text-muted); font-size: 0.875rem; }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal {
        background: var(--card-bg);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.125rem;
        color: var(--text-primary);
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .create-progress {
        background: var(--status-info-bg);
        border: 1px solid var(--status-info-border);
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--status-info-text);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .help-text {
        margin-top: 8px;
        font-size: 0.75rem;
        color: var(--accent-warning);
    }

    .help-text.info {
        color: var(--accent-primary);
    }

    .advanced-section {
        margin-top: 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .advanced-section summary {
        padding: 12px 16px;
        background: var(--bg-tertiary);
        cursor: pointer;
        font-weight: 500;
        color: var(--text-secondary);
        user-select: none;
    }

    .advanced-section summary:hover {
        background: var(--bg-hover);
    }

    .advanced-section[open] summary {
        border-bottom: 1px solid var(--border-color);
    }

    .advanced-content {
        padding: 16px;
        background: var(--bg-tertiary);
    }

    .advanced-content .form-group {
        margin-bottom: 12px;
    }

    .advanced-content .form-group:last-child {
        margin-bottom: 0;
    }
</style>

@code {
    private List<AvdInfo> emulators = new();
    private List<string> installedSystemImages = new();
    private List<string> availableSystemImages = new();
    private List<string> availableSkins = new();
    private List<AvdDeviceDefinition> deviceDefinitions = new();
    private Dictionary<string, string> runningEmulators = new(); // Name -> Serial
    private HashSet<string> startingEmulators = new();
    private bool isLoading = false;
    private bool isStartingEmulator = false;
    private string statusMessage = "";
    private string? openDropdown = null;
    private System.Threading.Timer? _pollTimer;

    private bool showCreateDialog = false;
    private bool isCreating = false;
    private string createProgress = "";
    private string newEmulatorName = "";
    private string selectedSystemImage = "";
    private string selectedDevice = "";
    
    // Advanced options
    private string selectedRamSize = "";
    private string selectedStorageSize = "";
    private string selectedSdCardSize = "";
    private string selectedSkin = "";

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to SDK path changes from Settings
        SdkService.SdkPathChanged += OnSdkPathChanged;
        
        // Initialize SDK settings (loads stored custom path if any)
        await SdkSettings.InitializeAsync();
        
        // Initial load uses cache (no force refresh)
        await RefreshEmulators(forceRefresh: false);
    }

    private void OnSdkPathChanged()
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await RefreshEmulators(forceRefresh: true);
        });
    }

    private async Task RefreshEmulators(bool forceRefresh = false)
    {
        isLoading = true;
        statusMessage = ""; // Clear status - we show loading state in the UI
        StateHasChanged();
        
        ToastMessage? toast = null;
        if (forceRefresh)
        {
            toast = ToastService.Show("Refreshing emulators...", ToastType.Info);
        }
        
        try
        {
            // If force refresh, invalidate caches first
            if (forceRefresh)
            {
                await Mediator.FlushStores("android:emulators");
                await Mediator.FlushStores("android:systemimages");
                await Mediator.FlushStores("android:packages:available");
            }
            
            // Run independent requests in parallel for faster loading
            var emuTask = Mediator.Request(new GetEmulatorsRequest());
            var sysImgTask = Mediator.Request(new GetSystemImagesRequest());
            var deviceDefsTask = Mediator.Request(new GetDeviceDefinitionsRequest());
            var skinsTask = Mediator.Request(new GetAvdSkinsRequest());
            var availPkgsTask = Mediator.Request(new GetAvailablePackagesRequest());
            
            await Task.WhenAll(emuTask, sysImgTask, deviceDefsTask, skinsTask, availPkgsTask);
            
            var (_, emuResult) = await emuTask;
            emulators = emuResult?.ToList() ?? new();
            
            var (_, sysImgResult) = await sysImgTask;
            installedSystemImages = sysImgResult?.ToList() ?? new();
            
            var (_, deviceDefs) = await deviceDefsTask;
            deviceDefinitions = deviceDefs?.ToList() ?? new();
            
            var (_, skins) = await skinsTask;
            availableSkins = skins?.ToList() ?? new();
            
            // Get available system images from available packages
            var (_, availPkgs) = await availPkgsTask;
            availableSystemImages = (availPkgs ?? Enumerable.Empty<SdkPackageInfo>())
                .Where(p => p.Path.StartsWith("system-images;"))
                .Select(p => p.Path)
                .Where(p => !installedSystemImages.Contains(p))
                .OrderByDescending(p => p) // Newest first
                .Take(50) // Limit to avoid overwhelming the dropdown
                .ToList();

            await RefreshRunningState(forceRefresh);
            statusMessage = "";
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            if (toast != null) ToastService.Dismiss(toast);
            StateHasChanged();
        }
    }

    private async Task RefreshRunningState(bool forceRefresh = false)
    {
        if (forceRefresh)
        {
            await Mediator.FlushStores("android:devices");
        }
        
        var (_, devices) = await Mediator.Request(new GetAndroidDevicesRequest());
        runningEmulators.Clear();
        
        foreach (var device in (devices ?? Enumerable.Empty<DeviceInfo>()).Where(d => d.IsEmulator))
        {
            foreach (var avd in emulators)
            {
                if (device.Model?.Contains(avd.Name) == true || 
                    (avd.Properties.TryGetValue("avd.ini.displayname", out var displayName) && 
                     device.Model?.Contains(displayName) == true))
                {
                    runningEmulators[avd.Name] = device.Serial;
                    startingEmulators.Remove(avd.Name);
                }
            }
        }
    }

    private void ToggleDropdown(string name)
    {
        openDropdown = openDropdown == name ? null : name;
    }

    private void ShowCreateDialog()
    {
        newEmulatorName = "";
        selectedSystemImage = installedSystemImages.FirstOrDefault() ?? "";
        selectedDevice = "";
        selectedRamSize = "";
        selectedStorageSize = "";
        selectedSdCardSize = "";
        selectedSkin = "";
        createProgress = "";
        isCreating = false;
        showCreateDialog = true;
        _ = InitModalAsync("create-emu-modal");
        openDropdown = null;
    }

    private void CloseCreateDialog()
    {
        if (!isCreating)
        {
            showCreateDialog = false;
            _ = DisposeModalAsync("create-emu-modal");
        }
    }

    private async Task CreateEmulator()
    {
        if (string.IsNullOrWhiteSpace(newEmulatorName) || string.IsNullOrWhiteSpace(selectedSystemImage))
            return;

        showCreateDialog = false;
        _ = DisposeModalAsync("create-emu-modal");
        var emulatorName = newEmulatorName.Trim().Replace(" ", "_");
        var systemImage = selectedSystemImage;
        var needsInstall = !installedSystemImages.Contains(systemImage);

        var result = await OperationModal.RunAsync(
            "Create Emulator",
            $"Creating emulator '{emulatorName}'...",
            async ctx =>
            {
                ctx.LogInfo($"Emulator name: {emulatorName}");
                ctx.LogInfo($"System image: {systemImage}");

                // Check if we need to install the system image first
                if (needsInstall)
                {
                    ctx.SetStatus("Installing system image...");
                    ctx.LogInfo("System image not installed, downloading...");
                    
                    var installSuccess = await SdkService.InstallPackageAsync(systemImage, new Progress<string>(msg =>
                    {
                        ctx.LogInfo(msg);
                        ctx.SetStatus(msg);
                    }));
                    
                    if (!installSuccess)
                    {
                        ctx.LogError("Failed to install system image");
                        return false;
                    }
                    ctx.LogSuccess("System image installed");
                }

                ctx.SetStatus("Creating AVD...");

                var createOptions = new EmulatorCreateOptions(
                    Device: string.IsNullOrEmpty(selectedDevice) ? null : selectedDevice,
                    SdCardSize: string.IsNullOrEmpty(selectedSdCardSize) ? null : selectedSdCardSize,
                    Skin: string.IsNullOrEmpty(selectedSkin) ? null : selectedSkin,
                    RamSizeMb: string.IsNullOrEmpty(selectedRamSize) ? null : int.Parse(selectedRamSize),
                    InternalStorageMb: string.IsNullOrEmpty(selectedStorageSize) ? null : int.Parse(selectedStorageSize)
                );

                var success = await SdkService.CreateAvdAsync(
                    emulatorName,
                    systemImage,
                    createOptions,
                    new Progress<string>(msg =>
                    {
                        ctx.LogInfo(msg);
                        ctx.SetStatus(msg);
                    }));

                if (success)
                {
                    ctx.LogSuccess($"Emulator '{emulatorName}' created successfully");
                }
                return success;
            });

        if (result.Success)
        {
            await RefreshEmulators(forceRefresh: true);
        }
    }

    private async Task StartEmulator(string name, bool coldBoot)
    {
        openDropdown = null;
        var bootType = coldBoot ? " (cold boot)" : "";

        var result = await OperationModal.RunAsync(
            "Start Emulator",
            $"Starting {name}{bootType}...",
            async ctx =>
            {
                ctx.LogInfo($"Emulator: {name}");
                ctx.LogInfo($"Cold boot: {coldBoot}");
                ctx.SetStatus("Launching emulator process...");

                var success = await SdkService.StartEmulatorAsync(name, coldBoot, new Progress<string>(msg =>
                {
                    ctx.LogInfo(msg);
                    ctx.SetStatus(msg);
                }));
                
                if (!success)
                {
                    ctx.LogError("Failed to start emulator");
                    return false;
                }

                ctx.SetStatus("Waiting for emulator to boot...");
                ctx.LogInfo("Emulator process started, waiting for boot...");
                
                var maxWait = TimeSpan.FromSeconds(60);
                var pollInterval = TimeSpan.FromSeconds(2);
                var elapsed = TimeSpan.Zero;
                
                while (elapsed < maxWait)
                {
                    ctx.CancellationToken.ThrowIfCancellationRequested();
                    await Task.Delay(pollInterval);
                    elapsed += pollInterval;
                    
                    var devices = await SdkService.GetDevicesAsync();
                    var emulatorDevice = devices.FirstOrDefault(d => d.IsEmulator);
                    
                    if (emulatorDevice != null)
                    {
                        ctx.LogSuccess($"Emulator '{name}' is now running");
                        return true;
                    }
                    
                    ctx.SetStatus($"Waiting for boot... ({elapsed.TotalSeconds:0}s)");
                    ctx.SetProgress((int)((elapsed.TotalSeconds / maxWait.TotalSeconds) * 100));
                }

                ctx.LogWarning("Emulator started but may still be booting");
                return true;
            });

        await RefreshRunningState();
    }

    private async Task StopEmulator(string name)
    {
        if (!runningEmulators.TryGetValue(name, out var serial))
            return;

        var result = await OperationModal.RunAsync(
            "Stop Emulator",
            $"Stopping {name}...",
            async ctx =>
            {
                ctx.LogInfo($"Emulator: {name}");
                ctx.LogInfo($"Serial: {serial}");
                ctx.SetStatus("Sending shutdown command...");

                await SdkService.StopEmulatorAsync(serial);
                ctx.LogInfo("Shutdown command sent, waiting...");
                
                await Task.Delay(2000);
                ctx.LogSuccess($"Emulator '{name}' stopped");
                return true;
            },
            canCancel: false);

        await RefreshRunningState();
    }

    private async Task DeleteEmulator(string name)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Delete Emulator",
            $"Are you sure you want to delete '{name}'? This cannot be undone.");

        if (!confirm) return;

        var result = await OperationModal.RunAsync(
            "Delete Emulator",
            $"Deleting '{name}'...",
            async ctx =>
            {
                ctx.LogInfo($"Emulator: {name}");
                ctx.SetStatus("Deleting AVD...");

                var success = await SdkService.DeleteAvdAsync(name);
                if (success)
                {
                    ctx.LogSuccess($"Emulator '{name}' deleted");
                }
                return success;
            },
            canCancel: false);

        if (result.Success)
        {
            // Immediately remove from list for responsive UI
            var emulator = emulators.FirstOrDefault(e => e.Name == name);
            if (emulator != null)
            {
                emulators.Remove(emulator);
                StateHasChanged();
            }
            
            await RefreshEmulators(forceRefresh: true);
        }
    }

    private string FormatSystemImage(string path)
    {
        var parts = path.Split(';');
        if (parts.Length >= 4)
        {
            var api = parts[1].Replace("android-", "Android ");
            var variant = parts[2].Replace("_", " ");
            var arch = parts[3];
            return $"{api} ({variant}, {arch})";
        }
        return path;
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }

    public void Dispose()
    {
        SdkService.SdkPathChanged -= OnSdkPathChanged;
        _pollTimer?.Dispose();
        foreach (var id in _activeModals)
            try { JS.InvokeVoidAsync("modalInterop.dispose", id); } catch { }
        _dotNetRef?.Dispose();
    }

    private DotNetObjectReference<Emulators>? _dotNetRef;
    private readonly HashSet<string> _activeModals = new();

    private async Task InitModalAsync(string modalId)
    {
        await Task.Yield();
        _dotNetRef ??= DotNetObjectReference.Create(this);
        _activeModals.Add(modalId);
        await JS.InvokeVoidAsync("modalInterop.initialize", modalId, _dotNetRef);
    }

    private async Task DisposeModalAsync(string modalId)
    {
        _activeModals.Remove(modalId);
        try { await JS.InvokeVoidAsync("modalInterop.dispose", modalId); } catch { }
    }

    [JSInvokable]
    public void OnEscapePressed()
    {
        CloseCreateDialog();
        InvokeAsync(StateHasChanged);
    }
}
