@page "/secrets/publish"
@using MauiSherpa.Core.Interfaces
@inject IManagedSecretsService SecretsService
@inject ICloudSecretsService CloudSecretsService
@inject ISecretsPublisherService PublisherService
@inject IAlertService AlertService
@inject ILoggingService Logger
@inject IAppleIdentityStateService IdentityState

<h1><i class="fas fa-upload"></i> Publish Secrets</h1>

<div class="publish-sections">
    @* Section 1: Apple CI Secrets *@
    <div class="section-card">
        <div class="section-header">
            <div class="section-icon"><i class="fab fa-apple"></i></div>
            <div class="section-info">
                <h2>Apple CI/CD Secrets</h2>
                <p>Configure and export Apple signing certificates, provisioning profiles, and notarization credentials for CI/CD pipelines.</p>
            </div>
            <button class="btn btn-primary" @onclick="ShowCISecretsWizard">
                <i class="fas fa-wand-magic-sparkles"></i> Launch Wizard
            </button>
        </div>
    </div>

    @* Section 2: Managed Secrets Publishing *@
    <div class="section-card">
        <div class="section-header">
            <div class="section-icon"><i class="fas fa-vault"></i></div>
            <div class="section-info">
                <h2>Managed Secrets</h2>
                <p>Publish your managed secrets to CI/CD platforms (GitHub Actions, GitLab CI, Azure DevOps, Gitea).</p>
            </div>
        </div>

        @if (CloudSecretsService.ActiveProvider is null)
        {
            <div class="section-body">
                <div class="info-message">
                    <i class="fas fa-info-circle"></i>
                    Configure a cloud secrets provider in <a href="settings">Settings</a> to manage and publish secrets.
                </div>
            </div>
        }
        else if (isLoading)
        {
            <div class="section-body">
                <div class="loading-inline"><i class="fas fa-spinner fa-spin"></i> Loading secrets...</div>
            </div>
        }
        else if (secrets.Count == 0)
        {
            <div class="section-body">
                <div class="info-message">
                    <i class="fas fa-info-circle"></i>
                    No managed secrets found. <a href="secrets">Create secrets</a> first, then come back to publish them.
                </div>
            </div>
        }
        else
        {
            <div class="section-body">
                <div class="secret-select-list">
                    <div class="select-header">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="selectAll" @bind:event="oninput" @onclick="ToggleSelectAll" />
                            Select All (@selectedSecrets.Count selected)
                        </label>
                    </div>
                    @foreach (var secret in secrets)
                    {
                        <div class="select-item">
                            <label class="checkbox-label">
                                <input type="checkbox" checked="@selectedSecrets.Contains(secret.Key)"
                                       @onchange="@(e => ToggleSecret(secret.Key, (bool)(e.Value ?? false)))" />
                                <span class="select-key">@secret.Key</span>
                                <span class="badge @(secret.Type == ManagedSecretType.File ? "badge-file" : "badge-string")">
                                    @(secret.Type == ManagedSecretType.File ? "File" : "String")
                                </span>
                            </label>
                        </div>
                    }
                </div>

                @if (selectedSecrets.Count > 0)
                {
                    <div class="publish-actions">
                        <p class="publish-info">
                            <i class="fas fa-info-circle text-info"></i>
                            Selected secrets will be published as CI/CD variables/secrets to your configured publisher.
                        </p>
                        <button class="btn btn-primary" @onclick="PublishSelectedSecrets" disabled="@isPublishing">
                            <i class="fas @(isPublishing ? "fa-spinner fa-spin" : "fa-upload")"></i>
                            Publish @selectedSecrets.Count Secret(s)
                        </button>
                    </div>
                }
            </div>
        }
    </div>
</div>

<CISecretsWizard @bind-IsVisible="showCISecretsWizard" />

@code {
    List<ManagedSecret> secrets = new();
    HashSet<string> selectedSecrets = new();
    bool isLoading = false;
    bool isPublishing = false;
    bool selectAll = false;
    bool showCISecretsWizard = false;

    protected override async Task OnInitializedAsync()
    {
        await CloudSecretsService.InitializeAsync();
        await LoadSecretsAsync();
    }

    async Task LoadSecretsAsync()
    {
        if (CloudSecretsService.ActiveProvider is null) return;

        isLoading = true;
        StateHasChanged();

        try
        {
            var result = await SecretsService.ListAsync();
            secrets = result.ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load secrets for publishing: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    void ShowCISecretsWizard()
    {
        showCISecretsWizard = true;
    }

    void ToggleSecret(string key, bool selected)
    {
        if (selected)
            selectedSecrets.Add(key);
        else
            selectedSecrets.Remove(key);

        selectAll = selectedSecrets.Count == secrets.Count;
    }

    void ToggleSelectAll()
    {
        if (selectAll)
        {
            selectedSecrets.Clear();
            selectAll = false;
        }
        else
        {
            selectedSecrets = secrets.Select(s => s.Key).ToHashSet();
            selectAll = true;
        }
    }

    async Task PublishSelectedSecrets()
    {
        var publishers = await PublisherService.GetPublishersAsync();
        if (!publishers.Any())
        {
            await AlertService.ShowAlertAsync("No Publisher Configured",
                "Configure a CI/CD publisher in the Apple CI Secrets wizard first, then return here to publish managed secrets.");
            return;
        }

        var publisher = PublisherService.GetPublisherInstance(publishers[0].Id);
        if (publisher is null)
        {
            await AlertService.ShowAlertAsync("Error", "Could not create publisher instance.");
            return;
        }

        isPublishing = true;
        StateHasChanged();

        try
        {
            // Build secrets dictionary
            var secretsDict = new Dictionary<string, string>();

            foreach (var key in selectedSecrets)
            {
                var value = await SecretsService.GetValueAsync(key);
                if (value is null) continue;

                var secret = secrets.FirstOrDefault(s => s.Key == key);
                var stringValue = secret?.Type == ManagedSecretType.File
                    ? Convert.ToBase64String(value)
                    : System.Text.Encoding.UTF8.GetString(value);

                var secretName = key.ToUpperInvariant().Replace("-", "_").Replace("/", "_").Replace(".", "_");
                secretsDict[secretName] = stringValue;
            }

            if (secretsDict.Count == 0)
            {
                await AlertService.ShowAlertAsync("No Secrets", "No secret values could be loaded.");
                return;
            }

            // List repos for user selection
            var repos = await publisher.ListRepositoriesAsync();
            if (!repos.Any())
            {
                await AlertService.ShowAlertAsync("No Repositories", "No repositories found for this publisher.");
                return;
            }

            // Use first repo for now â€” full repo picker can be added later
            var repo = repos[0];

            var confirmed = await AlertService.ShowConfirmAsync("Publish Secrets",
                $"Publish {secretsDict.Count} secret(s) to {repo.FullName}?");
            if (!confirmed) return;

            await PublisherService.PublishSecretsAsync(
                publishers[0].Id, repo.Id, secretsDict);

            await AlertService.ShowAlertAsync("Published",
                $"Published {secretsDict.Count} secret(s) to {repo.FullName}.");
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to publish secrets: {ex}");
            await AlertService.ShowAlertAsync("Error", $"Failed to publish secrets: {ex.Message}");
        }
        finally
        {
            isPublishing = false;
            StateHasChanged();
        }
    }
}

<style>
    h1 { margin-bottom: 1.25rem; font-size: 1.75rem; color: var(--text-primary); }

    .publish-sections { display: flex; flex-direction: column; gap: 1.25rem; }

    .section-card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.25rem 1.5rem;
    }

    .section-icon {
        font-size: 2rem;
        color: var(--accent-primary);
        flex-shrink: 0;
        width: 2.5rem;
        text-align: center;
    }

    .section-info { flex: 1; }
    .section-info h2 { margin: 0; font-size: 1.125rem; color: var(--text-primary); }
    .section-info p { margin: 0.25rem 0 0; font-size: 0.875rem; color: var(--text-secondary); }

    .section-body { padding: 0 1.5rem 1.25rem; }

    .info-message {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(66, 153, 225, 0.05));
        border: 1px solid rgba(66, 153, 225, 0.3);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    .info-message i { color: var(--accent-primary); margin-top: 2px; }
    .info-message a { color: var(--accent-primary); text-decoration: none; }
    .info-message a:hover { text-decoration: underline; }

    .loading-inline {
        font-size: 0.875rem;
        color: var(--text-muted);
        padding: 0.5rem 0;
    }

    /* Secret Selection */
    .secret-select-list {
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        overflow: hidden;
    }

    .select-header {
        padding: 0.625rem 0.75rem;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.8125rem;
    }

    .select-item {
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        transition: background 0.1s;
    }
    .select-item:last-child { border-bottom: none; }
    .select-item:hover { background: var(--bg-hover); }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        color: var(--text-primary);
    }

    .select-key { font-family: monospace; font-weight: 500; }

    .badge { padding: 2px 0.625rem; border-radius: 0.75rem; font-size: 0.6875rem; font-weight: 500; margin-left: auto; }
    .badge-string { background: var(--status-info-bg); color: var(--status-info-text); }
    .badge-file { background: #faf5ff; color: #6b46c1; }

    .publish-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }
    .publish-info { flex: 1; margin: 0; font-size: 0.8125rem; color: var(--text-muted); display: flex; align-items: center; gap: 0.375rem; }
    .text-info { color: var(--status-info-text); }

    /* Buttons */
    .btn {
        padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem;
        font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease;
        display: inline-flex; align-items: center; gap: 0.375rem;
    }
    .btn i { font-size: 0.75rem; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-secondary { background-color: var(--bg-hover); color: var(--text-secondary); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Dark mode overrides */
    :global(.theme-dark) .badge-file { background: rgba(107, 70, 193, 0.2); color: #d6bcfa; }
</style>
