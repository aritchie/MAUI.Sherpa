@page "/root-certificates"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Apple
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IAppleRootCertService CertService
@inject IAlertService AlertService
@inject IPlatformService Platform
@inject OperationModalService OperationModal
@inject BlazorToastService ToastService

<h1><i class="fas fa-shield-alt"></i> Apple Root & Intermediate Certificates</h1>

@if (!CertService.IsSupported)
{
    <div class="not-supported">
        <div class="warning-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <h2>macOS Only</h2>
        <p>Certificate management is only available on macOS.</p>
    </div>
}
else
{
    <p class="page-description">
        Manage Apple root and intermediate certificates required for code signing.
        Missing certificates can cause "unable to build chain for self-signed root" errors.
    </p>

    @if (isLoading)
    {
        <div class="loading">
            <span class="spinner"></span>
            <span>@statusMessage</span>
        </div>
    }

    <div class="tabs">
        <button class="tab @(activeTab == "root" ? "active" : "")" @onclick="@(() => activeTab = "root")">
            Root Certificates
        </button>
        <button class="tab @(activeTab == "intermediate" ? "active" : "")" @onclick="@(() => activeTab = "intermediate")">
            Intermediate Certificates
        </button>
    </div>
    
    <div class="section">
        <div class="section-header">
            <div class="section-title">
                @if (activeTab == "root")
                {
                    <span>Root Certificates</span>
                }
                else
                {
                    <span>Intermediate Certificates</span>
                }
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" @onclick="() => RefreshInstalledCerts(forceRefresh: true)" disabled="@isLoading">
                    <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
                </button>
                <button class="btn btn-primary btn-sm" @onclick="InstallAllMissing" disabled="@(isLoading || !HasMissingCerts())">
                    <i class="fas fa-download"></i> Install All Missing
                </button>
            </div>
        </div>

        <div class="cert-list">
            @if (isLoading && availableCerts.Count == 0)
            {
                <div class="loading-state">
                    <div class="loading-spinner">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="loading-title">Loading Certificates</div>
                    <div class="loading-description">Checking Apple root certificates...</div>
                </div>
            }
            else
            {
                @foreach (var cert in availableCerts.Where(c => c.Type == (activeTab == "root" ? "Root" : "Intermediate")))
                {
                    var isInstalled = IsCertInstalled(cert);
                    <div class="cert-item @(isInstalled ? "installed" : "not-installed")">
                        <div class="cert-icon"><i class="fas @(isInstalled ? "fa-check-circle" : "fa-square")"></i></div>
                        <div class="cert-info">
                            <div class="cert-name">@cert.Name</div>
                            @if (!string.IsNullOrEmpty(cert.Description))
                            {
                                <div class="cert-details">@cert.Description</div>
                            }
                        </div>
                        <div class="cert-actions">
                            @if (installingCerts.Contains(cert.Name))
                            {
                                <span class="installing"><span class="spinner-small"></span> Installing...</span>
                            }
                            else if (isInstalled)
                            {
                                <span class="status-installed"><i class="fas fa-check"></i> Installed</span>
                            }
                        else
                        {
                            <button class="btn btn-sm btn-primary" @onclick="@(() => InstallCert(cert))" disabled="@isLoading">
                                <i class="fas fa-download"></i> Install
                            </button>
                        }
                    </div>
                </div>
                }
            }
        </div>
    </div>
}

<style>
    h1 {
        margin-bottom: 0.5rem;
        font-size: 1.75rem;
        color: var(--text-primary);
    }

    .page-description {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
    }

    .not-supported {
        text-align: center;
        padding: 3.75rem 1.25rem;
        background: var(--status-error-bg);
        border-radius: 0.75rem;
        border: 1px solid var(--accent-danger);
    }

    .not-supported .warning-icon {
        font-size: 48px;
        margin-bottom: 1rem;
        color: var(--accent-warning);
    }

    .not-supported .warning-icon i { font-size: 48px; }

    .not-supported h2 {
        color: var(--accent-danger);
        margin-bottom: 0.5rem;
    }

    .not-supported p {
        color: var(--text-muted);
    }

    .loading {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1.25rem;
        background: var(--status-info-bg);
        color: var(--status-info-text);
        border-radius: 0.5rem;
        margin-bottom: 1.25rem;
    }

    .section {
        background: var(--card-bg);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 0.25rem rgba(0, 0, 0, 0.05);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.75rem;
    }

    .header-actions {
        display: flex;
        gap: 0.5rem;
    }

    .tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
    }

    .tab {
        padding: 0.75rem 1.25rem;
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        font-size: 0.875rem;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s ease;
    }

    .tab:hover {
        color: var(--accent-primary);
    }

    .tab.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
        font-weight: 600;
    }
    
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .cert-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .cert-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        transition: all 0.15s;
    }

    .cert-item:hover {
        border-color: var(--bg-hover);
        background: var(--bg-tertiary);
    }

    .cert-item.installed {
        background: var(--status-success-bg);
        border-color: var(--accent-success);
    }

    .cert-item.not-installed {
        background: var(--status-warning-bg);
        border-color: var(--accent-warning);
    }

    .cert-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
        width: 1.5rem;
        text-align: center;
    }

    .cert-icon .fa-check-circle { color: var(--accent-success); }
    .cert-icon .fa-square { color: var(--bg-hover); }

    .cert-info {
        flex: 1;
        min-width: 0;
    }

    .cert-name {
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cert-details {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .cert-actions {
        flex-shrink: 0;
    }

    .status-installed {
        color: var(--accent-success-hover);
        font-size: 0.8125rem;
        font-weight: 500;
    }

    .installing {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: var(--accent-primary);
        font-size: 0.8125rem;
    }

    .empty-state {
        text-align: center;
        padding: 2.5rem 1.25rem;
        color: var(--text-muted);
    }

    .spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid var(--border-color);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .spinner-small {
        display: inline-block;
        width: 0.875rem;
        height: 0.875rem;
        border: 2px solid var(--border-color);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: var(--accent-primary);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--accent-primary-hover);
    }

    .btn-secondary {
        background: var(--bg-hover);
        color: var(--text-secondary);
    }

    .btn-secondary:hover:not(:disabled) {
        background: var(--border-color);
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8125rem;
    }
</style>

@code {
    private List<AppleRootCertInfo> availableCerts = new();
    private HashSet<string> installedSerials = new();
    private HashSet<string> installedCertNames = new();
    private HashSet<string> installingCerts = new();
    private IReadOnlyDictionary<string, MauiSherpa.Core.Services.CachedCertInfo>? cachedCerts;
    private bool isLoading = false;
    private string statusMessage = "";
    private string activeTab = "intermediate"; // Most commonly needed

    protected override async Task OnInitializedAsync()
    {
        availableCerts = CertService.GetAvailableCertificates().ToList();
        if (CertService.IsSupported)
        {
            isLoading = true;
            statusMessage = "Initializing certificate cache...";
            StateHasChanged();
            
            // Wait for background caching to complete (usually already done)
            var progress = new Progress<string>(msg =>
            {
                statusMessage = msg;
                InvokeAsync(StateHasChanged);
            });
            await CertService.EnsureCertsCachedAsync(progress);
            cachedCerts = CertService.GetCachedCerts();
            
            await RefreshInstalledCerts(forceRefresh: true);
        }
    }

    private async Task RefreshInstalledCerts(bool forceRefresh = false)
    {
        isLoading = true;
        statusMessage = "Checking installed certificates...";
        StateHasChanged();

        ToastMessage? toast = null;
        if (forceRefresh)
        {
            toast = ToastService.Show("Refreshing certificates...", ToastType.Info);
        }

        try
        {
            // If force refresh, invalidate the cache first
            if (forceRefresh)
            {
                await Mediator.FlushStores("local:applecerts");
            }
            
            var (_, installedCerts) = await Mediator.Request(new GetInstalledCertsRequest());
            
            var certList = installedCerts?.ToList() ?? new();
            
            // Track installed serial numbers for precise matching
            installedSerials = certList
                .Where(c => !string.IsNullOrEmpty(c.SerialNumber))
                .Select(c => c.SerialNumber!.ToUpperInvariant())
                .ToHashSet(StringComparer.OrdinalIgnoreCase);
            
            // Also track names for fallback matching
            installedCertNames = certList
                .Select(c => c.SubjectName.ToLowerInvariant())
                .ToHashSet();
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to check certificates: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            statusMessage = "";
            if (toast != null) ToastService.Dismiss(toast);
            StateHasChanged();
        }
    }

    private bool IsCertInstalled(AppleRootCertInfo cert)
    {
        // Use cached serial number for precise matching (most reliable)
        if (cachedCerts != null && cachedCerts.TryGetValue(cert.Name, out var cached) && !string.IsNullOrEmpty(cached.SerialNumber))
        {
            return installedSerials.Contains(cached.SerialNumber);
        }

        // Fallback: simple name matching
        var simpleName = cert.Name.ToLowerInvariant().Replace(" - ", " ").Replace("-", " ");
        return installedCertNames.Any(installed => installed.Contains(simpleName));
    }

    private bool HasMissingCerts()
    {
        return availableCerts.Any(c => !IsCertInstalled(c));
    }

    private async Task InstallCert(AppleRootCertInfo cert)
    {
        var result = await OperationModal.RunAsync(
            "Install Certificate",
            $"Installing {cert.Name}...",
            async ctx =>
            {
                ctx.LogInfo($"Certificate: {cert.Name}");
                ctx.LogInfo($"Type: {cert.Type}");
                ctx.SetStatus("Downloading certificate...");
                
                var success = await CertService.InstallCertificateAsync(cert, new Progress<string>(msg =>
                {
                    ctx.LogInfo(msg);
                    ctx.SetStatus(msg);
                }));
                
                if (success)
                {
                    ctx.LogSuccess("Certificate installed to Keychain");
                }
                return success;
            });

        if (result.Success)
        {
            await RefreshInstalledCerts(forceRefresh: true);
        }
    }

    private async Task InstallAllMissing()
    {
        var missing = availableCerts.Where(c => !IsCertInstalled(c)).ToList();
        if (missing.Count == 0)
        {
            await AlertService.ShowToastAsync("All certificates are already installed");
            return;
        }

        var result = await OperationModal.RunAsync(
            "Install Missing Certificates",
            $"Installing {missing.Count} missing certificate(s)...",
            async ctx =>
            {
                var installed = 0;
                var failed = 0;

                foreach (var cert in missing)
                {
                    ctx.CancellationToken.ThrowIfCancellationRequested();
                    ctx.SetStatus($"Installing {cert.Name}...");
                    ctx.SetProgress(((installed + failed) * 100) / missing.Count);

                    var success = await CertService.InstallCertificateAsync(cert, null);
                    if (success)
                    {
                        installed++;
                        ctx.LogSuccess($"Installed: {cert.Name}");
                    }
                    else
                    {
                        failed++;
                        ctx.LogError($"Failed: {cert.Name}");
                    }
                }

                ctx.SetProgress(100);
                ctx.LogInfo($"Completed: {installed} installed, {failed} failed");
                return failed == 0;
            });

        await RefreshInstalledCerts(forceRefresh: true);
    }
}
