@page "/bundle-ids"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Apple
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IAppleConnectService AppleService
@inject IAppleIdentityStateService IdentityState
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject OperationModalService OperationModal
@inject BlazorToastService ToastService
@implements IDisposable

<h1><i class="fas fa-fingerprint"></i> Bundle IDs</h1>

<AppleIdentityPicker />

@if (IdentityState.SelectedIdentity != null)
{
    <div class="toolbar">
        <button class="btn btn-primary" @onclick="@(() => RefreshData(forceRefresh: true))" disabled="@isRefreshing">
            <i class="fas @(isRefreshing ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
        </button>
        <button class="btn btn-success" @onclick="ShowCreateDialog" disabled="@isRefreshing">
            <i class="fas fa-plus"></i> Register Bundle ID
        </button>
        <MauiSherpa.Components.BackgroundRefreshIndicator IsRefreshing="@isBackgroundRefreshing" />
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="search-box">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" @bind="searchQuery" @bind:event="oninput" placeholder="Search bundle IDs..." />
                @if (!string.IsNullOrEmpty(searchQuery))
                {
                    <button class="clear-btn" @onclick="@(() => searchQuery = "")">×</button>
                }
            </div>
            <div class="filter-chips">
                <select @bind="filterPlatform" class="filter-select">
                    <option value="">All Platforms</option>
                    <option value="UNIVERSAL">Universal</option>
                    <option value="IOS">iOS</option>
                    <option value="MAC_OS">macOS</option>
                </select>
            </div>
            @if (HasActiveFilters)
            {
                <button class="clear-filters-btn" @onclick="ClearFilters">Clear Filters</button>
            }
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-bar">@errorMessage</div>
        }

        <div class="results-info">
            Showing @FilteredBundleIds.Count() of @bundleIds.Count bundle IDs
        </div>

        <div class="bundle-list">
        
        @if (bundleIds.Count == 0 && isRefreshing)
        {
            <div class="loading-state">
                <div class="loading-spinner">
                    <i class="fas fa-fingerprint"></i>
                </div>
                <div class="loading-title">Loading Bundle IDs</div>
                <div class="loading-description">Fetching bundle identifiers from App Store Connect...</div>
            </div>
        }
        else if (!FilteredBundleIds.Any())
        {
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-cube"></i></div>
                <div class="empty-title">@(bundleIds.Count == 0 ? "No Bundle IDs found" : "No bundle IDs match filters")</div>
                <div class="empty-description">@(bundleIds.Count == 0 ? "Register a new bundle ID to get started" : "Try adjusting your search or filters")</div>
            </div>
        }
        else
        {
            @foreach (var bundle in FilteredBundleIds)
            {
                var capabilities = GetCapabilities(bundle.Id);
                <div class="bundle-card">
                    <div class="bundle-details">
                        <div class="bundle-identifier">
                            @bundle.Identifier
                            <button class="btn-copy" @onclick="@(() => CopyToClipboard(bundle.Identifier))" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="bundle-name">@bundle.Name</div>
                        <div class="bundle-badges">
                            <span class="badge badge-platform">@FormatPlatform(bundle.Platform)</span>
                            @if (!string.IsNullOrEmpty(bundle.SeedId))
                            {
                                <span class="badge badge-seed">@bundle.SeedId</span>
                            }
                        </div>
                        @if (capabilities.Any())
                        {
                            <div class="bundle-capabilities">
                                @foreach (var cap in capabilities.Take(5))
                                {
                                    <span class="capability-badge" title="@CapabilityCategories.GetDisplayName(cap.CapabilityType)">
                                        <i class="fas @CapabilityCategories.GetIcon(cap.CapabilityType)"></i>
                                    </span>
                                }
                                @if (capabilities.Count > 5)
                                {
                                    <span class="capability-more">+@(capabilities.Count - 5)</span>
                                }
                            </div>
                        }
                    </div>
                    <div class="bundle-actions">
                        <button class="btn btn-secondary btn-icon" @onclick="@(() => ShowEditCapabilitiesDialog(bundle))" disabled="@isRefreshing" title="Capabilities">
                            <i class="fas fa-puzzle-piece"></i>
                        </button>
                        <button class="btn btn-danger btn-icon" @onclick="@(() => DeleteBundle(bundle))" disabled="@isRefreshing" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
        }
    </div>
}

@if (showCreateDialog)
{
    <div class="modal-overlay">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Register Bundle ID</h2>
                <button class="close-btn" @onclick="CloseCreateDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Bundle Identifier</label>
                    <input type="text" @bind="newIdentifier" placeholder="com.example.myapp" />
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" @bind="newName" placeholder="My App" />
                </div>
                <div class="form-group">
                    <label>Platform</label>
                    <select @bind="newPlatform">
                        <option value="UNIVERSAL">Universal</option>
                        <option value="IOS">iOS</option>
                        <option value="MACOS">macOS</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateDialog">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="CreateBundle" 
                        disabled="@(string.IsNullOrWhiteSpace(newIdentifier) || string.IsNullOrWhiteSpace(newName) || isCreating)">
                    <i class="fas @(isCreating ? "fa-spinner fa-spin" : "fa-plus")"></i> @(isCreating ? "Creating..." : "Create")
                </button>
            </div>
        </div>
    </div>
}

@if (showCapabilitiesDialog && selectedBundleForCapabilities != null)
{
    <div class="modal-overlay">
        <div class="modal modal-lg" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2><i class="fas fa-puzzle-piece"></i> Capabilities</h2>
                <button class="close-btn" @onclick="CloseCapabilitiesDialog">×</button>
            </div>
            <div class="modal-subheader">
                <span class="bundle-id-label">@selectedBundleForCapabilities.Identifier</span>
            </div>
            <div class="modal-body capabilities-body">
                @if (isLoadingCapabilities)
                {
                    <div class="loading-capabilities">
                        <i class="fas fa-spinner fa-spin"></i> Loading capabilities...
                    </div>
                }
                else
                {
                    @foreach (var category in GetGroupedCapabilities())
                    {
                        <div class="capability-category">
                            <h3 class="category-title">@category.Key</h3>
                            <div class="capability-list">
                                @foreach (var capType in category.Value)
                                {
                                    var isEnabled = IsCapabilityEnabled(capType);
                                    var capId = GetCapabilityId(capType);
                                    <div class="capability-item @(isEnabled ? "enabled" : "")">
                                        <div class="capability-info">
                                            <i class="fas @CapabilityCategories.GetIcon(capType)"></i>
                                            <span class="capability-name">@CapabilityCategories.GetDisplayName(capType)</span>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" 
                                                   checked="@isEnabled" 
                                                   disabled="@isTogglingCapability"
                                                   @onchange="@(e => ToggleCapability(capType, capId, (bool)(e.Value ?? false)))" />
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCapabilitiesDialog">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
}

<style>
    h1 { margin-bottom: 20px; font-size: 28px; color: var(--text-primary); }

    .toolbar { margin-bottom: 16px; display: flex; gap: 12px; }
    .error-bar { background: var(--status-error-bg); color: var(--status-error-text); padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; }

    /* Filter Section Styles */
    .filter-section {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }

    .search-box {
        position: relative;
        flex: 1;
        min-width: 200px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 36px 10px 36px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        opacity: 0.5;
    }

    .clear-btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--border-color);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .clear-btn:hover { background: var(--bg-hover); }

    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; }

    .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        background: var(--card-bg);
        cursor: pointer;
        min-width: 120px;
    }

    .filter-select:focus { outline: none; border-color: var(--accent-primary); }

    .clear-filters-btn {
        padding: 8px 12px;
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        color: var(--text-muted);
        cursor: pointer;
    }

    .clear-filters-btn:hover { background: var(--bg-tertiary); color: var(--text-secondary); }

    .results-info { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }

    .btn { 
        padding: 10px 20px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        cursor: pointer; 
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .btn i { font-size: 12px; }
    .btn-icon {
        width: 32px; height: 32px; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 6px; font-size: 13px;
    }
    .btn-icon i { font-size: 13px; margin: 0; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-success { background-color: var(--accent-success); color: white; }
    .btn-success:hover:not(:disabled) { background-color: var(--accent-success-hover); }
    .btn-danger { background-color: #f56565; color: white; }
    .btn-danger:hover:not(:disabled) { background-color: var(--accent-danger); }
    .btn-secondary { background-color: #a0aec0; color: white; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .bundle-list { display: flex; flex-direction: column; gap: 12px; }

    .bundle-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--card-shadow);
    }

    .bundle-identifier { 
        font-weight: 600; 
        font-size: 16px; 
        color: var(--text-primary); 
        font-family: monospace;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .bundle-name { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
    .bundle-badges { display: flex; gap: 8px; margin-top: 8px; }

    .btn-copy {
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-hover);
    }

    .badge { padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-platform { background: #bee3f8; color: #2c5282; }
    .badge-seed { background: var(--bg-hover); color: var(--text-secondary); }

    .empty-state { background: var(--card-bg); border-radius: 8px; padding: 60px 40px; text-align: center; box-shadow: var(--card-shadow); }
    .empty-icon { font-size: 48px; margin-bottom: 16px; color: #a0aec0; }
    .empty-icon i { font-size: 48px; }
    .empty-title { font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
    .empty-description { color: var(--text-muted); font-size: 14px; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
    .modal-header h2 { margin: 0; font-size: 18px; color: var(--text-primary); }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
    .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }

    /* Capability badges in bundle cards */
    .bundle-capabilities {
        display: flex;
        gap: 6px;
        margin-top: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    .capability-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: #f0f4ff;
        border-radius: 6px;
        color: #5a67d8;
        font-size: 12px;
    }
    .capability-more {
        font-size: 12px;
        color: var(--text-muted);
        padding: 4px 8px;
        background: var(--bg-hover);
        border-radius: 4px;
    }

    /* Capabilities Modal */
    .modal-lg { max-width: 700px; }
    .modal-subheader {
        padding: 12px 24px;
        background: var(--bg-hover);
        border-bottom: 1px solid var(--border-color);
    }
    .bundle-id-label {
        font-family: monospace;
        font-size: 14px;
        color: var(--text-secondary);
    }
    .capabilities-body {
        max-height: 60vh;
        overflow-y: auto;
    }
    .loading-capabilities {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }
    .capability-category {
        margin-bottom: 24px;
    }
    .category-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin: 0 0 12px 0;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    .capability-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .capability-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-hover);
        border-radius: 8px;
        border: 1px solid transparent;
        transition: all 0.15s;
    }
    .capability-item.enabled {
        background: rgba(72, 187, 120, 0.15);
        border-color: #38a169;
    }
    .capability-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .capability-info i {
        font-size: 16px;
        width: 20px;
        text-align: center;
        color: #718096;
    }
    .capability-item.enabled .capability-info i {
        color: #38a169;
    }
    .capability-name {
        font-size: 14px;
        color: var(--text-primary);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #cbd5e0;
        transition: 0.2s;
        border-radius: 24px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.2s;
        border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
        background-color: #48bb78;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    .toggle-switch input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

@code {
    private List<AppleBundleId> bundleIds = new();
    private bool isRefreshing = false;
    private bool isBackgroundRefreshing = false;
    private string errorMessage = "";

    // Filter state
    private string searchQuery = "";
    private string filterPlatform = "";

    private bool showCreateDialog = false;
    private bool isCreating = false;
    private string newIdentifier = "";
    private string newName = "";
    private string newPlatform = "UNIVERSAL";

    // Capabilities state
    private bool showCapabilitiesDialog = false;
    private AppleBundleId? selectedBundleForCapabilities = null;
    private List<AppleBundleIdCapability> currentCapabilities = new();
    private List<string> availableCapabilityTypes = new();
    private bool isLoadingCapabilities = false;
    private bool isTogglingCapability = false;
    
    // Capabilities cache per bundle ID
    private Dictionary<string, List<AppleBundleIdCapability>> capabilitiesCache = new();

    private bool HasActiveFilters => !string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(filterPlatform);

    private IEnumerable<AppleBundleId> FilteredBundleIds => bundleIds
        .Where(b => string.IsNullOrEmpty(searchQuery) || 
                    b.Identifier.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    b.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(b => string.IsNullOrEmpty(filterPlatform) || (b.Platform?.Equals(filterPlatform, StringComparison.OrdinalIgnoreCase) ?? false))
        .OrderBy(b => b.Identifier);

    private void ClearFilters()
    {
        searchQuery = "";
        filterPlatform = "";
    }

    protected override async Task OnInitializedAsync()
    {
        IdentityState.OnSelectionChanged += OnIdentityChanged;
        if (IdentityState.SelectedIdentity != null)
            await RefreshData(forceRefresh: false); // Use cache on initial load
    }

    private void OnIdentityChanged()
    {
        InvokeAsync(async () =>
        {
            await RefreshData(forceRefresh: false); // Use cache when identity changes (different identity = different cache key)
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        IdentityState.OnSelectionChanged -= OnIdentityChanged;
    }

    private async Task RefreshData(bool forceRefresh = false)
    {
        if (IdentityState.SelectedIdentity == null) return;

        // Set loading states
        isRefreshing = true;
        if (!forceRefresh && bundleIds.Count > 0)
        {
            // Only show background indicator if we already have data
            isBackgroundRefreshing = true;
        }
        
        // Show toast for force refresh
        ToastMessage? toast = null;
        if (forceRefresh)
        {
            toast = ToastService.Show("Refreshing bundle IDs...", ToastType.Info);
        }
        
        errorMessage = "";
        StateHasChanged();
        
        try
        {
            // If force refresh, invalidate the cache first
            if (forceRefresh)
            {
                await Mediator.FlushStores($"apple:bundleids:{IdentityState.SelectedIdentity.Id}");
            }
            
            var request = new GetBundleIdsRequest(IdentityState.SelectedIdentity.Id);
            var (_, result) = await Mediator.Request(request);
            bundleIds = result.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load bundle IDs: {ex.Message}";
        }
        finally
        {
            isRefreshing = false;
            isBackgroundRefreshing = false;
            if (toast != null) ToastService.Dismiss(toast);
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ShowCreateDialog()
    {
        newIdentifier = "";
        newName = "";
        newPlatform = "UNIVERSAL";
        showCreateDialog = true;
    }

    private void CloseCreateDialog() => showCreateDialog = false;

    private async Task CreateBundle()
    {
        showCreateDialog = false;
        
        var result = await OperationModal.RunAsync(
            "Create Bundle ID",
            $"Creating bundle ID '{newIdentifier}'...",
            async ctx =>
            {
                ctx.SetStatus("Registering bundle ID...");
                ctx.LogInfo($"Identifier: {newIdentifier}");
                ctx.LogInfo($"Name: {newName}");
                ctx.LogInfo($"Platform: {newPlatform}");
                
                await AppleService.CreateBundleIdAsync(newIdentifier, newName, newPlatform);
                ctx.LogSuccess("Bundle ID created successfully");
                return true;
            },
            canCancel: false);

        if (result.Success)
        {
            CloseCreateDialog();
            await RefreshData(forceRefresh: true);
        }
    }

    private async Task DeleteBundle(AppleBundleId bundle)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Delete Bundle ID",
            $"Are you sure you want to delete '{bundle.Identifier}'?");

        if (!confirm) return;

        var result = await OperationModal.RunAsync(
            "Delete Bundle ID",
            $"Deleting '{bundle.Identifier}'...",
            async ctx =>
            {
                ctx.SetStatus("Deleting bundle ID...");
                ctx.LogInfo($"Identifier: {bundle.Identifier}");
                
                await AppleService.DeleteBundleIdAsync(bundle.Id);
                ctx.LogSuccess("Bundle ID deleted");
                return true;
            },
            canCancel: false);

        if (result.Success)
        {
            // Immediately remove from list for responsive UI
            bundleIds.Remove(bundle);
            StateHasChanged();
            
            await RefreshData(forceRefresh: true);
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }

    // Capability-related methods
    private List<AppleBundleIdCapability> GetCapabilities(string bundleId)
    {
        return capabilitiesCache.TryGetValue(bundleId, out var caps) ? caps : new();
    }

    private async Task ShowEditCapabilitiesDialog(AppleBundleId bundle)
    {
        selectedBundleForCapabilities = bundle;
        showCapabilitiesDialog = true;
        isLoadingCapabilities = true;
        currentCapabilities.Clear();
        StateHasChanged();

        try
        {
            // Load available capability types if not already loaded
            if (!availableCapabilityTypes.Any())
            {
                availableCapabilityTypes = (await AppleService.GetAvailableCapabilityTypesAsync()).ToList();
            }

            // Load current capabilities for this bundle
            var caps = await AppleService.GetBundleIdCapabilitiesAsync(bundle.Id);
            currentCapabilities = caps.ToList();
            capabilitiesCache[bundle.Id] = currentCapabilities;
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to load capabilities: {ex.Message}");
        }
        finally
        {
            isLoadingCapabilities = false;
            StateHasChanged();
        }
    }

    private void CloseCapabilitiesDialog()
    {
        showCapabilitiesDialog = false;
        selectedBundleForCapabilities = null;
        currentCapabilities.Clear();
    }

    private IEnumerable<KeyValuePair<string, List<string>>> GetGroupedCapabilities()
    {
        var grouped = availableCapabilityTypes
            .GroupBy(cap => CapabilityCategories.GetCategory(cap))
            .OrderBy(g => g.Key == "Other" ? 1 : 0)
            .ThenBy(g => g.Key)
            .Select(g => new KeyValuePair<string, List<string>>(g.Key, g.ToList()));
        return grouped;
    }

    private bool IsCapabilityEnabled(string capabilityType)
    {
        return currentCapabilities.Any(c => c.CapabilityType == capabilityType);
    }

    private string? GetCapabilityId(string capabilityType)
    {
        return currentCapabilities.FirstOrDefault(c => c.CapabilityType == capabilityType)?.Id;
    }

    private async Task ToggleCapability(string capabilityType, string? capabilityId, bool enable)
    {
        if (selectedBundleForCapabilities == null) return;

        isTogglingCapability = true;
        StateHasChanged();

        try
        {
            if (enable && capabilityId == null)
            {
                // Enable capability
                await AppleService.EnableCapabilityAsync(selectedBundleForCapabilities.Id, capabilityType);
                await AlertService.ShowToastAsync($"Enabled {CapabilityCategories.GetDisplayName(capabilityType)}");
            }
            else if (!enable && capabilityId != null)
            {
                // Disable capability
                await AppleService.DisableCapabilityAsync(capabilityId);
                await AlertService.ShowToastAsync($"Disabled {CapabilityCategories.GetDisplayName(capabilityType)}");
            }

            // Refresh capabilities
            var caps = await AppleService.GetBundleIdCapabilitiesAsync(selectedBundleForCapabilities.Id);
            currentCapabilities = caps.ToList();
            capabilitiesCache[selectedBundleForCapabilities.Id] = currentCapabilities;
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to toggle capability: {ex.Message}");
        }
        finally
        {
            isTogglingCapability = false;
            StateHasChanged();
        }
    }

    private static string FormatPlatform(string? platform)
    {
        if (string.IsNullOrEmpty(platform)) return "Universal";
        return platform.ToUpperInvariant() switch
        {
            "IOS" => "iOS",
            "MAC_OS" or "MACOS" => "macOS",
            "UNIVERSAL" => "Universal",
            _ => platform
        };
    }
}
