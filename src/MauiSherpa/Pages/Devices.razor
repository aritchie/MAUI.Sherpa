@page "/devices"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Android
@using MauiSherpa.Services
@using Shiny.Mediator
@inject IMediator Mediator
@inject IAndroidSdkService SdkService
@inject IAndroidSdkSettingsService SdkSettings
@inject IAdbDeviceWatcherService DeviceWatcher
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject IFileSystemService FileSystem
@inject DeviceInspectorService DeviceInspector
@inject BlazorToastService ToastService
@inject IEncryptedSettingsService SettingsService
@implements IDisposable

<h1><i class="fas fa-mobile-alt"></i> Android Devices</h1>

<div class="sdk-path-bar">
    <i class="fas fa-folder"></i>
    @if (!string.IsNullOrEmpty(SdkService.SdkPath))
    {
        <span class="sdk-path-text">@SdkService.SdkPath</span>
        <button class="btn-copy" @onclick="@(() => CopyToClipboard(SdkService.SdkPath!))" title="Copy to clipboard">
            <i class="fas fa-copy"></i>
        </button>
        <button class="btn-reveal" @onclick="@(() => FileSystem.RevealInFileManager(SdkService.SdkPath!))" title="Reveal in Finder">
            <i class="fas fa-external-link-alt"></i>
        </button>
    }
    else if (isLoading)
    {
        <span class="sdk-path-text detecting"><i class="fas fa-spinner fa-spin"></i> Detecting SDK...</span>
    }
    else
    {
        <span class="sdk-path-text no-sdk">No SDK detected</span>
    }
    <a class="btn-link-settings" href="settings" title="Change SDK path in Settings">
        <i class="fas fa-cog"></i>
    </a>
</div>

<div class="toolbar">
    <button class="btn btn-primary" @onclick="() => RefreshDevices(forceRefresh: true)" disabled="@isLoading">
        <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
    </button>
</div>

<div class="device-list">
    @if (isLoading && devices.Count == 0)
    {
        <div class="loading-state">
            <div class="loading-spinner">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="loading-title">Scanning for Devices</div>
            <div class="loading-description">Looking for connected Android devices...</div>
        </div>
    }
    else if (devices.Count == 0)
    {
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="empty-title">No devices connected</div>
            <div class="empty-description">Connect an Android device via USB or start an emulator</div>
        </div>
    }
    else
    {
        @foreach (var device in devices)
        {
            <div class="device-card">
                <div class="device-icon"><i class="fas @(device.IsEmulator ? "fa-mobile-alt" : "fa-mobile")"></i></div>
                <div class="device-details">
                    <div class="device-name">@(device.Model ?? "Unknown Device")</div>
                    <div class="device-serial">
                        <span class="@(demoMode ? "demo-blur" : "")">@device.Serial</span>
                        <button class="btn-copy" @onclick="@(() => CopyToClipboard(device.Serial))" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="device-badges">
                        <span class="badge @(device.State == "device" ? "badge-success" : "badge-warning")">
                            @device.State
                        </span>
                        @if (device.IsEmulator)
                        {
                            <span class="badge badge-info">Emulator</span>
                        }
                    </div>
                </div>
                <div class="device-actions">
                    <button class="btn btn-info btn-icon" @onclick="@(() => DeviceInspector.Open(device.Serial, device.Model ?? device.Serial))" title="Logcat">
                        <i class="fas fa-scroll"></i>
                    </button>
                    <button class="btn btn-secondary btn-icon" @onclick="@(() => DeviceInspector.Open(device.Serial, device.Model ?? device.Serial, InspectorTab.Files))" title="Inspect">
                        <i class="fas fa-search"></i>
                    </button>
                    @if (device.IsEmulator)
                    {
                        <button class="btn btn-danger btn-icon" @onclick="@(() => StopEmulator(device.Serial))" disabled="@isLoading" title="Stop">
                            <i class="fas fa-stop"></i>
                        </button>
                    }
                </div>
            </div>
        }
    }
</div>

<style>
    h1 {
        margin-bottom: 20px;
        font-size: 1.75rem;
        color: var(--text-primary);
    }

    .sdk-path-bar {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg-tertiary);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        font-family: 'Consolas', 'Monaco', monospace;
    }
    .sdk-path-bar i.fa-folder { color: var(--accent-primary); }
    .sdk-path-text {
        flex: 1;
        color: var(--text-primary);
        font-size: 0.875rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .sdk-path-text.detecting { color: var(--text-muted); font-style: italic; }
    .sdk-path-text.no-sdk { color: #a0aec0; font-style: italic; }

    .btn-link-settings {
        color: var(--text-secondary);
        padding: 4px 8px;
        font-size: 0.875rem;
        text-decoration: none;
        transition: color 0.15s;
    }
    .btn-link-settings:hover {
        color: var(--accent-primary);
    }

    .btn-reveal, .btn-copy {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 2px 6px;
        font-size: 0.75rem;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-reveal:hover, .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .toolbar {
        margin-bottom: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .btn i { font-size: 0.75rem; }

    .device-actions { display: flex; align-items: center; gap: 4px; }

    .btn-icon {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 0.8125rem;
    }
    .btn-icon i { font-size: 0.8125rem; margin: 0; }

    .btn-primary {
        background-color: var(--accent-primary);
        color: var(--card-bg);
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #3182ce;
    }

    .btn-danger {
        background-color: #f56565;
        color: white;
    }

    .btn-info {
        background-color: var(--accent-primary);
        color: white;
    }

    .btn-info:hover:not(:disabled) {
        background-color: #3182ce;
    }

    .btn-danger:hover:not(:disabled) {
        background-color: #e53e3e;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.75rem;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .device-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .device-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: var(--card-shadow);
    }

    .device-icon {
        font-size: 2.25rem;
        color: var(--accent-primary);
    }

    .device-icon i { font-size: 2rem; }

    .device-details {
        flex: 1;
    }

    .device-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .device-serial {
        font-family: monospace;
        font-size: 0.8125rem;
        color: var(--text-muted);
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-copy {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 2px 6px;
        font-size: 0.75rem;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .device-badges {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .badge {
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-success {
        background: var(--status-success-bg);
        color: var(--status-success-text);
    }

    .badge-warning {
        background: #feebc8;
        color: #c05621;
    }

    .badge-info {
        background: #bee3f8;
        color: #2c5282;
    }

    .empty-state {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 60px 40px;
        text-align: center;
        box-shadow: var(--card-shadow);
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--text-secondary);
    }

    .empty-icon i { font-size: 48px; }

    .empty-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .empty-description {
        color: var(--text-muted);
        font-size: 0.875rem;
    }
</style>

@code {
    private List<DeviceInfo> devices = new();
    private bool isLoading = false;
    private bool demoMode = false;

    protected override async Task OnInitializedAsync()
    {
        try { var settings = await SettingsService.GetSettingsAsync(); demoMode = settings.Preferences.DemoMode; } catch { }
        // Subscribe to SDK path changes from Settings
        SdkService.SdkPathChanged += OnSdkPathChanged;
        DeviceWatcher.DevicesChanged += OnDevicesChanged;
        
        // Initialize SDK settings (loads stored custom path if any)
        await SdkSettings.InitializeAsync();

        // Use watcher's cached devices if available, otherwise fetch
        var cached = DeviceWatcher.Devices;
        if (cached.Count > 0)
        {
            devices = cached.ToList();
        }
        else
        {
            await RefreshDevices();
        }
    }

    private void OnDevicesChanged(IReadOnlyList<DeviceInfo> newDevices)
    {
        InvokeAsync(() =>
        {
            devices = newDevices.ToList();
            StateHasChanged();
        });
    }

    private void OnSdkPathChanged()
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await RefreshDevices();
        });
    }

    private async Task RefreshDevices(bool forceRefresh = false)
    {
        isLoading = true;
        
        ToastMessage? toast = null;
        if (forceRefresh)
        {
            toast = ToastService.Show("Refreshing devices...", ToastType.Info);
        }
        
        try
        {
            // If force refresh, invalidate the cache first
            if (forceRefresh)
            {
                await Mediator.FlushStores("android:devices");
            }
            
            var (_, result) = await Mediator.Request(new GetAndroidDevicesRequest());
            devices = result?.ToList() ?? new();
        }
        finally
        {
            isLoading = false;
            if (toast != null) ToastService.Dismiss(toast);
        }
    }

    private async Task StopEmulator(string serial)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Stop Emulator",
            $"Are you sure you want to stop this emulator?");

        if (!confirm) return;

        isLoading = true;
        try
        {
            await SdkService.StopEmulatorAsync(serial);
            await Task.Delay(1000);
            await RefreshDevices(forceRefresh: true);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }

    public void Dispose()
    {
        SdkService.SdkPathChanged -= OnSdkPathChanged;
        DeviceWatcher.DevicesChanged -= OnDevicesChanged;
    }
}
