@page "/secrets"
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Services
@inject IManagedSecretsService SecretsService
@inject ICloudSecretsService CloudSecretsService
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject OperationModalService OperationModal
@inject BlazorToastService ToastService
@inject ILoggingService Logger
@inject IJSRuntime JS

<h1><i class="fas fa-vault"></i> Secrets</h1>

@if (CloudSecretsService.ActiveProvider is null)
{
    <div class="empty-state">
        <div class="empty-icon"><i class="fas fa-cloud-slash"></i></div>
        <div class="empty-title">No Cloud Provider Configured</div>
        <div class="empty-description">Configure a cloud secrets provider in <a href="settings">Settings</a> to manage secrets.</div>
    </div>
}
else
{
    <div class="provider-info">
        <i class="fas fa-cloud"></i>
        <span>@CloudSecretsService.ActiveProvider.Name</span>
        <span class="provider-type">(@FormatProviderType(CloudSecretsService.ActiveProvider.ProviderType))</span>
    </div>

    <div class="toolbar">
        <button class="btn btn-primary" @onclick="RefreshAsync" disabled="@isLoading">
            <i class="fas @(isLoading ? "fa-spinner fa-spin" : "fa-sync-alt")"></i> Refresh
        </button>
        <button class="btn btn-success" @onclick="ShowCreateModal" disabled="@isLoading">
            <i class="fas fa-plus"></i> Create Secret
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-bar">@errorMessage</div>
    }

    <div class="filter-section">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Search secrets..." @bind="searchText" @bind:event="oninput" />
            @if (!string.IsNullOrEmpty(searchText))
            {
                <button class="clear-btn" @onclick="@(() => searchText = "")"><i class="fas fa-times"></i></button>
            }
        </div>
        <select class="filter-select" @bind="filterType">
            <option value="">All Types</option>
            <option value="String">String</option>
            <option value="File">File</option>
        </select>
    </div>

    <div class="results-info">
        Showing @FilteredSecrets.Count() of @secrets.Count secrets
    </div>

    <div class="secret-list">
        @if (isLoading && secrets.Count == 0)
        {
            <div class="loading-state">
                <div class="loading-spinner"><i class="fas fa-key"></i></div>
                <div class="loading-title">Loading Secrets</div>
                <div class="loading-description">Fetching managed secrets from cloud provider...</div>
            </div>
        }
        else if (!FilteredSecrets.Any())
        {
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-key"></i></div>
                <div class="empty-title">@(secrets.Count == 0 ? "No secrets found" : "No secrets match filters")</div>
                <div class="empty-description">@(secrets.Count == 0 ? "Click \"Create Secret\" to store a new secret" : "Try adjusting your search or filters")</div>
            </div>
        }
        else
        {
            @foreach (var secret in FilteredSecrets)
            {
                <div class="secret-card">
                    <div class="secret-icon">
                        <i class="fas @(secret.Type == ManagedSecretType.File ? "fa-file-shield" : "fa-key")"></i>
                    </div>
                    <div class="secret-details">
                        <div class="secret-name">@secret.Key</div>
                        @if (!string.IsNullOrEmpty(secret.Description))
                        {
                            <div class="secret-description">@secret.Description</div>
                        }
                        <div class="secret-badges">
                            <span class="badge @(secret.Type == ManagedSecretType.File ? "badge-file" : "badge-string")">
                                @(secret.Type == ManagedSecretType.File ? "File" : "String")
                            </span>
                            @if (secret.Type == ManagedSecretType.File && !string.IsNullOrEmpty(secret.OriginalFileName))
                            {
                                <span class="badge badge-filename">@secret.OriginalFileName</span>
                            }
                        </div>
                        <div class="secret-meta">
                            Created: @secret.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                            @if (secret.UpdatedAt != secret.CreatedAt)
                            {
                                <span> Â· Updated: @secret.UpdatedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            }
                        </div>
                    </div>
                    <div class="secret-actions">
                        @if (secret.Type == ManagedSecretType.String)
                        {
                            @if (revealedSecrets.Contains(secret.Key))
                            {
                                <button class="btn btn-secondary btn-icon" @onclick="@(() => HideSecretValue(secret.Key))" title="Hide value">
                                    <i class="fas fa-eye-slash"></i>
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-secondary btn-icon" @onclick="@(() => RevealSecretValue(secret.Key))" title="Show value">
                                    <i class="fas fa-eye"></i>
                                </button>
                            }
                        }
                        else
                        {
                            <button class="btn btn-secondary btn-icon" @onclick="@(() => DownloadFile(secret))" title="Download file">
                                <i class="fas fa-download"></i>
                            </button>
                        }
                        <button class="btn btn-secondary btn-icon" @onclick="@(() => ShowEditModal(secret))" disabled="@isLoading" title="Edit">
                            <i class="fas fa-pen"></i>
                        </button>
                        <button class="btn btn-danger btn-icon" @onclick="@(() => DeleteSecret(secret))" disabled="@isLoading" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                @if (revealedSecrets.Contains(secret.Key))
                {
                    <div class="secret-value-reveal">
                        <pre class="secret-value-text">@(revealedValues.GetValueOrDefault(secret.Key, "Loading..."))</pre>
                        <button class="btn-copy" @onclick="@(() => CopyToClipboard(revealedValues.GetValueOrDefault(secret.Key, "")))" title="Copy to clipboard">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                }
            }
        }
    </div>
}

@* Create/Edit Modal *@
@if (showModal)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(isEditing ? "Edit Secret" : "Create Secret")</h2>
                <button class="close-btn" @onclick="CloseModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Key <span class="required">*</span></label>
                    <input type="text" class="form-control" @bind="modalKey" @bind:event="oninput"
                           placeholder="e.g., api-key, database-password" disabled="@isEditing" />
                    @if (isEditing)
                    {
                        <div class="form-hint">Key cannot be changed after creation</div>
                    }
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" class="form-control" @bind="modalDescription" @bind:event="oninput"
                           placeholder="Optional description" />
                </div>
                @if (!isEditing)
                {
                    <div class="form-group">
                        <label>Type</label>
                        <div class="type-selector">
                            <button class="type-btn @(modalType == ManagedSecretType.String ? "active" : "")"
                                    @onclick="@(() => modalType = ManagedSecretType.String)">
                                <i class="fas fa-key"></i> String
                            </button>
                            <button class="type-btn @(modalType == ManagedSecretType.File ? "active" : "")"
                                    @onclick="@(() => modalType = ManagedSecretType.File)">
                                <i class="fas fa-file-shield"></i> File
                            </button>
                        </div>
                    </div>
                }
                <div class="form-group">
                    <label>Value @(!isEditing ? "" : "(leave empty to keep current)") <span class="@(isEditing ? "" : "required")">@(!isEditing ? "*" : "")</span></label>
                    @if (modalType == ManagedSecretType.String)
                    {
                        <textarea class="form-control textarea" @bind="modalValue" @bind:event="oninput"
                                  placeholder="Enter secret value..." rows="4"></textarea>
                    }
                    else
                    {
                        <div class="file-picker">
                            @if (!string.IsNullOrEmpty(modalFileName))
                            {
                                <div class="file-selected">
                                    <i class="fas fa-file"></i>
                                    <span>@modalFileName</span>
                                    <button class="btn-clear-file" @onclick="ClearFile"><i class="fas fa-times"></i></button>
                                </div>
                            }
                            else
                            {
                                <button class="btn btn-secondary" @onclick="PickFile">
                                    <i class="fas fa-folder-open"></i> Choose File
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveSecret" disabled="@(!CanSave)">
                    <i class="fas fa-save"></i> @(isEditing ? "Update" : "Create")
                </button>
            </div>
        </div>
    </div>
}

@code {
    List<ManagedSecret> secrets = new();
    bool isLoading = false;
    string errorMessage = "";
    string searchText = "";
    string filterType = "";

    // Modal state
    bool showModal = false;
    bool isEditing = false;
    string modalKey = "";
    string modalDescription = "";
    string modalValue = "";
    ManagedSecretType modalType = ManagedSecretType.String;
    string modalFileName = "";
    byte[]? modalFileBytes = null;

    // Reveal state
    HashSet<string> revealedSecrets = new();
    Dictionary<string, string> revealedValues = new();

    IEnumerable<ManagedSecret> FilteredSecrets => secrets.Where(s =>
    {
        if (!string.IsNullOrEmpty(searchText))
        {
            var search = searchText.ToLowerInvariant();
            if (!(s.Key.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                  (s.Description?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false)))
                return false;
        }
        if (!string.IsNullOrEmpty(filterType) && Enum.TryParse<ManagedSecretType>(filterType, out var ft))
        {
            if (s.Type != ft)
                return false;
        }
        return true;
    });

    bool CanSave => !string.IsNullOrWhiteSpace(modalKey) &&
        (isEditing || modalType == ManagedSecretType.String ? !string.IsNullOrEmpty(modalValue) || isEditing : modalFileBytes != null);

    protected override async Task OnInitializedAsync()
    {
        await CloudSecretsService.InitializeAsync();
        await RefreshAsync();
    }

    async Task RefreshAsync()
    {
        if (CloudSecretsService.ActiveProvider is null) return;

        isLoading = true;
        errorMessage = "";
        StateHasChanged();

        try
        {
            var result = await SecretsService.ListAsync();
            secrets = result.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load secrets: {ex.Message}";
            Logger.LogError($"Failed to load secrets: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    void ShowCreateModal()
    {
        isEditing = false;
        modalKey = "";
        modalDescription = "";
        modalValue = "";
        modalType = ManagedSecretType.String;
        modalFileName = "";
        modalFileBytes = null;
        showModal = true;
    }

    void ShowEditModal(ManagedSecret secret)
    {
        isEditing = true;
        modalKey = secret.Key;
        modalDescription = secret.Description ?? "";
        modalValue = "";
        modalType = secret.Type;
        modalFileName = secret.OriginalFileName ?? "";
        modalFileBytes = null;
        showModal = true;
    }

    void CloseModal()
    {
        showModal = false;
    }

    async Task SaveSecret()
    {
        await OperationModal.RunAsync(
            isEditing ? "Updating Secret" : "Creating Secret",
            $"{(isEditing ? "Updating" : "Storing")} secret '{modalKey}' in cloud provider...",
            async ctx =>
            {
                if (isEditing)
                {
                    byte[]? value = null;
                    if (modalType == ManagedSecretType.String && !string.IsNullOrEmpty(modalValue))
                        value = System.Text.Encoding.UTF8.GetBytes(modalValue);
                    else if (modalType == ManagedSecretType.File && modalFileBytes != null)
                        value = modalFileBytes;

                    return await SecretsService.UpdateAsync(modalKey, value, modalDescription);
                }
                else
                {
                    byte[] value;
                    if (modalType == ManagedSecretType.String)
                        value = System.Text.Encoding.UTF8.GetBytes(modalValue);
                    else
                        value = modalFileBytes ?? throw new InvalidOperationException("No file selected");

                    return await SecretsService.CreateAsync(modalKey, value, modalType, modalDescription,
                        modalType == ManagedSecretType.File ? modalFileName : null);
                }
            });

        showModal = false;
        await RefreshAsync();
    }

    async Task DeleteSecret(ManagedSecret secret)
    {
        var confirmed = await AlertService.ShowConfirmAsync(
            "Delete Secret",
            $"Are you sure you want to delete '{secret.Key}'? This action cannot be undone.");

        if (!confirmed) return;

        await OperationModal.RunAsync(
            "Deleting Secret",
            $"Removing secret '{secret.Key}' from cloud provider...",
            async ctx =>
            {
                return await SecretsService.DeleteAsync(secret.Key);
            });

        revealedSecrets.Remove(secret.Key);
        revealedValues.Remove(secret.Key);
        await RefreshAsync();
    }

    async Task RevealSecretValue(string key)
    {
        revealedSecrets.Add(key);
        StateHasChanged();

        try
        {
            var bytes = await SecretsService.GetValueAsync(key);
            if (bytes != null)
                revealedValues[key] = System.Text.Encoding.UTF8.GetString(bytes);
            else
                revealedValues[key] = "(empty)";
        }
        catch (Exception ex)
        {
            revealedValues[key] = $"(error: {ex.Message})";
        }
        StateHasChanged();
    }

    void HideSecretValue(string key)
    {
        revealedSecrets.Remove(key);
        revealedValues.Remove(key);
    }

    async Task DownloadFile(ManagedSecret secret)
    {
        try
        {
            var bytes = await SecretsService.GetValueAsync(secret.Key);
            if (bytes is null)
            {
                ToastService.ShowError("Secret value not found");
                return;
            }

            var fileName = secret.OriginalFileName ?? $"{secret.Key}.bin";
            var extension = System.IO.Path.GetExtension(fileName);
            if (string.IsNullOrEmpty(extension)) extension = ".bin";
            var path = await DialogService.PickSaveFileAsync("Save Secret File", fileName, extension);
            if (string.IsNullOrEmpty(path)) return;

            // PickSaveFileAsync creates an empty file; delete it so we can write
            if (System.IO.File.Exists(path))
                System.IO.File.Delete(path);

            await System.IO.File.WriteAllBytesAsync(path, bytes);
            ToastService.ShowSuccess($"File saved to {System.IO.Path.GetFileName(path)}");
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to download secret file: {ex}");
            ToastService.ShowError($"Download failed: {ex.Message}");
        }
    }

    async Task PickFile()
    {
        try
        {
            var result = await DialogService.PickOpenFileAsync("Select file to store as secret");
            if (result is null) return;

            modalFileName = System.IO.Path.GetFileName(result);
            modalFileBytes = await System.IO.File.ReadAllBytesAsync(result);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to pick file: {ex}");
            ToastService.ShowError($"Failed to read file: {ex.Message}");
        }
    }

    void ClearFile()
    {
        modalFileName = "";
        modalFileBytes = null;
    }

    async Task CopyToClipboard(string value)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", value);
            ToastService.ShowSuccess("Copied to clipboard");
        }
        catch
        {
            ToastService.ShowError("Failed to copy");
        }
    }

    string FormatProviderType(CloudSecretsProviderType type) => type switch
    {
        CloudSecretsProviderType.AzureKeyVault => "Azure Key Vault",
        CloudSecretsProviderType.AwsSecretsManager => "AWS Secrets Manager",
        CloudSecretsProviderType.GoogleSecretManager => "Google Secret Manager",
        CloudSecretsProviderType.Infisical => "Infisical",
        _ => type.ToString()
    };
}

<style>
    h1 { margin-bottom: 1.25rem; font-size: 1.75rem; color: var(--text-primary); }

    .provider-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    .provider-info i { color: var(--accent-primary); }
    .provider-type { color: var(--text-muted); }

    .toolbar { margin-bottom: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .error-bar { background: var(--status-error-bg); color: var(--status-error-text); padding: 0.75rem 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }

    /* Filter Section */
    .filter-section {
        background: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }

    .search-box { position: relative; flex: 1; min-width: 200px; }
    .search-box input {
        width: 100%;
        padding: 0.625rem 36px 0.625rem 36px;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.875rem;
        box-sizing: border-box;
        background: var(--card-bg);
        color: var(--text-primary);
    }
    .search-box input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }
    .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 0.875rem; opacity: 0.5; color: var(--text-muted); }
    .clear-btn {
        position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%);
        background: var(--border-color); border: none; border-radius: 50%;
        width: 1.25rem; height: 1.25rem; font-size: 0.875rem;
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        color: var(--text-muted);
    }
    .clear-btn:hover { background: var(--bg-hover); }

    .filter-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        background: var(--card-bg);
        color: var(--text-primary);
        cursor: pointer;
        min-width: 120px;
    }
    .filter-select:focus { outline: none; border-color: var(--accent-primary); }

    .results-info { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 0.75rem; }

    /* Buttons */
    .btn {
        padding: 0.625rem 1.25rem; border: none; border-radius: 0.375rem;
        font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease;
        display: inline-flex; align-items: center; gap: 0.375rem;
    }
    .btn i { font-size: 0.75rem; }
    .btn-icon {
        width: 2rem; height: 2rem; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 0.375rem; font-size: 0.8125rem;
    }
    .btn-icon i { font-size: 0.8125rem; margin: 0; }
    .btn-primary { background-color: var(--accent-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background-color: var(--accent-primary-hover); }
    .btn-success { background-color: var(--accent-success); color: white; }
    .btn-success:hover:not(:disabled) { background-color: var(--accent-success-hover); }
    .btn-secondary { background-color: var(--bg-hover); color: var(--text-secondary); }
    .btn-secondary:hover:not(:disabled) { background-color: var(--bg-tertiary); }
    .btn-danger { background-color: #f56565; color: white; }
    .btn-danger:hover:not(:disabled) { background-color: var(--accent-danger); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Secret List */
    .secret-list { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.25rem; }

    .secret-card {
        background: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.25rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        box-shadow: var(--card-shadow);
        border-left: 0.25rem solid var(--accent-primary);
    }

    .secret-icon { font-size: 2.25rem; color: var(--accent-primary); }
    .secret-icon i { font-size: 1.75rem; }
    .secret-details { flex: 1; }
    .secret-name { font-weight: 600; font-size: 1rem; color: var(--text-primary); font-family: monospace; }
    .secret-description { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
    .secret-badges { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .secret-meta { font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.5rem; }
    .secret-actions { display: flex; gap: 0.25rem; align-items: center; }

    .badge { padding: 2px 0.625rem; border-radius: 0.75rem; font-size: 0.75rem; font-weight: 500; }
    .badge-string { background: var(--status-info-bg); color: var(--status-info-text); }
    .badge-file { background: #faf5ff; color: #6b46c1; }
    .badge-filename { background: var(--bg-tertiary); color: var(--text-secondary); font-family: monospace; font-size: 0.6875rem; }

    /* Secret Value Reveal */
    .secret-value-reveal {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 0.375rem;
        padding: 0.75rem 1rem;
        margin-top: -0.5rem;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }
    .secret-value-text {
        flex: 1; margin: 0;
        font-family: monospace; font-size: 0.8125rem;
        color: var(--text-primary);
        white-space: pre-wrap; word-break: break-all;
    }
    .btn-copy {
        background: none; border: none; color: #a0aec0;
        cursor: pointer; padding: 2px 0.375rem; font-size: 0.75rem;
        border-radius: 0.25rem; transition: all 0.15s;
        flex-shrink: 0; display: inline-flex; align-items: center; gap: 0.25rem;
    }
    .btn-copy:hover { color: var(--accent-primary); background: var(--bg-hover); }

    /* Empty & Loading States */
    .empty-state { background: var(--card-bg); border-radius: 0.5rem; padding: 3.75rem 2.5rem; text-align: center; box-shadow: var(--card-shadow); }
    .empty-icon { font-size: 48px; margin-bottom: 1rem; color: #a0aec0; }
    .empty-icon i { font-size: 48px; }
    .empty-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
    .empty-description { color: var(--text-muted); font-size: 0.875rem; }
    .empty-description a { color: var(--accent-primary); text-decoration: none; }
    .empty-description a:hover { text-decoration: underline; }

    .loading-state { background: var(--card-bg); border-radius: 0.5rem; padding: 3.75rem 2.5rem; text-align: center; box-shadow: var(--card-shadow); }
    .loading-spinner { font-size: 48px; margin-bottom: 1rem; color: var(--accent-primary); animation: pulse 2s infinite; }
    .loading-spinner i { font-size: 48px; }
    .loading-title { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; }
    .loading-description { color: var(--text-muted); font-size: 0.875rem; }

    @@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Modal */
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.5); display: flex;
        align-items: center; justify-content: center; z-index: 1000;
    }
    .modal {
        background: var(--card-bg); border-radius: 0.75rem;
        width: 90%; max-width: 550px; max-height: 90vh;
        overflow-y: auto; box-shadow: 0 1.25rem 3.75rem rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color);
    }
    .modal-header h2 { margin: 0; font-size: 1.25rem; color: var(--text-primary); }
    .close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-muted); cursor: pointer; padding: 0; line-height: 1; }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
        display: flex; justify-content: flex-end; gap: 0.75rem;
        padding: 1rem 1.5rem; border-top: 1px solid var(--border-color);
    }

    /* Form */
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.375rem; }
    .required { color: #f56565; }
    .form-hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem; }
    .form-control {
        width: 100%; padding: 0.625rem 0.75rem;
        border: 1px solid var(--border-color); border-radius: 0.375rem;
        font-size: 0.875rem; box-sizing: border-box;
        background: var(--card-bg); color: var(--text-primary);
    }
    .form-control:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }
    .textarea { resize: vertical; font-family: monospace; min-height: 100px; }

    /* Type Selector */
    .type-selector { display: flex; gap: 0.5rem; }
    .type-btn {
        flex: 1; padding: 0.75rem;
        border: 2px solid var(--border-color); border-radius: 0.5rem;
        background: var(--card-bg); color: var(--text-secondary);
        cursor: pointer; display: flex; align-items: center;
        justify-content: center; gap: 0.5rem; font-size: 0.875rem;
        transition: all 0.2s;
    }
    .type-btn:hover { border-color: var(--accent-primary); color: var(--text-primary); }
    .type-btn.active {
        border-color: var(--accent-primary); color: var(--accent-primary);
        background: rgba(66, 153, 225, 0.08);
    }

    /* File Picker */
    .file-picker { padding: 1rem 0; }
    .file-selected {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.625rem 0.75rem;
        background: var(--bg-tertiary); border-radius: 0.375rem;
        font-size: 0.875rem; color: var(--text-primary);
    }
    .file-selected i { color: var(--accent-primary); }
    .btn-clear-file {
        background: none; border: none; color: var(--text-muted);
        cursor: pointer; padding: 0.125rem 0.25rem;
        margin-left: auto; font-size: 0.75rem;
    }
    .btn-clear-file:hover { color: var(--accent-danger); }

    /* Dark mode overrides for badge-file */
    :global(.theme-dark) .badge-file { background: rgba(107, 70, 193, 0.2); color: #d6bcfa; }
</style>
