@page "/settings"
@using MauiSherpa.Core.ViewModels
@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Services
@using MauiSherpa.Core.Requests.Android
@using Shiny.Mediator
@inject SettingsViewModel ViewModel
@inject IMediator Mediator
@inject IAppleIdentityService AppleIdentityService
@inject IAndroidSdkService SdkService
@inject IAndroidSdkSettingsService SdkSettings
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject IFileSystemService FileSystem
@inject IThemeService ThemeService
@inject ICloudSecretsService CloudSecretsService
@inject ICloudSecretsProviderFactory CloudSecretsProviderFactory
@inject ISecretsPublisherService SecretsPublisherService
@inject ISecretsPublisherFactory SecretsPublisherFactory
@inject IBackupService BackupService
@implements IDisposable

<h1><i class="fas fa-cog"></i> @ViewModel.Title</h1>

<div class="settings-section">
    <h2>General</h2>
    <div class="settings-container">
        <div class="setting-group">
            <div class="setting-item">
                <label class="setting-label">Theme</label>
                <select value="@ViewModel.Theme" @onchange="OnThemeChanged">
                    <option value="System">System</option>
                    <option value="Light">Light</option>
                    <option value="Dark">Dark</option>
                </select>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" @onclick="SaveSettings">
                <i class="fas fa-save"></i> Save Settings
            </button>
            <button class="btn btn-secondary" @onclick="ResetSettings">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
        </div>
    </div>
</div>

<div class="settings-section">
    <h2><i class="fab fa-android"></i> Android SDK</h2>
    <p class="section-description">
        Configure the Android SDK location used for managing packages, emulators, and devices.
    </p>
    
    <div class="settings-container">
        <div class="sdk-path-setting">
            <div class="sdk-path-info">
                <div class="detail-item">
                    <span class="detail-label">SDK PATH</span>
                    <span class="detail-value mono copyable">
                        @if (isLoadingSdk)
                        {
                            <span class="detecting"><i class="fas fa-spinner fa-spin"></i> Detecting...</span>
                        }
                        else if (!string.IsNullOrEmpty(SdkService.SdkPath))
                        {
                            @SdkService.SdkPath
                            <button class="btn-copy" @onclick="@(() => CopyToClipboard(SdkService.SdkPath!))" title="Copy to clipboard">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn-reveal" @onclick="@(() => FileSystem.RevealInFileManager(SdkService.SdkPath!))" title="Reveal in Finder">
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                        }
                        else
                        {
                            <span class="no-sdk">No SDK detected</span>
                        }
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(SdkSettings.CustomSdkPath))
                {
                    <div class="custom-path-badge">
                        <i class="fas fa-user-edit"></i> Custom path
                    </div>
                }
            </div>
            <div class="sdk-path-actions">
                <button class="btn btn-secondary btn-sm" @onclick="ChangeSdkPath" disabled="@isLoadingSdk">
                    <i class="fas fa-folder-open"></i> Change
                </button>
                @if (!string.IsNullOrEmpty(SdkSettings.CustomSdkPath))
                {
                    <button class="btn btn-secondary btn-sm" @onclick="ResetSdkPath" disabled="@isLoadingSdk">
                        <i class="fas fa-undo"></i> Reset to Default
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<div class="settings-section">
    <h2><i class="fab fa-apple"></i> Apple Identities</h2>
    <p class="section-description">
        Configure App Store Connect API credentials for managing Apple Developer resources.
        <a href="https://appstoreconnect.apple.com/access/integrations/api" target="_blank">Get API keys</a>
    </p>
    
    <div class="settings-container">
        @if (appleIdentities.Count == 0)
        {
            <div class="empty-identities">
                <p>No Apple identities configured</p>
            </div>
        }
        else
        {
            <div class="identity-list">
                @foreach (var identity in appleIdentities)
                {
                    <div class="identity-card">
                        <div class="identity-header">
                            <div class="identity-info">
                                <i class="fas fa-id-badge identity-icon"></i>
                                <span class="identity-name">@identity.Name</span>
                            </div>
                            <div class="identity-actions">
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => TestIdentity(identity))" title="Test Connection">
                                    <i class="fas fa-plug"></i> Test
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => EditIdentity(identity))" title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteIdentity(identity))" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="identity-details">
                            <div class="detail-item">
                                <span class="detail-label">KEY ID</span>
                                <span class="detail-value mono copyable">
                                    @identity.KeyId
                                    <button class="btn-copy" @onclick="@(() => CopyToClipboard(identity.KeyId))" title="Copy to clipboard">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ISSUER ID</span>
                                <span class="detail-value mono copyable">
                                    @identity.IssuerId
                                    <button class="btn-copy" @onclick="@(() => CopyToClipboard(identity.IssuerId))" title="Copy to clipboard">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        
        <div class="add-identity">
            <button class="btn btn-success" @onclick="ShowAddIdentityDialog">
                <i class="fas fa-plus"></i> Add Apple Identity
            </button>
        </div>
    </div>
</div>

<div class="settings-section">
    <h2><i class="fas fa-cloud"></i> Cloud Secrets Storage</h2>
    <p class="section-description">
        Store certificate private keys securely in the cloud to sync across machines.
        This enables sharing signing certificates between development machines and CI/CD pipelines.
    </p>
    
    <div class="settings-container">
        @if (cloudProviders.Count == 0)
        {
            <div class="empty-providers">
                <p>No cloud providers configured</p>
            </div>
        }
        else
        {
            <div class="provider-list">
                @foreach (var provider in cloudProviders)
                {
                    var isActive = CloudSecretsService.ActiveProvider?.Id == provider.Id;
                    var providerUrl = GetProviderUrl(provider);
                    <div class="provider-card @(isActive ? "active" : "")">
                        <div class="provider-header">
                            <div class="provider-info">
                                <i class="@GetProviderIcon(provider.ProviderType) provider-icon"></i>
                                <span class="provider-name">@provider.Name</span>
                                @if (!string.IsNullOrEmpty(providerUrl))
                                {
                                    <a href="@providerUrl" target="_blank" class="provider-link" title="Open in browser">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                }
                                @if (isActive)
                                {
                                    <span class="active-badge">Active</span>
                                }
                            </div>
                            <div class="provider-actions">
                                @if (!isActive)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="@(() => SetActiveProvider(provider))" title="Set as Active">
                                        <i class="fas fa-check"></i> Activate
                                    </button>
                                }
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => TestProvider(provider))" title="Test Connection">
                                    <i class="fas fa-plug"></i> Test
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => EditProvider(provider))" title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="@(() => DeleteProvider(provider))" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="provider-details">
                            <div class="detail-item">
                                <span class="detail-label">TYPE</span>
                                <span class="detail-value">@CloudSecretsProviderFactory.GetProviderDisplayName(provider.ProviderType)</span>
                            </div>
                            @if (provider.ProviderType == CloudSecretsProviderType.Infisical)
                            {
                                <div class="detail-item">
                                    <span class="detail-label">SITE</span>
                                    <span class="detail-value mono">@provider.Settings.GetValueOrDefault("SiteUrl", "https://app.infisical.com")</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">PROJECT</span>
                                    <span class="detail-value mono">@provider.Settings.GetValueOrDefault("ProjectId", "")</span>
                                </div>
                            }
                            @if (provider.ProviderType == CloudSecretsProviderType.AzureKeyVault)
                            {
                                <div class="detail-item">
                                    <span class="detail-label">VAULT</span>
                                    <span class="detail-value mono">@provider.Settings.GetValueOrDefault("VaultUrl", "")</span>
                                </div>
                            }
                            @if (provider.ProviderType == CloudSecretsProviderType.AwsSecretsManager)
                            {
                                <div class="detail-item">
                                    <span class="detail-label">REGION</span>
                                    <span class="detail-value mono">@provider.Settings.GetValueOrDefault("Region", "us-east-1")</span>
                                </div>
                            }
                            @if (provider.ProviderType == CloudSecretsProviderType.GoogleSecretManager)
                            {
                                <div class="detail-item">
                                    <span class="detail-label">PROJECT</span>
                                    <span class="detail-value mono">@provider.Settings.GetValueOrDefault("ProjectId", "")</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        
        <div class="add-provider">
            <button class="btn btn-success" @onclick="ShowAddProviderDialog">
                <i class="fas fa-plus"></i> Add Cloud Provider
            </button>
        </div>
    </div>
</div>

<!-- CI/CD Secret Publishers Section -->
<div class="settings-section">
    <h2><i class="fas fa-rocket"></i> CI/CD Secret Publishers</h2>
    <p class="section-description">
        Publish signing secrets directly to your CI/CD platforms for automated builds.
        Secrets will be encrypted and stored as repository secrets.
    </p>
    
    <div class="settings-container">
        @if (secretsPublishers.Count == 0)
        {
            <div class="empty-providers">
                <p>No CI/CD publishers configured</p>
            </div>
        }
        else
        {
            <div class="provider-list">
                @foreach (var publisher in secretsPublishers)
                {
                    <div class="provider-card">
                        <div class="provider-header">
                            <div class="provider-info">
                                <i class="@GetPublisherIcon(publisher.ProviderId) provider-icon"></i>
                                <span class="provider-name">@publisher.Name</span>
                            </div>
                            <div class="provider-actions">
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => TestPublisher(publisher))" title="Test Connection">
                                    <i class="fas fa-plug"></i> Test
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => EditPublisher(publisher))" title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="@(() => DeletePublisher(publisher))" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div class="provider-details">
                            <div class="detail-item">
                                <span class="detail-label">TYPE</span>
                                <span class="detail-value">@GetPublisherDisplayName(publisher.ProviderId)</span>
                            </div>
                            @if (publisher.ProviderId == "github")
                            {
                                var owner = publisher.Settings.GetValueOrDefault("Owner", "");
                                @if (!string.IsNullOrEmpty(owner))
                                {
                                    <div class="detail-item">
                                        <span class="detail-label">OWNER</span>
                                        <span class="detail-value mono">@owner</span>
                                    </div>
                                }
                            }
                            @if (publisher.ProviderId == "gitea" || publisher.ProviderId == "gitlab")
                            {
                                <div class="detail-item">
                                    <span class="detail-label">SERVER</span>
                                    <span class="detail-value mono">@publisher.Settings.GetValueOrDefault("ServerUrl", "")</span>
                                </div>
                            }
                            @if (publisher.ProviderId == "azuredevops")
                            {
                                <div class="detail-item">
                                    <span class="detail-label">ORG</span>
                                    <span class="detail-value mono">@publisher.Settings.GetValueOrDefault("OrganizationUrl", "")</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        
        <div class="add-provider">
            <button class="btn btn-success" @onclick="ShowAddPublisherDialog">
                <i class="fas fa-plus"></i> Add CI/CD Publisher
            </button>
        </div>
    </div>
</div>

<!-- Backup & Restore Section -->
<div class="settings-section">
    <h2><i class="fas fa-shield-alt"></i> Backup & Restore</h2>
    <p class="section-description">
        Export your settings to a password-protected file for backup or transfer to another machine.
        All sensitive data (API keys, tokens) are encrypted using AES-256-GCM.
    </p>
    
    <div class="settings-container">
        <div class="backup-actions">
            <div class="backup-action-card">
                <div class="backup-icon export">
                    <i class="fas fa-download"></i>
                </div>
                <div class="backup-info">
                    <h3>Export Settings</h3>
                    <p>Create a password-protected backup of all your settings including Apple identities, cloud providers, and CI/CD publishers.</p>
                </div>
                <button class="btn btn-primary" @onclick="ShowExportDialog" disabled="@isExporting">
                    @if (isExporting)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Exporting...</span>
                    }
                    else
                    {
                        <i class="fas fa-file-export"></i>
                        <span>Export</span>
                    }
                </button>
            </div>
            
            <div class="backup-action-card">
                <div class="backup-icon import">
                    <i class="fas fa-upload"></i>
                </div>
                <div class="backup-info">
                    <h3>Import Settings</h3>
                    <p>Restore settings from a backup file. This will merge with or replace your existing settings.</p>
                </div>
                <button class="btn btn-secondary" @onclick="ShowImportDialog" disabled="@isImporting">
                    @if (isImporting)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Importing...</span>
                    }
                    else
                    {
                        <i class="fas fa-file-import"></i>
                        <span>Import</span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

@if (showExportDialog)
{
    <div class="modal-overlay" @onclick="CloseExportDialog">
        <div class="modal modal-sm" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Export Settings</h2>
                <button class="close-btn" @onclick="CloseExportDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" @bind="exportPassword" placeholder="Enter a secure password" />
                    <div class="help-text">This password will be required to import the backup</div>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" @bind="exportPasswordConfirm" placeholder="Confirm password" />
                </div>
                @if (!string.IsNullOrEmpty(exportError))
                {
                    <div class="error-message">@exportError</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseExportDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="ExportSettings" 
                        disabled="@(string.IsNullOrEmpty(exportPassword) || exportPassword != exportPasswordConfirm)">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
}

@if (showImportDialog)
{
    <div class="modal-overlay" @onclick="CloseImportDialog">
        <div class="modal modal-sm" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Import Settings</h2>
                <button class="close-btn" @onclick="CloseImportDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Backup File</label>
                    <div class="file-input-group">
                        <input type="text" value="@importFilePath" placeholder="Select backup file" readonly />
                        <button class="btn btn-secondary" @onclick="BrowseImportFile">
                            <i class="fas fa-folder-open"></i> Browse
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" @bind="importPassword" placeholder="Enter backup password" />
                </div>
                @if (!string.IsNullOrEmpty(importError))
                {
                    <div class="error-message">@importError</div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseImportDialog">Cancel</button>
                <button class="btn btn-primary" @onclick="ImportSettings"
                        disabled="@(string.IsNullOrEmpty(importFilePath) || string.IsNullOrEmpty(importPassword))">
                    <i class="fas fa-upload"></i> Import
                </button>
            </div>
        </div>
    </div>
}

@if (showIdentityDialog)
{
    <div class="modal-overlay">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(editingIdentity == null ? "Add" : "Edit") Apple Identity</h2>
                <button class="close-btn" @onclick="CloseIdentityDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" @bind="identityName" placeholder="My Team" />
                    <div class="help-text">A friendly name to identify this credential</div>
                </div>
                <div class="form-group">
                    <label>Key ID</label>
                    <input type="text" @bind="identityKeyId" placeholder="ABC123XYZ" />
                    <div class="help-text">The 10-character Key ID from App Store Connect</div>
                </div>
                <div class="form-group">
                    <label>Issuer ID (Team ID)</label>
                    <input type="text" @bind="identityIssuerId" placeholder="12345678-1234-1234-1234-123456789012" />
                    <div class="help-text">Your Issuer ID (UUID format) from App Store Connect → Users and Access → Keys</div>
                </div>
                <div class="form-group">
                    <label>Private Key (.p8)</label>
                    <div class="p8-input-toggle">
                        <button class="toggle-btn @(p8InputMode == "file" ? "active" : "")" @onclick="@(() => p8InputMode = "file")">
                            <i class="fas fa-folder-open"></i> File
                        </button>
                        <button class="toggle-btn @(p8InputMode == "text" ? "active" : "")" @onclick="@(() => p8InputMode = "text")">
                            <i class="fas fa-file-alt"></i> Text
                        </button>
                    </div>
                    @if (p8InputMode == "file")
                    {
                        <div class="file-input-group">
                            <input type="text" value="@identityP8Path" placeholder="Path to .p8 file" readonly />
                            <button class="btn btn-secondary" @onclick="BrowseP8File">
                                <i class="fas fa-folder-open"></i> Browse...
                            </button>
                        </div>
                        <div class="help-text">Select your AuthKey_XXXXXX.p8 file downloaded from App Store Connect</div>
                    }
                    else
                    {
                        <textarea @bind="identityP8Content" 
                                  placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----" 
                                  rows="6"
                                  class="p8-textarea"></textarea>
                        <div class="help-text">Paste the contents of your .p8 file (including BEGIN/END lines)</div>
                    }
                </div>
                @if (!string.IsNullOrEmpty(identityP8Content))
                {
                    <div class="p8-preview">
                        <span class="p8-loaded"><i class="fas fa-check-circle"></i> P8 key loaded (@identityP8Content.Length chars)</span>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseIdentityDialog">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="SaveIdentity" 
                        disabled="@(!CanSaveIdentity)">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
}

@if (showProviderDialog)
{
    <div class="modal-overlay">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(editingProvider == null ? "Add" : "Edit") Cloud Provider</h2>
                <button class="close-btn" @onclick="CloseProviderDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" @bind="providerName" placeholder="My Team Vault" />
                    <div class="help-text">A friendly name to identify this provider</div>
                </div>
                <div class="form-group">
                    <label>Provider Type</label>
                    @if (editingProvider != null)
                    {
                        <input type="text" value="@CloudSecretsProviderFactory.GetProviderDisplayName(providerType)" disabled />
                    }
                    else
                    {
                        <div class="provider-type-selector">
                            @foreach (var type in CloudSecretsProviderFactory.SupportedProviders)
                            {
                                <div class="provider-type-card @(providerType == type ? "selected" : "")" 
                                     @onclick="@(() => providerType = type)">
                                    <i class="@GetProviderIcon(type) provider-icon"></i>
                                    <span class="provider-name">@CloudSecretsProviderFactory.GetProviderDisplayName(type)</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                
                @foreach (var setting in GetCurrentProviderSettings())
                {
                    <div class="form-group">
                        <label>@setting.DisplayName @(setting.IsRequired ? "*" : "")</label>
                        @if (setting.IsSecret)
                        {
                            <input type="password" 
                                   value="@(providerSettings.GetValueOrDefault(setting.Key, ""))"
                                   @onchange="@(e => providerSettings[setting.Key] = e.Value?.ToString() ?? "")"
                                   placeholder="@setting.Placeholder" />
                        }
                        else if (setting.Key == "CredentialsJson")
                        {
                            <textarea rows="6"
                                      class="p8-textarea"
                                      @bind="@providerSettings[setting.Key]"
                                      placeholder="@setting.Placeholder"></textarea>
                        }
                        else
                        {
                            <input type="text" 
                                   value="@(providerSettings.GetValueOrDefault(setting.Key, setting.DefaultValue ?? ""))"
                                   @onchange="@(e => providerSettings[setting.Key] = e.Value?.ToString() ?? "")"
                                   placeholder="@setting.Placeholder" />
                        }
                        <div class="help-text">@setting.Description</div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseProviderDialog">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="SaveProvider" 
                        disabled="@(!CanSaveProvider)">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
}

@if (showPublisherDialog)
{
    <div class="modal-overlay">
        <div class="modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>@(editingPublisher == null ? "Add" : "Edit") CI/CD Publisher</h2>
                <button class="close-btn" @onclick="ClosePublisherDialog">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" @bind="publisherName" placeholder="My GitHub Account" />
                    <div class="help-text">A friendly name to identify this publisher</div>
                </div>
                <div class="form-group">
                    <label>Provider Type</label>
                    @if (editingPublisher != null)
                    {
                        <input type="text" value="@GetPublisherDisplayName(publisherProviderId)" disabled />
                    }
                    else
                    {
                        <div class="provider-type-selector">
                            @foreach (var (providerId, displayName, iconClass) in SecretsPublisherFactory.GetAvailableProviders())
                            {
                                <div class="provider-type-card @(publisherProviderId == providerId ? "selected" : "")" 
                                     @onclick="@(() => publisherProviderId = providerId)">
                                    <i class="@iconClass provider-icon"></i>
                                    <span class="provider-name">@displayName</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                
                @foreach (var (key, label, type, required, placeholder) in SecretsPublisherFactory.GetRequiredSettings(publisherProviderId))
                {
                    <div class="form-group">
                        <label>@label @(required ? "*" : "")</label>
                        @if (type == "password")
                        {
                            <input type="password" 
                                   value="@(publisherSettings.GetValueOrDefault(key, ""))"
                                   @onchange="@(e => publisherSettings[key] = e.Value?.ToString() ?? "")"
                                   placeholder="@placeholder" />
                        }
                        else if (type == "url")
                        {
                            <input type="url" 
                                   value="@(publisherSettings.GetValueOrDefault(key, ""))"
                                   @onchange="@(e => publisherSettings[key] = e.Value?.ToString() ?? "")"
                                   placeholder="@placeholder" />
                        }
                        else
                        {
                            <input type="text" 
                                   value="@(publisherSettings.GetValueOrDefault(key, ""))"
                                   @onchange="@(e => publisherSettings[key] = e.Value?.ToString() ?? "")"
                                   placeholder="@placeholder" />
                        }
                        @if (key == "PersonalAccessToken" && publisherProviderId == "github")
                        {
                            <div class="help-text">
                                Generate a PAT with <code>repo</code> scope at 
                                <a href="#" @onclick:preventDefault @onclick='() => OpenUrl("https://github.com/settings/tokens/new?scopes=repo&description=MauiSherpa")'>GitHub Settings</a>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePublisherDialog">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary" @onclick="SavePublisher" 
                        disabled="@(!CanSavePublisher)">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
}

<style>
    h1 { margin-bottom: 20px; font-size: 28px; color: var(--text-primary); font-weight: 600; }
    h2 { margin: 0 0 16px 0; font-size: 18px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 10px; }
    h2 i { color: var(--text-secondary); }

    .settings-section { margin-bottom: 32px; }
    .section-description { color: var(--text-muted); margin-bottom: 16px; font-size: 14px; }
    .section-description a { color: var(--accent-primary); }

    .settings-container {
        background: var(--card-bg);
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
    }

    .setting-group { margin-bottom: 24px; }
    .setting-group:last-child { margin-bottom: 0; }

    .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .setting-item:first-child { padding-top: 0; }
    .setting-item:last-child { border-bottom: none; padding-bottom: 0; }
    .setting-label { font-size: 16px; color: var(--text-primary); font-weight: 500; }
    .setting-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

    .setting-item select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        min-width: 150px;
    }

    .setting-item select:focus { outline: none; border-color: var(--accent-primary); }

    .actions { display: flex; gap: 12px; }

    .btn { 
        padding: 10px 20px; 
        border: none; 
        border-radius: 6px; 
        font-size: 14px; 
        cursor: pointer; 
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .btn i { font-size: 14px; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    .btn-sm i { font-size: 12px; }
    .btn-primary { background-color: var(--accent-primary); color: var(--card-bg); }
    .btn-primary:hover { background-color: var(--accent-primary-hover); }
    .btn-secondary { background-color: var(--text-secondary); color: var(--card-bg); }
    .btn-secondary:hover { background-color: var(--text-primary); }
    .btn-success { background-color: #48bb78; color: white; }
    .btn-success:hover { background-color: #38a169; }
    .btn-danger { background-color: #f56565; color: white; }
    .btn-danger:hover { background-color: #e53e3e; }

    .identity-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }

    .identity-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        background: var(--bg-tertiary);
        box-shadow: none;
    }

    .identity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .identity-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .identity-icon {
        font-size: 20px;
        color: var(--text-secondary);
    }

    .identity-name { font-weight: 600; color: var(--text-primary); font-size: 15px; }
    .identity-actions { display: flex; gap: 8px; }

    .identity-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        font-size: 11px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 500;
    }

    .detail-value {
        font-size: 14px;
        color: var(--text-primary);
    }

    .detail-value.mono {
        font-family: "SF Mono", Menlo, Monaco, monospace;
        font-size: 13px;
        word-break: break-all;
    }

    .detail-value.copyable {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-copy {
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-copy:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .btn-reveal {
        background: none;
        border: none;
        color: #a0aec0;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 4px;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    .btn-reveal:hover {
        color: var(--accent-primary);
        background: var(--bg-tertiary);
    }

    .sdk-path-setting {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
    }

    .sdk-path-info {
        flex: 1;
    }

    .sdk-path-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .detecting {
        color: var(--text-muted);
        font-style: italic;
        font-family: inherit;
    }

    .no-sdk {
        color: #a0aec0;
        font-style: italic;
        font-family: inherit;
    }

    .custom-path-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 4px 10px;
        background: #bee3f8;
        color: #2c5282;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .empty-identities { padding: 20px; text-align: center; color: var(--text-muted); }
    .add-identity { margin-top: 16px; }

    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: var(--card-bg); border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .modal-header h2 { margin: 0; font-size: 18px; color: var(--text-primary); }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #a0aec0; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }

    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
    .form-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; box-sizing: border-box; background: var(--bg-tertiary); color: var(--text-primary); }
    .form-group input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
    .form-group select { 
        width: 100%; 
        padding: 10px 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        font-size: 14px; 
        box-sizing: border-box;
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }
    .form-group select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
    .form-group select:disabled { 
        background-color: var(--bg-tertiary); 
        color: var(--text-muted); 
        cursor: not-allowed;
    }
    .help-text { margin-top: 6px; font-size: 12px; color: var(--text-muted); }

    /* Provider Type Selector Cards */
    .provider-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 8px;
    }

    .provider-type-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-tertiary);
    }

    .provider-type-card:hover {
        border-color: var(--accent-primary);
        background: rgba(66, 153, 225, 0.05);
    }

    .provider-type-card.selected {
        border-color: var(--accent-primary);
        background: rgba(66, 153, 225, 0.1);
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15);
    }

    .provider-type-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .provider-type-card .provider-icon {
        font-size: 28px;
        margin-bottom: 8px;
        color: var(--text-secondary);
    }

    .provider-type-card.selected .provider-icon {
        color: var(--accent-primary);
    }

    .provider-type-card .provider-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        text-align: center;
    }

    .provider-type-card .coming-soon-badge {
        position: absolute;
        top: 4px;
        right: 4px;
        font-size: 9px;
        padding: 2px 6px;
        background: var(--warning-color, #f59e0b);
        color: white;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .file-input-group { display: flex; gap: 8px; }
    .file-input-group input { flex: 1; }

    .p8-input-toggle { display: flex; gap: 0; margin-bottom: 12px; }
    .toggle-btn { 
        padding: 8px 16px; 
        border: 1px solid var(--border-color); 
        background: var(--bg-tertiary); 
        cursor: pointer; 
        font-size: 13px;
        color: var(--text-secondary);
        transition: all 0.15s;
    }
    .toggle-btn:first-child { border-radius: 6px 0 0 6px; }
    .toggle-btn:last-child { border-radius: 0 6px 6px 0; border-left: none; }
    .toggle-btn.active { 
        background: var(--accent-primary); 
        color: var(--card-bg); 
        border-color: var(--accent-primary); 
    }
    .toggle-btn:hover:not(.active) { background: var(--bg-tertiary); }

    .p8-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        resize: vertical;
        min-height: 120px;
    }
    .p8-textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }

    .p8-preview { margin-top: 8px; }
    .p8-loaded { color: #38a169; font-size: 13px; }

    /* Cloud Provider Styles */
    .empty-providers { padding: 20px; text-align: center; color: var(--text-muted); }
    .add-provider { margin-top: 16px; }
    
    .provider-list { display: flex; flex-direction: column; gap: 16px; }
    
    .provider-card {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        background: var(--bg-tertiary);
        transition: border-color 0.2s;
    }
    .provider-card.active {
        border-color: var(--accent-primary);
    }
    
    .provider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .provider-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .provider-icon {
        font-size: 20px;
        color: var(--text-secondary);
    }
    
    .provider-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 15px;
    }

    .provider-link {
        color: var(--text-muted);
        font-size: 14px;
        padding: 4px;
        border-radius: 4px;
        transition: color 0.2s, background 0.2s;
        text-decoration: none;
    }

    .provider-link:hover {
        color: var(--accent-primary);
        background: rgba(66, 153, 225, 0.1);
    }
    
    .active-badge {
        background: var(--accent-primary);
        color: white;
        font-size: 11px;
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 10px;
    }
    
    .provider-actions {
        display: flex;
        gap: 8px;
    }
    
    .provider-details {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    /* Backup & Restore Styles */
    .backup-actions {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .backup-action-card {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 20px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .backup-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .backup-icon.export {
        background: linear-gradient(135deg, #4299e1, #3182ce);
        color: white;
    }

    .backup-icon.import {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
    }

    .backup-info {
        flex: 1;
    }

    .backup-info h3 {
        margin: 0 0 4px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .backup-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.4;
    }

    .modal-sm {
        max-width: 440px;
    }

    .error-message {
        background: rgba(245, 101, 101, 0.1);
        border: 1px solid rgba(245, 101, 101, 0.3);
        color: #c53030;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 13px;
    }

    .theme-dark .error-message {
        background: rgba(245, 101, 101, 0.15);
        color: #fc8181;
    }
</style>

@code {
    private List<AppleIdentity> appleIdentities = new();
    
    private async Task OpenUrl(string url)
    {
        await Launcher.Default.OpenAsync(new Uri(url));
    }
    
    private bool showIdentityDialog = false;
    private AppleIdentity? editingIdentity = null;
    private string identityName = "";
    private string identityKeyId = "";
    private string identityIssuerId = "";
    private string identityP8Path = "";
    private string identityP8Content = "";
    private string p8InputMode = "file"; // "file" or "text"
    
    private bool isLoadingSdk = true;
    
    // Cloud provider state
    private List<CloudSecretsProviderConfig> cloudProviders = new();
    private bool showProviderDialog = false;
    private CloudSecretsProviderConfig? editingProvider = null;
    private string providerName = "";
    private CloudSecretsProviderType providerType = CloudSecretsProviderType.Infisical;
    private Dictionary<string, string> providerSettings = new();

    // CI/CD Publisher state
    private List<SecretsPublisherConfig> secretsPublishers = new();
    private bool showPublisherDialog = false;
    private SecretsPublisherConfig? editingPublisher = null;
    private string publisherName = "";
    private string publisherProviderId = "github";
    private Dictionary<string, string> publisherSettings = new();

    // Backup/Restore state
    private bool showExportDialog = false;
    private bool showImportDialog = false;
    private string exportPassword = "";
    private string exportPasswordConfirm = "";
    private string exportError = "";
    private string importFilePath = "";
    private string importPassword = "";
    private string importError = "";
    private bool isExporting = false;
    private bool isImporting = false;

    private bool CanSaveIdentity => 
        !string.IsNullOrWhiteSpace(identityName) &&
        !string.IsNullOrWhiteSpace(identityKeyId) &&
        !string.IsNullOrWhiteSpace(identityIssuerId) &&
        !string.IsNullOrWhiteSpace(identityP8Content);
    
    private bool CanSaveProvider
    {
        get
        {
            if (string.IsNullOrWhiteSpace(providerName)) return false;
            var requiredSettings = GetCurrentProviderSettings().Where(s => s.IsRequired);
            return requiredSettings.All(s => !string.IsNullOrWhiteSpace(providerSettings.GetValueOrDefault(s.Key)));
        }
    }

    private bool CanSavePublisher
    {
        get
        {
            if (string.IsNullOrWhiteSpace(publisherName)) return false;
            var (isValid, _) = SecretsPublisherFactory.ValidateConfig(publisherProviderId, publisherSettings);
            return isValid;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Sync ViewModel with current theme service state
        ViewModel.Theme = ThemeService.CurrentTheme;
        
        // Subscribe to SDK path changes
        SdkSettings.SdkPathChanged += OnSdkPathChanged;
        
        // Subscribe to cloud provider changes
        CloudSecretsService.OnActiveProviderChanged += OnCloudProviderChanged;
        
        // Subscribe to secrets publisher changes
        SecretsPublisherService.OnPublishersChanged += OnPublishersChanged;
        
        await LoadAppleIdentities();
        await LoadCloudProviders();
        await LoadSecretsPublishers();
        await InitializeSdk();
    }

    private async Task InitializeSdk()
    {
        isLoadingSdk = true;
        StateHasChanged();
        
        try
        {
            if (SdkSettings is AndroidSdkSettingsService settingsService)
            {
                await settingsService.InitializeAsync();
            }
        }
        finally
        {
            isLoadingSdk = false;
            StateHasChanged();
        }
    }

    private void OnSdkPathChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void OnCloudProviderChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        SdkSettings.SdkPathChanged -= OnSdkPathChanged;
        CloudSecretsService.OnActiveProviderChanged -= OnCloudProviderChanged;
        SecretsPublisherService.OnPublishersChanged -= OnPublishersChanged;
    }

    private async Task LoadAppleIdentities()
    {
        appleIdentities = (await AppleIdentityService.GetIdentitiesAsync()).ToList();
    }
    
    private async Task LoadCloudProviders()
    {
        cloudProviders = (await CloudSecretsService.GetProvidersAsync()).ToList();
        
        // Initialize service if needed
        if (CloudSecretsService is CloudSecretsService svc)
        {
            await svc.InitializeAsync();
        }
    }

    private async Task LoadSecretsPublishers()
    {
        secretsPublishers = (await SecretsPublisherService.GetPublishersAsync()).ToList();
    }

    private void OnPublishersChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadSecretsPublishers();
            StateHasChanged();
        });
    }

    private void OnThemeChanged(ChangeEventArgs e)
    {
        var theme = e.Value?.ToString() ?? "System";
        ViewModel.Theme = theme;
        ThemeService.SetTheme(theme);
    }

    private async Task SaveSettings()
    {
        await ViewModel.SaveSettingsAsync();
    }

    private async Task ResetSettings()
    {
        await ViewModel.ResetSettingsAsync();
        ThemeService.SetTheme(ViewModel.Theme);
    }

    private void ShowAddIdentityDialog()
    {
        editingIdentity = null;
        identityName = "";
        identityKeyId = "";
        identityIssuerId = "";
        identityP8Path = "";
        identityP8Content = "";
        p8InputMode = "file";
        showIdentityDialog = true;
    }

    private async Task ChangeSdkPath()
    {
        var path = await DialogService.PickFolderAsync("Select Android SDK Location");
        if (string.IsNullOrEmpty(path)) return;

        isLoadingSdk = true;
        StateHasChanged();

        try
        {
            await SdkSettings.SetCustomSdkPathAsync(path);
            // Invalidate SDK path cache
            await Mediator.FlushStores("android:sdkpath");
            await AlertService.ShowToastAsync("SDK path updated");
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to set SDK path: {ex.Message}");
        }
        finally
        {
            isLoadingSdk = false;
            StateHasChanged();
        }
    }

    private async Task ResetSdkPath()
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Reset SDK Path",
            "Reset to the default auto-detected SDK path?");
        
        if (!confirm) return;

        isLoadingSdk = true;
        StateHasChanged();

        try
        {
            await SdkSettings.ResetToDefaultAsync();
            // Invalidate SDK path cache
            await Mediator.FlushStores("android:sdkpath");
            await AlertService.ShowToastAsync("SDK path reset to default");
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to reset SDK path: {ex.Message}");
        }
        finally
        {
            isLoadingSdk = false;
            StateHasChanged();
        }
    }

    private void EditIdentity(AppleIdentity identity)
    {
        editingIdentity = identity;
        identityName = identity.Name;
        identityKeyId = identity.KeyId;
        identityIssuerId = identity.IssuerId;
        identityP8Path = identity.P8KeyPath ?? "";
        identityP8Content = identity.P8KeyContent ?? "";
        // If we have content but no path, default to text mode
        p8InputMode = string.IsNullOrEmpty(identity.P8KeyPath) && !string.IsNullOrEmpty(identity.P8KeyContent) ? "text" : "file";
        showIdentityDialog = true;
    }

    private void CloseIdentityDialog()
    {
        showIdentityDialog = false;
        editingIdentity = null;
    }

    private async Task BrowseP8File()
    {
        var path = await DialogService.ShowFileDialogAsync(
            "Select P8 Key File",
            isSave: false,
            filters: new[] { "*.p8" });

        if (!string.IsNullOrEmpty(path))
        {
            identityP8Path = path;
            identityP8Content = await FileSystem.ReadFileAsync(path) ?? "";
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SaveIdentity()
    {
        var id = editingIdentity?.Id ?? Guid.NewGuid().ToString();
        
        var identity = new AppleIdentity(
            Id: id,
            Name: identityName.Trim(),
            KeyId: identityKeyId.Trim(),
            IssuerId: identityIssuerId.Trim(),
            P8KeyPath: string.IsNullOrEmpty(identityP8Path) ? null : identityP8Path,
            P8KeyContent: identityP8Content);

        await AppleIdentityService.SaveIdentityAsync(identity);
        await AlertService.ShowToastAsync($"Identity '{identityName}' saved");
        
        CloseIdentityDialog();
        await LoadAppleIdentities();
    }

    private async Task TestIdentity(AppleIdentity identity)
    {
        var success = await AppleIdentityService.TestConnectionAsync(identity);
        if (success)
            await AlertService.ShowToastAsync("Connection successful!");
        else
            await AlertService.ShowAlertAsync("Connection Failed", "Could not connect with these credentials. Check your Key ID, Issuer ID, and P8 key.");
    }

    private async Task DeleteIdentity(AppleIdentity identity)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Delete Identity",
            $"Are you sure you want to delete '{identity.Name}'?");

        if (!confirm) return;

        await AppleIdentityService.DeleteIdentityAsync(identity.Id);
        
        // Immediately remove from list for responsive UI
        appleIdentities.Remove(identity);
        StateHasChanged();
        
        await AlertService.ShowToastAsync("Identity deleted");
        await LoadAppleIdentities();
    }

    private async Task CopyToClipboard(string text)
    {
        await DialogService.CopyToClipboardAsync(text);
        await AlertService.ShowToastAsync("Copied to clipboard");
    }
    
    // Cloud Provider Methods
    
    private string GetProviderIcon(CloudSecretsProviderType type) => type switch
    {
        CloudSecretsProviderType.Infisical => "fas fa-shield-alt",
        CloudSecretsProviderType.AzureKeyVault => "fas fa-key",
        CloudSecretsProviderType.AwsSecretsManager => "fab fa-aws",
        CloudSecretsProviderType.GoogleSecretManager => "fab fa-google",
        _ => "fas fa-lock"
    };

    private string? GetProviderUrl(CloudSecretsProviderConfig provider)
    {
        return provider.ProviderType switch
        {
            CloudSecretsProviderType.Infisical => GetInfisicalUrl(provider),
            CloudSecretsProviderType.AzureKeyVault => GetAzureKeyVaultUrl(provider),
            CloudSecretsProviderType.AwsSecretsManager => GetAwsSecretsManagerUrl(provider),
            CloudSecretsProviderType.GoogleSecretManager => GetGoogleSecretManagerUrl(provider),
            _ => null
        };
    }

    private string? GetInfisicalUrl(CloudSecretsProviderConfig provider)
    {
        var siteUrl = provider.Settings.GetValueOrDefault("SiteUrl", "https://app.infisical.com").TrimEnd('/');
        var projectId = provider.Settings.GetValueOrDefault("ProjectId", "");
        var environment = provider.Settings.GetValueOrDefault("Environment", "prod");
        
        if (string.IsNullOrEmpty(projectId))
            return siteUrl;
        
        return $"{siteUrl}/projects/secret-management/{projectId}/overview";
    }

    private string? GetAzureKeyVaultUrl(CloudSecretsProviderConfig provider)
    {
        var vaultUrl = provider.Settings.GetValueOrDefault("VaultUrl", "").TrimEnd('/');
        
        if (string.IsNullOrEmpty(vaultUrl))
            return null;
        
        // Extract vault name from URL like https://my-vault.vault.azure.net
        try
        {
            var uri = new Uri(vaultUrl);
            var vaultName = uri.Host.Split('.')[0];
            // Link to Azure Portal for the Key Vault
            return $"https://portal.azure.com/#view/Microsoft_Azure_KeyVault/VaultBlade/vaultName/{vaultName}";
        }
        catch
        {
            return vaultUrl;
        }
    }

    private string? GetAwsSecretsManagerUrl(CloudSecretsProviderConfig provider)
    {
        var region = provider.Settings.GetValueOrDefault("Region", "us-east-1");
        // Link to AWS Secrets Manager console for the region
        return $"https://{region}.console.aws.amazon.com/secretsmanager/listsecrets?region={region}";
    }

    private string? GetGoogleSecretManagerUrl(CloudSecretsProviderConfig provider)
    {
        var projectId = provider.Settings.GetValueOrDefault("ProjectId", "");
        if (string.IsNullOrEmpty(projectId))
            return null;
        // Link to Google Cloud Console Secret Manager for the project
        return $"https://console.cloud.google.com/security/secret-manager?project={projectId}";
    }
    
    private IReadOnlyList<CloudProviderSettingInfo> GetCurrentProviderSettings()
    {
        return CloudSecretsProviderFactory.GetProviderSettings(providerType);
    }
    
    private void ShowAddProviderDialog()
    {
        editingProvider = null;
        providerName = "";
        providerType = CloudSecretsProviderFactory.SupportedProviders.FirstOrDefault();
        providerSettings = new Dictionary<string, string>();
        
        // Initialize with default values
        foreach (var setting in GetCurrentProviderSettings())
        {
            if (!string.IsNullOrEmpty(setting.DefaultValue))
            {
                providerSettings[setting.Key] = setting.DefaultValue;
            }
        }
        
        showProviderDialog = true;
    }
    
    private void EditProvider(CloudSecretsProviderConfig provider)
    {
        editingProvider = provider;
        providerName = provider.Name;
        providerType = provider.ProviderType;
        providerSettings = new Dictionary<string, string>(provider.Settings);
        showProviderDialog = true;
    }
    
    private void CloseProviderDialog()
    {
        showProviderDialog = false;
        editingProvider = null;
    }
    
    private async Task SaveProvider()
    {
        var config = new CloudSecretsProviderConfig(
            editingProvider?.Id ?? Guid.NewGuid().ToString("N"),
            providerName,
            providerType,
            new Dictionary<string, string>(providerSettings)
        );
        
        await CloudSecretsService.SaveProviderAsync(config);
        await AlertService.ShowToastAsync($"Provider '{providerName}' saved");
        CloseProviderDialog();
        await LoadCloudProviders();
    }
    
    private async Task DeleteProvider(CloudSecretsProviderConfig provider)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Delete Provider",
            $"Are you sure you want to delete '{provider.Name}'?");
        
        if (!confirm) return;
        
        await CloudSecretsService.DeleteProviderAsync(provider.Id);
        
        // Immediately remove from list for responsive UI
        cloudProviders.Remove(provider);
        StateHasChanged();
        
        await AlertService.ShowToastAsync("Provider deleted");
        await LoadCloudProviders();
    }
    
    private async Task TestProvider(CloudSecretsProviderConfig provider)
    {
        var success = await CloudSecretsService.TestProviderConnectionAsync(provider.Id);
        if (success)
            await AlertService.ShowToastAsync("Connection successful!");
        else
            await AlertService.ShowAlertAsync("Connection Failed", "Could not connect to the cloud provider. Check your credentials and settings.");
    }
    
    private async Task SetActiveProvider(CloudSecretsProviderConfig provider)
    {
        await CloudSecretsService.SetActiveProviderAsync(provider.Id);
        await AlertService.ShowToastAsync($"'{provider.Name}' is now the active provider");
        StateHasChanged();
    }

    // CI/CD Publisher Methods
    
    private string GetPublisherIcon(string providerId) => providerId switch
    {
        "github" => "fa-brands fa-github",
        "gitea" => "fa-solid fa-code-branch",
        "gitlab" => "fa-brands fa-gitlab",
        "azuredevops" => "fa-brands fa-microsoft",
        _ => "fa-solid fa-rocket"
    };

    private string GetPublisherDisplayName(string providerId) => providerId switch
    {
        "github" => "GitHub Actions",
        "gitea" => "Gitea",
        "gitlab" => "GitLab CI/CD",
        "azuredevops" => "Azure DevOps",
        _ => providerId
    };

    private void ShowAddPublisherDialog()
    {
        editingPublisher = null;
        publisherName = "";
        publisherProviderId = "github";
        publisherSettings = new Dictionary<string, string>();
        showPublisherDialog = true;
    }

    private void EditPublisher(SecretsPublisherConfig publisher)
    {
        editingPublisher = publisher;
        publisherName = publisher.Name;
        publisherProviderId = publisher.ProviderId;
        publisherSettings = new Dictionary<string, string>(publisher.Settings);
        showPublisherDialog = true;
    }

    private void ClosePublisherDialog()
    {
        showPublisherDialog = false;
        editingPublisher = null;
    }

    private async Task SavePublisher()
    {
        var config = new SecretsPublisherConfig(
            editingPublisher?.Id ?? Guid.NewGuid().ToString("N"),
            publisherProviderId,
            publisherName,
            new Dictionary<string, string>(publisherSettings)
        );
        
        await SecretsPublisherService.SavePublisherAsync(config);
        await AlertService.ShowToastAsync($"Publisher '{publisherName}' saved");
        ClosePublisherDialog();
        await LoadSecretsPublishers();
    }

    private async Task DeletePublisher(SecretsPublisherConfig publisher)
    {
        var confirm = await AlertService.ShowConfirmAsync(
            "Delete Publisher",
            $"Are you sure you want to delete '{publisher.Name}'?");
        
        if (!confirm) return;
        
        await SecretsPublisherService.DeletePublisherAsync(publisher.Id);
        
        // Immediately remove from list for responsive UI
        secretsPublishers.Remove(publisher);
        StateHasChanged();
        
        await AlertService.ShowToastAsync("Publisher deleted");
        await LoadSecretsPublishers();
    }

    private async Task TestPublisher(SecretsPublisherConfig publisher)
    {
        try
        {
            var success = await SecretsPublisherService.TestConnectionAsync(publisher.Id);
            if (success)
                await AlertService.ShowToastAsync("Connection successful!");
            else
                await AlertService.ShowAlertAsync("Connection Failed", "Could not connect to the CI/CD provider. Check your credentials.");
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Connection Failed", ex.Message);
        }
    }

    // Backup & Restore methods
    private void ShowExportDialog()
    {
        exportPassword = "";
        exportPasswordConfirm = "";
        exportError = "";
        showExportDialog = true;
    }

    private void CloseExportDialog()
    {
        showExportDialog = false;
        exportPassword = "";
        exportPasswordConfirm = "";
        exportError = "";
    }

    private void ShowImportDialog()
    {
        importFilePath = "";
        importPassword = "";
        importError = "";
        showImportDialog = true;
    }

    private void CloseImportDialog()
    {
        showImportDialog = false;
        importFilePath = "";
        importPassword = "";
        importError = "";
    }

    private async Task BrowseImportFile()
    {
        var path = await DialogService.PickOpenFileAsync("Select Backup File", new[] { "mss" });
        if (!string.IsNullOrEmpty(path))
        {
            importFilePath = path;
            StateHasChanged();
        }
    }

    private async Task ExportSettings()
    {
        if (exportPassword != exportPasswordConfirm)
        {
            exportError = "Passwords do not match";
            return;
        }

        if (exportPassword.Length < 8)
        {
            exportError = "Password must be at least 8 characters";
            return;
        }

        isExporting = true;
        exportError = "";
        StateHasChanged();

        try
        {
            var encrypted = await BackupService.ExportSettingsAsync(exportPassword);
            var timestamp = DateTime.Now.ToString("yyyyMMdd-HHmmss");
            var suggestedName = $"maui-sherpa-backup-{timestamp}.mss";
            
            var savePath = await DialogService.PickSaveFileAsync("Save Backup", suggestedName, "mss");
            if (!string.IsNullOrEmpty(savePath))
            {
                await File.WriteAllBytesAsync(savePath, encrypted);
                await AlertService.ShowToastAsync("Settings exported successfully!");
                CloseExportDialog();
            }
        }
        catch (Exception ex)
        {
            exportError = $"Export failed: {ex.Message}";
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    private async Task ImportSettings()
    {
        if (string.IsNullOrEmpty(importFilePath) || !File.Exists(importFilePath))
        {
            importError = "Please select a valid backup file";
            return;
        }

        isImporting = true;
        importError = "";
        StateHasChanged();

        try
        {
            var encrypted = await File.ReadAllBytesAsync(importFilePath);
            
            if (!await BackupService.ValidateBackupAsync(encrypted))
            {
                importError = "Invalid backup file format";
                isImporting = false;
                StateHasChanged();
                return;
            }

            var settings = await BackupService.ImportSettingsAsync(encrypted, importPassword);
            
            // Reload all data
            await LoadAppleIdentities();
            await LoadCloudProviders();
            await LoadSecretsPublishers();
            
            await AlertService.ShowToastAsync("Settings imported successfully!");
            CloseImportDialog();
        }
        catch (System.Security.Cryptography.CryptographicException)
        {
            importError = "Incorrect password";
        }
        catch (Exception ex)
        {
            importError = $"Import failed: {ex.Message}";
        }
        finally
        {
            isImporting = false;
            StateHasChanged();
        }
    }
}
