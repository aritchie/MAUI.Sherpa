@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Services
@inject ISimulatorService SimulatorService
@inject SimInspectorService Inspector
@inject IDialogService DialogService
@inject IAlertService AlertService
@inject IFileSystemService FileSystem
@implements IDisposable

<div class="sim-capture-tab">
    <div class="sim-capture-toolbar">
        <button class="btn btn-sm btn-primary" @onclick="TakeScreenshot" disabled="@isCapturing">
            <i class="fas @(isCapturing ? "fa-spinner fa-spin" : "fa-camera")"></i> Screenshot
        </button>
        <button class="btn btn-sm btn-secondary" @onclick="OpenDataFolder" title="Reveal simulator data folder in Finder">
            <i class="fas fa-folder-open"></i> Data Folder
        </button>
    </div>

    <div class="sim-capture-content">
        @if (captures.Count == 0 && !isCapturing)
        {
            <div class="sim-capture-empty">
                <i class="fas fa-camera"></i>
                <span>No captures yet</span>
                <span class="sim-capture-hint">Click "Screenshot" to capture the simulator screen</span>
            </div>
        }
        else
        {
            <div class="sim-capture-grid">
                @foreach (var capture in captures.AsEnumerable().Reverse())
                {
                    <div class="sim-capture-card">
                        <div class="sim-capture-preview" @onclick="@(() => RevealCapture(capture))">
                            <img src="@GetImageDataUri(capture)" alt="Screenshot" />
                        </div>
                        <div class="sim-capture-info">
                            <span class="sim-capture-time">@capture.Timestamp.ToString("HH:mm:ss")</span>
                            <div class="sim-capture-card-actions">
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => SaveCapture(capture))" title="Save as...">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" @onclick="@(() => RevealCapture(capture))" title="Reveal in Finder">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    .sim-capture-tab {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .sim-capture-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .sim-capture-content {
        flex: 1;
        overflow-y: auto;
        padding: 0.75rem;
    }

    .sim-capture-empty {
        text-align: center; padding: 2.5rem 1.25rem;
        color: var(--text-muted); font-size: 0.8125rem;
        display: flex; flex-direction: column; align-items: center; gap: 0.75rem;
    }
    .sim-capture-empty i { font-size: 2rem; }
    .sim-capture-hint { font-size: 0.6875rem; color: var(--text-muted); }

    .sim-capture-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .sim-capture-card {
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        overflow: hidden;
        background: var(--bg-tertiary);
        transition: box-shadow 0.15s;
    }
    .sim-capture-card:hover {
        box-shadow: 0 2px 0.5rem rgba(0,0,0,0.12);
    }

    .sim-capture-preview {
        cursor: pointer;
        aspect-ratio: 9/16;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
    }
    .sim-capture-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .sim-capture-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.375rem 0.5rem;
        border-top: 1px solid var(--border-color);
    }
    .sim-capture-time {
        font-size: 0.6875rem;
        font-family: 'Consolas', 'Monaco', monospace;
        color: var(--text-muted);
    }
    .sim-capture-card-actions {
        display: flex;
        gap: 0.25rem;
    }

    .sim-capture-tab .btn { padding: 0.375rem 0.875rem; border: none; border-radius: 0.3125rem; font-size: 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.3125rem; transition: all 0.15s; }
    .sim-capture-tab .btn i { font-size: 0.6875rem; }
    .sim-capture-tab .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.6875rem; }
    .sim-capture-tab .btn-primary { background: var(--accent-primary); color: white; }
    .sim-capture-tab .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .sim-capture-tab .btn:hover:not(:disabled) { filter: brightness(1.1); }
    .sim-capture-tab .btn:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

@code {
    [Parameter] public string Udid { get; set; } = "";

    private bool isCapturing;
    private List<CaptureEntry> captures = new();

    protected override void OnInitialized()
    {
        Inspector.DeviceChanged += OnDeviceSwitched;
    }

    private async Task TakeScreenshot()
    {
        isCapturing = true;
        StateHasChanged();

        try
        {
            var tempPath = Path.Combine(Path.GetTempPath(), $"sim-screenshot-{DateTime.Now:yyyyMMdd-HHmmss}.png");
            var success = await SimulatorService.TakeScreenshotAsync(Udid, tempPath);

            if (success && File.Exists(tempPath))
            {
                var bytes = await File.ReadAllBytesAsync(tempPath);
                captures.Add(new CaptureEntry(DateTime.Now, tempPath, bytes));
                await AlertService.ShowToastAsync("Screenshot captured");
            }
            else
            {
                await AlertService.ShowToastAsync("Failed to capture screenshot");
            }
        }
        catch (Exception ex)
        {
            await AlertService.ShowToastAsync($"Screenshot error: {ex.Message}");
        }
        finally
        {
            isCapturing = false;
            StateHasChanged();
        }
    }

    private void OpenDataFolder()
    {
        var dataPath = SimulatorService.GetSimulatorDataPath(Udid);
        if (Directory.Exists(dataPath))
            FileSystem.RevealInFileManager(dataPath);
        else
            _ = AlertService.ShowToastAsync("Data folder not found");
    }

    private async Task SaveCapture(CaptureEntry capture)
    {
        var savePath = await DialogService.PickSaveFileAsync("Save Screenshot", "screenshot.png", "png");
        if (string.IsNullOrEmpty(savePath)) return;

        try
        {
            File.Copy(capture.FilePath, savePath, overwrite: true);
            await AlertService.ShowToastAsync("Screenshot saved");
        }
        catch (Exception ex)
        {
            await AlertService.ShowToastAsync($"Save failed: {ex.Message}");
        }
    }

    private void RevealCapture(CaptureEntry capture)
    {
        if (File.Exists(capture.FilePath))
            FileSystem.RevealInFileManager(capture.FilePath);
    }

    private static string GetImageDataUri(CaptureEntry capture)
        => $"data:image/png;base64,{Convert.ToBase64String(capture.Data)}";

    private void OnDeviceSwitched(string newUdid)
    {
        _ = InvokeAsync(() =>
        {
            Udid = newUdid;
            captures.Clear();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Inspector.DeviceChanged -= OnDeviceSwitched;
    }

    private record CaptureEntry(DateTime Timestamp, string FilePath, byte[] Data);
}
