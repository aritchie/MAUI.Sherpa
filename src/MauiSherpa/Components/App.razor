@using Microsoft.AspNetCore.Components.Routing
@using MauiSherpa.Core.Interfaces
@inject IUpdateService UpdateService
@inject ILoggingService Logger

<Router AppAssembly="@typeof(App).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
        <FocusOnNavigate RouteData="@routeData" Selector="h1" />
    </Found>
    <NotFound>
        <PageTitle>Not found</PageTitle>
        <LayoutView Layout="@typeof(MainLayout)">
            <p role="alert">Sorry, there's nothing at this address.</p>
        </LayoutView>
    </NotFound>
</Router>

<UpdateAvailableModal 
    UpdateResult="@_updateCheckResult" 
    IsVisible="@_showUpdateModal"
    OnAccept="@HandleUpdateAccept"
    OnDecline="@HandleUpdateDecline" />

@code {
    private UpdateCheckResult? _updateCheckResult;
    private bool _showUpdateModal;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        // Check for updates after a short delay to not block app startup
        _ = Task.Run(async () =>
        {
            await Task.Delay(2000); // Wait 2 seconds after app starts
            await CheckForUpdatesAsync();
        });
    }

    private async Task CheckForUpdatesAsync()
    {
        try
        {
            _updateCheckResult = await UpdateService.CheckForUpdateAsync();
            
            if (_updateCheckResult.UpdateAvailable)
            {
                _showUpdateModal = true;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError("Failed to check for updates", ex);
        }
    }

    private async Task HandleUpdateAccept()
    {
        if (_updateCheckResult?.LatestRelease?.HtmlUrl != null)
        {
            // Open the release page in the default browser
            try
            {
                await Launcher.OpenAsync(new Uri(_updateCheckResult.LatestRelease.HtmlUrl));
            }
            catch (Exception ex)
            {
                Logger.LogError("Failed to open release URL", ex);
            }
        }
        
        _showUpdateModal = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleUpdateDecline()
    {
        _showUpdateModal = false;
        await InvokeAsync(StateHasChanged);
    }
}

