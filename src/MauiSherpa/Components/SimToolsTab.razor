@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Services
@using MauiSherpa.Services
@inject ISimulatorService SimulatorService
@inject SimInspectorService Inspector
@inject IAlertService AlertService
@inject IDialogService DialogService
@implements IDisposable

<div class="sim-tools-tab">
    <!-- Push Notifications -->
    <div class="tool-section">
        <div class="tool-header">
            <i class="fas fa-bell"></i>
            <span>Push Notification</span>
        </div>
        <div class="tool-body">
            <div class="tool-row">
                <label>Bundle ID</label>
                <input type="text" class="tool-input" @bind="pushBundleId" placeholder="com.example.app" />
            </div>
            <div class="tool-row">
                <label>Payload (JSON)</label>
                <textarea class="tool-textarea" @bind="pushPayload" rows="5" placeholder='{"aps":{"alert":"Hello!"}}'></textarea>
            </div>
            <div class="tool-actions">
                <button class="btn btn-sm btn-primary" @onclick="SendPush" disabled="@(isSendingPush || string.IsNullOrWhiteSpace(pushBundleId))">
                    <i class="fas @(isSendingPush ? "fa-spinner fa-spin" : "fa-paper-plane")"></i> Send
                </button>
            </div>
        </div>
    </div>

    <!-- Location Simulation -->
    <div class="tool-section">
        <div class="tool-header">
            <i class="fas fa-map-marker-alt"></i>
            <span>Location Simulation</span>
        </div>
        <div class="tool-body">
            <div class="tool-row-inline">
                <div class="tool-field">
                    <label>Latitude</label>
                    <input type="number" step="0.000001" class="tool-input" @bind="locationLat" placeholder="37.3349" />
                </div>
                <div class="tool-field">
                    <label>Longitude</label>
                    <input type="number" step="0.000001" class="tool-input" @bind="locationLon" placeholder="-122.0090" />
                </div>
            </div>
            <div class="tool-presets">
                <button class="btn btn-sm btn-ghost" @onclick='@(() => SetPresetLocation("Cupertino", 37.3349, -122.0090))'>Cupertino</button>
                <button class="btn btn-sm btn-ghost" @onclick='@(() => SetPresetLocation("New York", 40.7128, -74.0060))'>New York</button>
                <button class="btn btn-sm btn-ghost" @onclick='@(() => SetPresetLocation("London", 51.5074, -0.1278))'>London</button>
                <button class="btn btn-sm btn-ghost" @onclick='@(() => SetPresetLocation("Tokyo", 35.6762, 139.6503))'>Tokyo</button>
                <button class="btn btn-sm btn-ghost" @onclick='@(() => SetPresetLocation("Sydney", -33.8688, 151.2093))'>Sydney</button>
            </div>
            <div class="tool-actions">
                <button class="btn btn-sm btn-primary" @onclick="SetLocation" disabled="@isSettingLocation">
                    <i class="fas @(isSettingLocation ? "fa-spinner fa-spin" : "fa-location-arrow")"></i> Set
                </button>
                <button class="btn btn-sm btn-secondary" @onclick="ClearLocation" disabled="@isSettingLocation">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>

            <!-- KML/GPX Route Playback -->
            <div class="tool-divider"></div>
            <div class="tool-row">
                <label>Route Playback (KML/GPX)</label>
                <div class="tool-route-row">
                    <button class="btn btn-sm btn-secondary" @onclick="PickRouteFile" disabled="@SimulatorService.IsPlayingRoute">
                        <i class="fas fa-file-upload"></i> Load File
                    </button>
                    @if (routeFileName != null)
                    {
                        <span class="route-file-name" title="@routeFileName">@routeFileName (@routeWaypoints?.Count pts)</span>
                    }
                </div>
            </div>
            @if (routeWaypoints?.Count > 0)
            {
                <div class="tool-row-inline">
                    <div class="tool-field">
                        <label>Speed (m/s)</label>
                        <input type="number" min="1" max="500" class="tool-input" @bind="routeSpeed" />
                    </div>
                    <div class="tool-field route-actions">
                        <label>&nbsp;</label>
                        @if (SimulatorService.IsPlayingRoute)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="StopRoute">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-sm btn-success" @onclick="PlayRoute">
                                <i class="fas fa-play"></i> Play
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Status Bar Overrides -->
    <div class="tool-section">
        <div class="tool-header">
            <i class="fas fa-signal"></i>
            <span>Status Bar Override</span>
        </div>
        <div class="tool-body">
            <div class="tool-row-inline">
                <div class="tool-field">
                    <label>Time</label>
                    <input type="text" class="tool-input" @bind="statusTime" placeholder="9:41" />
                </div>
                <div class="tool-field">
                    <label>Network</label>
                    <select class="tool-input" @bind="statusNetwork">
                        <option value="">Default</option>
                        <option value="wifi">WiFi</option>
                        <option value="5g">5G</option>
                        <option value="5g+">5G+</option>
                        <option value="lte">LTE</option>
                        <option value="4g">4G</option>
                        <option value="3g">3G</option>
                        <option value="hide">Hide</option>
                    </select>
                </div>
            </div>
            <div class="tool-row-inline">
                <div class="tool-field">
                    <label>Battery %</label>
                    <input type="number" min="0" max="100" class="tool-input" @bind="statusBattery" placeholder="100" />
                </div>
                <div class="tool-field">
                    <label>Battery State</label>
                    <select class="tool-input" @bind="statusBatteryState">
                        <option value="">Default</option>
                        <option value="charged">Charged</option>
                        <option value="charging">Charging</option>
                        <option value="discharging">Discharging</option>
                    </select>
                </div>
            </div>
            <div class="tool-row-inline">
                <div class="tool-field">
                    <label>WiFi Bars</label>
                    <select class="tool-input" @bind="statusWifiBars">
                        <option value="">Default</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>
                <div class="tool-field">
                    <label>Cell Bars</label>
                    <select class="tool-input" @bind="statusCellBars">
                        <option value="">Default</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>
            <div class="tool-actions">
                <button class="btn btn-sm btn-primary" @onclick="ApplyStatusBar" disabled="@isApplyingStatus">
                    <i class="fas @(isApplyingStatus ? "fa-spinner fa-spin" : "fa-check")"></i> Apply
                </button>
                <button class="btn btn-sm btn-secondary" @onclick="ClearStatusBar" disabled="@isApplyingStatus">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .sim-tools-tab {
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow-y: auto;
        padding: 0.5rem;
        gap: 0.5rem;
    }
    .sim-tools-tab .tool-section { flex-shrink: 0; }
    .sim-tools-tab .btn { padding: 0.375rem 0.875rem; border: none; border-radius: 0.3125rem; font-size: 0.75rem; cursor: pointer; display: inline-flex; align-items: center; gap: 0.3125rem; transition: all 0.15s; }
    .sim-tools-tab .btn i { font-size: 0.6875rem; }
    .sim-tools-tab .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.6875rem; }
    .sim-tools-tab .btn-primary { background: var(--accent-primary); color: white; }
    .sim-tools-tab .btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .sim-tools-tab .btn-success { background: #22c55e; color: white; }
    .sim-tools-tab .btn-danger { background: #ef4444; color: white; }
    .sim-tools-tab .btn-ghost { background: transparent; color: var(--accent-primary); border: 1px solid var(--border-color); font-size: 0.625rem; padding: 2px 0.375rem; }
    .sim-tools-tab .btn-ghost:hover { background: var(--bg-tertiary); }
    .sim-tools-tab .btn:hover:not(:disabled) { filter: brightness(1.1); }
    .sim-tools-tab .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .tool-section {
        background: var(--bg-secondary, #fff);
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .tool-header {
        display: flex; align-items: center; gap: 0.375rem;
        padding: 0.375rem 0.625rem;
        background: var(--bg-tertiary, #edf2f7);
        font-size: 0.75rem; font-weight: 600;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color, #e2e8f0);
    }
    .tool-header i { font-size: 0.6875rem; color: var(--text-secondary); }
    .tool-body { padding: 0.5rem 0.625rem; display: flex; flex-direction: column; gap: 0.375rem; }

    .tool-row { display: flex; flex-direction: column; gap: 2px; }
    .tool-row label { font-size: 0.6875rem; color: var(--text-secondary); font-weight: 500; }

    .tool-row-inline { display: flex; gap: 0.5rem; }
    .tool-field { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .tool-field label { font-size: 0.6875rem; color: var(--text-secondary); font-weight: 500; }

    .tool-input {
        padding: 0.25rem 0.5rem; font-size: 0.75rem;
        border: 1px solid var(--border-color); border-radius: 0.25rem;
        background: var(--bg-primary, #fff); color: var(--text-primary);
        outline: none; width: 100%; box-sizing: border-box;
    }
    .tool-input:focus { border-color: var(--accent-primary); }

    .tool-textarea {
        padding: 0.25rem 0.5rem; font-size: 0.6875rem; font-family: 'Consolas', 'Monaco', monospace;
        border: 1px solid var(--border-color); border-radius: 0.25rem;
        background: var(--bg-primary, #fff); color: var(--text-primary);
        outline: none; resize: vertical; width: 100%; box-sizing: border-box;
    }
    .tool-textarea:focus { border-color: var(--accent-primary); }

    .tool-actions { display: flex; gap: 0.25rem; margin-top: 2px; }
    .tool-presets { display: flex; flex-wrap: wrap; gap: 0.25rem; }
    .tool-divider { border-top: 1px solid var(--border-color); margin: 0.25rem 0; }
    .tool-route-row { display: flex; align-items: center; gap: 0.5rem; }
    .route-file-name { font-size: 0.6875rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 180px; }
    .route-actions { display: flex; align-items: flex-end; }
</style>

@code {
    [Parameter] public string Udid { get; set; } = "";

    // Push
    private string pushBundleId = "";
    private string pushPayload = "{\n  \"aps\": {\n    \"alert\": {\n      \"title\": \"Test\",\n      \"body\": \"Hello from MAUI Sherpa!\"\n    },\n    \"sound\": \"default\"\n  }\n}";
    private bool isSendingPush;

    // Location
    private double locationLat = 37.3349;
    private double locationLon = -122.0090;
    private bool isSettingLocation;

    // Route
    private string? routeFileName;
    private IReadOnlyList<RouteWaypoint>? routeWaypoints;
    private double routeSpeed = 20;

    // Status bar
    private string statusTime = "";
    private string statusNetwork = "";
    private int? statusBattery;
    private string statusBatteryState = "";
    private string statusWifiBars = "";
    private string statusCellBars = "";
    private bool isApplyingStatus;

    private IDisposable? _sub;

    protected override void OnInitialized()
    {
        Inspector.DeviceChanged += OnDeviceChanged;
        SimulatorService.RoutePlaybackStateChanged += OnRouteStateChanged;
    }

    private void OnDeviceChanged(string udid)
    {
        Udid = udid;
        InvokeAsync(StateHasChanged);
    }

    private async Task SendPush()
    {
        if (string.IsNullOrWhiteSpace(Udid) || string.IsNullOrWhiteSpace(pushBundleId)) return;
        isSendingPush = true;
        StateHasChanged();
        try
        {
            var payload = string.IsNullOrWhiteSpace(pushPayload)
                ? "{\"aps\":{\"alert\":\"Test\"}}"
                : pushPayload;
            var ok = await SimulatorService.SendPushNotificationAsync(Udid, pushBundleId, payload);
            await AlertService.ShowToastAsync(ok ? "Push notification sent" : "Failed to send push");
        }
        finally
        {
            isSendingPush = false;
            StateHasChanged();
        }
    }

    private void SetPresetLocation(string name, double lat, double lon)
    {
        locationLat = lat;
        locationLon = lon;
        StateHasChanged();
    }

    private async Task SetLocation()
    {
        if (string.IsNullOrWhiteSpace(Udid)) return;
        isSettingLocation = true;
        StateHasChanged();
        try
        {
            var ok = await SimulatorService.SetLocationAsync(Udid, locationLat, locationLon);
            await AlertService.ShowToastAsync(ok ? $"Location set to {locationLat}, {locationLon}" : "Failed to set location");
        }
        finally
        {
            isSettingLocation = false;
            StateHasChanged();
        }
    }

    private async Task ClearLocation()
    {
        if (string.IsNullOrWhiteSpace(Udid)) return;
        isSettingLocation = true;
        StateHasChanged();
        try
        {
            var ok = await SimulatorService.ClearLocationAsync(Udid);
            await AlertService.ShowToastAsync(ok ? "Location cleared" : "Failed to clear location");
        }
        finally
        {
            isSettingLocation = false;
            StateHasChanged();
        }
    }

    private async Task PickRouteFile()
    {
        var path = await DialogService.PickOpenFileAsync("Select KML or GPX file", new[] { ".kml", ".gpx" });
        if (string.IsNullOrEmpty(path)) return;
        try
        {
            routeWaypoints = KmlRouteParser.ParseFile(path);
            routeFileName = Path.GetFileName(path);
            await AlertService.ShowToastAsync($"Loaded {routeWaypoints.Count} waypoints from {routeFileName}");
        }
        catch (Exception ex)
        {
            await AlertService.ShowToastAsync($"Failed to parse file: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task PlayRoute()
    {
        if (string.IsNullOrWhiteSpace(Udid) || routeWaypoints == null) return;
        var ok = await SimulatorService.StartRoutePlaybackAsync(Udid, routeWaypoints, routeSpeed);
        if (!ok) await AlertService.ShowToastAsync("Failed to start route playback");
    }

    private void StopRoute() => SimulatorService.StopRoutePlayback();

    private void OnRouteStateChanged() => InvokeAsync(StateHasChanged);

    private async Task ApplyStatusBar()
    {
        if (string.IsNullOrWhiteSpace(Udid)) return;
        isApplyingStatus = true;
        StateHasChanged();
        try
        {
            var overrides = new StatusBarOverride(
                Time: string.IsNullOrWhiteSpace(statusTime) ? null : statusTime,
                DataNetwork: string.IsNullOrWhiteSpace(statusNetwork) ? null : statusNetwork,
                WifiBars: int.TryParse(statusWifiBars, out var wb) ? wb : null,
                CellularBars: int.TryParse(statusCellBars, out var cb) ? cb : null,
                BatteryLevel: statusBattery,
                BatteryState: string.IsNullOrWhiteSpace(statusBatteryState) ? null : statusBatteryState
            );
            var ok = await SimulatorService.OverrideStatusBarAsync(Udid, overrides);
            await AlertService.ShowToastAsync(ok ? "Status bar updated" : "No overrides specified");
        }
        finally
        {
            isApplyingStatus = false;
            StateHasChanged();
        }
    }

    private async Task ClearStatusBar()
    {
        if (string.IsNullOrWhiteSpace(Udid)) return;
        isApplyingStatus = true;
        StateHasChanged();
        try
        {
            var ok = await SimulatorService.ClearStatusBarAsync(Udid);
            await AlertService.ShowToastAsync(ok ? "Status bar cleared" : "Failed to clear status bar");
        }
        finally
        {
            isApplyingStatus = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        Inspector.DeviceChanged -= OnDeviceChanged;
        SimulatorService.RoutePlaybackStateChanged -= OnRouteStateChanged;
    }
}
