@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Requests.Apple
@using MauiSherpa.Core.Requests.Publisher
@using Shiny.Mediator
@inject IAppleConnectService AppleService
@inject IAppleIdentityStateService IdentityState
@inject ILocalCertificateService LocalCertService
@inject IAlertService AlertService
@inject IDialogService DialogService
@inject ILoggingService Logger
@inject NavigationManager Navigation
@inject ISecretsPublisherService SecretsPublisherService
@inject ISecretsPublisherFactory SecretsPublisherFactory
@inject IMediator Mediator

@if (IsVisible)
{
    <div class="dialog-overlay" @onclick="HandleOverlayClick">
        <div class="wizard-dialog" @onclick:stopPropagation="true">
            <div class="dialog-header">
                <h2><i class="fas fa-key"></i> CI Secrets Wizard</h2>
                <button class="close-btn" @onclick="Close"><i class="fas fa-times"></i></button>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                @for (int i = 1; i <= TotalSteps; i++)
                {
                    var step = i;
                    <div class="step @(currentStep >= step ? "active" : "") @(currentStep > step ? "completed" : "")">
                        <div class="step-number">@(currentStep > step ? "✓" : step.ToString())</div>
                        <div class="step-label">@GetStepLabel(step)</div>
                    </div>
                    @if (i < TotalSteps)
                    {
                        <div class="step-line @(currentStep > step ? "active" : "")"></div>
                    }
                }
            </div>

            <div class="dialog-body">
                @if (isLoading)
                {
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>@loadingMessage</span>
                    </div>
                }
                else
                {
                    @switch (currentStep)
                    {
                        case 1:
                            RenderPlatformStep();
                            break;
                        case 2:
                            RenderDistributionStep();
                            break;
                        case 3:
                            @if (ShowInstallerStep)
                            {
                                RenderInstallerStep();
                            }
                            else
                            {
                                RenderResourcesStep();
                            }
                            break;
                        case 4:
                            @if (ShowInstallerStep)
                            {
                                RenderResourcesStep();
                            }
                            else
                            {
                                RenderExportStep();
                            }
                            break;
                        case 5:
                            RenderExportStep();
                            break;
                    }
                }
            </div>

            <div class="dialog-footer">
                @if (currentStep > 1)
                {
                    <button class="btn btn-secondary" @onclick="PreviousStep" disabled="@isLoading">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                }
                <div class="spacer"></div>
                <button class="btn btn-outline" @onclick="Close" disabled="@isLoading">Cancel</button>
                @if (currentStep < TotalSteps)
                {
                    <button class="btn btn-primary" @onclick="NextStep" disabled="@(!CanProceed || isLoading)">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="CopyAllSecrets" disabled="@isLoading">
                        <i class="fas fa-copy"></i> Copy All Secrets
                    </button>
                }
            </div>
        </div>
    </div>
    
    @* Publish to CI/CD Modal *@
    @if (showPublishModal)
    {
        <div class="dialog-overlay publish-overlay" @onclick="ClosePublishModal">
            <div class="publish-dialog" @onclick:stopPropagation="true">
                <div class="dialog-header">
                    <h2><i class="fas fa-rocket"></i> Publish to CI/CD</h2>
                    <button class="close-btn" @onclick="ClosePublishModal"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="dialog-body">
                    @if (publishStep == 1)
                    {
                        @* Step 1: Select Provider *@
                        <div class="publish-step">
                            <h3>Select CI/CD Provider</h3>
                            <p class="step-description">Choose where to publish your secrets.</p>
                            
                            @if (isLoadingPublishers)
                            {
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading providers...</span>
                                </div>
                            }
                            else if (configuredPublishers.Count == 0)
                            {
                                <div class="empty-state">
                                    <i class="fas fa-plug"></i>
                                    <p>No CI/CD publishers configured.</p>
                                    <p class="help-text">Add a CI/CD publisher in Settings first.</p>
                                    <button class="btn btn-primary" @onclick="GoToSettings">
                                        <i class="fas fa-cog"></i> Open Settings
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="provider-selection">
                                    @foreach (var publisher in configuredPublishers)
                                    {
                                        <div class="provider-option @(selectedPublisher?.Id == publisher.Id ? "selected" : "")"
                                             @onclick="@(() => SelectPublisher(publisher))">
                                            <i class="@GetPublisherIcon(publisher.ProviderId) provider-icon"></i>
                                            <div class="provider-info">
                                                <span class="provider-name">@publisher.Name</span>
                                                <span class="provider-type">@GetPublisherDisplayName(publisher.ProviderId)</span>
                                            </div>
                                            @if (selectedPublisher?.Id == publisher.Id)
                                            {
                                                <i class="fas fa-check-circle selected-icon"></i>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else if (publishStep == 2)
                    {
                        @* Step 2: Select Repository *@
                        <div class="publish-step">
                            <h3>Select Repository</h3>
                            <p class="step-description">Choose the repository to publish secrets to.</p>
                            
                            <div class="repo-search">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Search repositories..." 
                                       @bind="repoSearchFilter" 
                                       @bind:event="oninput"
                                       @onkeyup="OnRepoSearchKeyUp" />
                            </div>
                            
                            @if (isLoadingRepos)
                            {
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading repositories...</span>
                                </div>
                            }
                            else if (filteredRepositories.Count == 0)
                            {
                                <div class="empty-state">
                                    <i class="fas fa-folder-open"></i>
                                    <p>No repositories found.</p>
                                </div>
                            }
                            else
                            {
                                <div class="repo-list">
                                    @foreach (var repo in filteredRepositories)
                                    {
                                        <div class="repo-option @(selectedRepository?.Id == repo.Id ? "selected" : "")"
                                             @onclick="@(() => SelectRepository(repo))">
                                            <i class="fas fa-code-branch repo-icon"></i>
                                            <div class="repo-info">
                                                <span class="repo-name">@repo.FullName</span>
                                                @if (!string.IsNullOrEmpty(repo.Description))
                                                {
                                                    <span class="repo-desc">@TruncateDescription(repo.Description)</span>
                                                }
                                            </div>
                                            @if (selectedRepository?.Id == repo.Id)
                                            {
                                                <i class="fas fa-check-circle selected-icon"></i>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else if (publishStep == 3)
                    {
                        @* Step 3: Select Secrets *@
                        <div class="publish-step">
                            <h3>Select Secrets to Publish</h3>
                            <p class="step-description">Choose which secrets to publish to @selectedRepository?.FullName.</p>
                            
                            <div class="select-all-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" 
                                           checked="@AreAllSecretsSelected" 
                                           @onchange="ToggleAllSecrets" />
                                    <span>Select All</span>
                                </label>
                                <span class="selected-count">@selectedSecretNames.Count of @exportedSecrets.Count selected</span>
                            </div>
                            
                            <div class="secrets-selection">
                                @foreach (var secret in exportedSecrets)
                                {
                                    <label class="secret-checkbox @(selectedSecretNames.Contains(secret.Name) ? "selected" : "")">
                                        <input type="checkbox" 
                                               checked="@selectedSecretNames.Contains(secret.Name)"
                                               @onchange="@(() => ToggleSecret(secret.Name))" />
                                        <div class="secret-info">
                                            <code class="secret-name">@secret.Name</code>
                                            <span class="secret-desc">@secret.Description</span>
                                        </div>
                                    </label>
                                }
                            </div>
                        </div>
                    }
                    else if (publishStep == 4)
                    {
                        @* Step 4: Confirm & Publish *@
                        <div class="publish-step">
                            @if (isPublishing)
                            {
                                <div class="publishing-progress">
                                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                                    <h3>Publishing Secrets...</h3>
                                    <p>@publishingStatus</p>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @publishingProgress%"></div>
                                    </div>
                                </div>
                            }
                            else if (publishComplete)
                            {
                                <div class="publish-success">
                                    <i class="fas fa-check-circle fa-3x text-success"></i>
                                    <h3>Secrets Published Successfully!</h3>
                                    <p>@selectedSecretNames.Count secrets were published to @selectedRepository?.FullName.</p>
                                </div>
                            }
                            else
                            {
                                <h3>Confirm Publication</h3>
                                <p class="step-description">Review and confirm the secrets to be published.</p>
                                
                                <div class="publish-summary">
                                    <div class="summary-item">
                                        <span class="summary-label">Provider:</span>
                                        <span class="summary-value">
                                            <i class="@GetPublisherIcon(selectedPublisher?.ProviderId ?? "")"></i>
                                            @selectedPublisher?.Name
                                        </span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Repository:</span>
                                        <span class="summary-value">@selectedRepository?.FullName</span>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">Secrets:</span>
                                        <span class="summary-value">@selectedSecretNames.Count secrets</span>
                                    </div>
                                </div>
                                
                                <div class="secrets-preview">
                                    @foreach (var name in selectedSecretNames)
                                    {
                                        <code class="secret-badge">@name</code>
                                    }
                                </div>
                                
                                <div class="warning-box">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>This will overwrite any existing secrets with the same names.</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                
                <div class="dialog-footer">
                    @if (publishStep > 1 && !isPublishing && !publishComplete)
                    {
                        <button class="btn btn-secondary" @onclick="PreviousPublishStep">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    }
                    <div class="spacer"></div>
                    <button class="btn btn-outline" @onclick="ClosePublishModal">
                        @(publishComplete ? "Done" : "Cancel")
                    </button>
                    @if (!publishComplete && !isPublishing)
                    {
                        @if (publishStep < 4)
                        {
                            <button class="btn btn-primary" @onclick="NextPublishStep" disabled="@(!CanProceedPublish)">
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success" @onclick="ExecutePublish">
                                <i class="fas fa-rocket"></i> Publish Secrets
                            </button>
                        }
                    }
                </div>
            </div>
        </div>
    }
}

@* Step 1: Platform Selection *@
@{ void RenderPlatformStep() {
    <div class="step-content">
        <h3>Select Platform</h3>
        <p class="step-description">Which platform are you building for?</p>

        <div class="option-cards">
            <label class="option-card @(wizardState.Platform == ApplePlatformType.iOS ? "selected" : "")">
                <input type="radio" name="platform" 
                       checked="@(wizardState.Platform == ApplePlatformType.iOS)"
                       @onchange="@(() => SelectPlatform(ApplePlatformType.iOS))" />
                <i class="fab fa-apple"></i>
                <div class="option-title">iOS</div>
                <div class="option-desc">iPhone & iPad apps</div>
            </label>
            
            <label class="option-card @(wizardState.Platform == ApplePlatformType.MacCatalyst ? "selected" : "")">
                <input type="radio" name="platform"
                       checked="@(wizardState.Platform == ApplePlatformType.MacCatalyst)"
                       @onchange="@(() => SelectPlatform(ApplePlatformType.MacCatalyst))" />
                <i class="fas fa-layer-group"></i>
                <div class="option-title">Mac Catalyst</div>
                <div class="option-desc">iPad apps running on Mac</div>
            </label>
            
            <label class="option-card @(wizardState.Platform == ApplePlatformType.macOS ? "selected" : "")">
                <input type="radio" name="platform"
                       checked="@(wizardState.Platform == ApplePlatformType.macOS)"
                       @onchange="@(() => SelectPlatform(ApplePlatformType.macOS))" />
                <i class="fas fa-laptop"></i>
                <div class="option-title">macOS</div>
                <div class="option-desc">Native Mac apps</div>
            </label>
        </div>
    </div>
}}

@* Step 2: Distribution Type *@
@{ void RenderDistributionStep() {
    <div class="step-content">
        <h3>Select Distribution Type</h3>
        <p class="step-description">How will you distribute your app?</p>

        <div class="option-list">
            @foreach (var dist in GetAvailableDistributionTypes())
            {
                <label class="option-item @(wizardState.Distribution == dist.Type ? "selected" : "")">
                    <input type="radio" name="distribution"
                           checked="@(wizardState.Distribution == dist.Type)"
                           @onchange="@(() => SelectDistribution(dist.Type))" />
                    <div class="option-content">
                        <div class="option-title">@dist.Name</div>
                        <div class="option-desc">@dist.Description</div>
                    </div>
                </label>
            }
        </div>
    </div>
}}

@* Step 3: Installer Certificate (Mac only) *@
@{ void RenderInstallerStep() {
    <div class="step-content">
        <h3>Installer Package</h3>
        <p class="step-description">Do you need to create a signed installer package (.pkg)?</p>

        <div class="option-list">
            <label class="option-item @(wizardState.NeedsInstallerCert ? "selected" : "")">
                <input type="radio" name="installer" value="yes"
                       checked="@wizardState.NeedsInstallerCert"
                       @onchange="@(() => SetNeedsInstaller(true))" />
                <div class="option-content">
                    <div class="option-title">Yes - Create .pkg installer</div>
                    <div class="option-desc">Requires a Developer ID Installer certificate</div>
                </div>
            </label>
            
            <label class="option-item @(!wizardState.NeedsInstallerCert ? "selected" : "")">
                <input type="radio" name="installer" value="no"
                       checked="@(!wizardState.NeedsInstallerCert)"
                       @onchange="@(() => SetNeedsInstaller(false))" />
                <div class="option-content">
                    <div class="option-title">No - Just the signed app bundle</div>
                    <div class="option-desc">Distribute as .app or .zip</div>
                </div>
            </label>
        </div>
    </div>
}}

@* Step 4: Resource Validation *@
@{ void RenderResourcesStep() {
    <div class="step-content">
        <h3>Required Resources</h3>
        <p class="step-description">Select the resources for your CI pipeline.</p>

        <!-- Bundle ID -->
        <div class="resource-section">
            <div class="resource-header">
                <i class="fas fa-cube"></i>
                <span>Bundle ID</span>
                @if (wizardState.SelectedBundleId != null)
                {
                    <span class="badge badge-success"><i class="fas fa-check"></i></span>
                }
            </div>
            @if (bundleIds.Any())
            {
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" @bind="bundleIdSearch" @bind:event="oninput" placeholder="Search bundle IDs..." />
                    @if (!string.IsNullOrEmpty(bundleIdSearch))
                    {
                        <button class="clear-search" @onclick="@(() => bundleIdSearch = "")">×</button>
                    }
                </div>
                <div class="selection-list">
                    @foreach (var bundle in FilteredBundleIds)
                    {
                        <label class="selection-item @(wizardState.SelectedBundleId?.Id == bundle.Id ? "selected" : "")">
                            <input type="radio" name="bundleId" value="@bundle.Id"
                                   checked="@(wizardState.SelectedBundleId?.Id == bundle.Id)"
                                   @onchange="@(() => SelectBundleId(bundle))" />
                            <div class="item-content">
                                <div class="item-name">@bundle.Name</div>
                                <div class="item-detail">@bundle.Identifier</div>
                                <span class="platform-badge">@bundle.Platform</span>
                            </div>
                        </label>
                    }
                    @if (!FilteredBundleIds.Any())
                    {
                        <div class="empty-list">
                            <i class="fas fa-inbox"></i>
                            <span>No matching bundle IDs</span>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="resource-missing">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>No bundle IDs found.</span>
                    <button class="btn btn-sm btn-link" @onclick="@(() => NavigateTo("/bundleids"))">
                        Create Bundle ID →
                    </button>
                </div>
            }
        </div>

        <!-- Signing Certificate -->
        <div class="resource-section">
            <div class="resource-header">
                <i class="fas fa-certificate"></i>
                <span>@GetSigningCertLabel()</span>
                @if (wizardState.SigningCertificate != null && HasPrivateKey(wizardState.SigningCertificate))
                {
                    <span class="badge badge-success"><i class="fas fa-check"></i></span>
                }
                else if (wizardState.SigningCertificate != null)
                {
                    <span class="badge badge-warning" title="No private key found locally">
                        <i class="fas fa-key"></i> Missing Key
                    </span>
                }
            </div>
            @if (FilteredSigningCerts.Any())
            {
                <div class="cert-list">
                    @foreach (var cert in FilteredSigningCerts)
                    {
                        var hasKey = HasPrivateKey(cert);
                        <label class="cert-item @(wizardState.SigningCertificate?.Id == cert.Id ? "selected" : "") @(!hasKey ? "no-key" : "")">
                            <input type="radio" name="signingCert"
                                   checked="@(wizardState.SigningCertificate?.Id == cert.Id)"
                                   @onchange="@(() => SelectSigningCert(cert))" />
                            <div class="cert-info">
                                <div class="cert-name">@cert.Name</div>
                                <div class="cert-detail">
                                    <span>@cert.CertificateType</span>
                                    <span>Expires: @cert.ExpirationDate.ToString("MMM dd, yyyy")</span>
                                </div>
                            </div>
                            @if (hasKey)
                            {
                                <span class="key-status has-key" title="Private key available"><i class="fas fa-key"></i></span>
                            }
                            else
                            {
                                <span class="key-status no-key" title="No private key - cannot export"><i class="fas fa-key"></i></span>
                            }
                        </label>
                    }
                </div>
            }
            else
            {
                <div class="resource-missing">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>No @GetSigningCertLabel().ToLower() found.</span>
                    <button class="btn btn-sm btn-link" @onclick="@(() => NavigateTo("/certificates"))">
                        Create Certificate →
                    </button>
                </div>
            }
        </div>

        <!-- Installer Certificate (if needed) -->
        @if (wizardState.NeedsInstallerCert)
        {
            <div class="resource-section">
                <div class="resource-header">
                    <i class="fas fa-box"></i>
                    <span>Developer ID Installer Certificate</span>
                    @if (wizardState.InstallerCertificate != null && HasPrivateKey(wizardState.InstallerCertificate))
                    {
                        <span class="badge badge-success"><i class="fas fa-check"></i></span>
                    }
                </div>
                @if (InstallerCerts.Any())
                {
                    <div class="cert-list">
                        @foreach (var cert in InstallerCerts)
                        {
                            var hasKey = HasPrivateKey(cert);
                            <label class="cert-item @(wizardState.InstallerCertificate?.Id == cert.Id ? "selected" : "") @(!hasKey ? "no-key" : "")">
                                <input type="radio" name="installerCert"
                                       checked="@(wizardState.InstallerCertificate?.Id == cert.Id)"
                                       @onchange="@(() => SelectInstallerCert(cert))" />
                                <div class="cert-info">
                                    <div class="cert-name">@cert.Name</div>
                                    <div class="cert-detail">Expires: @cert.ExpirationDate.ToString("MMM dd, yyyy")</div>
                                </div>
                                @if (hasKey)
                                {
                                    <span class="key-status has-key"><i class="fas fa-key"></i></span>
                                }
                                else
                                {
                                    <span class="key-status no-key"><i class="fas fa-key"></i></span>
                                }
                            </label>
                        }
                    </div>
                }
                else
                {
                    <div class="resource-missing">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>No Developer ID Installer certificate found.</span>
                        <button class="btn btn-sm btn-link" @onclick="@(() => NavigateTo("/certificates"))">
                            Create Certificate →
                        </button>
                    </div>
                }
            </div>
        }

        <!-- Provisioning Profile -->
        @if (NeedsProvisioningProfile)
        {
            <div class="resource-section">
                <div class="resource-header">
                    <i class="fas fa-file-signature"></i>
                    <span>Provisioning Profile</span>
                    @if (wizardState.ProvisioningProfile != null)
                    {
                        <span class="badge badge-success"><i class="fas fa-check"></i></span>
                    }
                </div>
                @if (FilteredProfiles.Any())
                {
                    <select class="form-select" @onchange="OnProfileChanged">
                        <option value="">Select a profile...</option>
                        @foreach (var profile in FilteredProfiles)
                        {
                            <option value="@profile.Id" selected="@(wizardState.ProvisioningProfile?.Id == profile.Id)">
                                @profile.Name (@profile.ProfileType)
                            </option>
                        }
                    </select>
                }
                else
                {
                    <div class="resource-missing">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>No matching provisioning profile found.</span>
                        <button class="btn btn-sm btn-link" @onclick="@(() => NavigateTo("/profiles"))">
                            Create Profile →
                        </button>
                    </div>
                }
            </div>
        }

        <!-- Notarization (for Direct Distribution) -->
        @if (NeedsNotarization)
        {
            <div class="resource-section">
                <div class="resource-header">
                    <i class="fas fa-stamp"></i>
                    <span>Notarization Credentials</span>
                </div>
                <div class="form-group">
                    <label>Apple ID</label>
                    <input type="email" class="form-input" placeholder="your@email.com"
                           value="@wizardState.NotarizationAppleId"
                           @onchange="@(e => UpdateNotarization(appleId: e.Value?.ToString()))" />
                </div>
                <div class="form-group">
                    <label>App-Specific Password</label>
                    <input type="password" class="form-input" placeholder="xxxx-xxxx-xxxx-xxxx"
                           value="@wizardState.NotarizationPassword"
                           @onchange="@(e => UpdateNotarization(password: e.Value?.ToString()))" />
                    <small class="form-hint">
                        Generate at <a href="#" @onclick:preventDefault @onclick='() => OpenUrl("https://appleid.apple.com/account/manage")'>appleid.apple.com</a>
                    </small>
                </div>
            </div>
        }

        <!-- P12 Export Password -->
        <div class="resource-section">
            <div class="resource-header">
                <i class="fas fa-key"></i>
                <span>Certificate Export Password</span>
            </div>
            <div class="form-group">
                <label>P12 Password</label>
                <input type="password" class="form-input" placeholder="Enter a strong password"
                       value="@p12ExportPassword"
                       @onchange="@(e => p12ExportPassword = e.Value?.ToString() ?? "")" />
                <small class="form-hint">
                    This password will protect your exported certificate. You'll need it in your CI pipeline.
                </small>
            </div>
        </div>
    </div>
}}

@* Step 5: Export Secrets *@
@{ void RenderExportStep() {
    <div class="step-content">
        <h3>Export CI Secrets</h3>
        <p class="step-description">Copy these secrets to your CI pipeline configuration (e.g., GitHub Actions).</p>

        @if (!string.IsNullOrEmpty(exportError))
        {
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                @exportError
            </div>
        }

        <div class="secrets-list">
            @foreach (var secret in exportedSecrets)
            {
                <div class="secret-card">
                    <div class="secret-header">
                        <code class="secret-name">@secret.Name</code>
                        <button class="btn btn-sm btn-outline" @onclick="@(() => CopySecret(secret))">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="secret-desc">@secret.Description</div>
                    @if (!secret.IsSensitive)
                    {
                        <div class="secret-value">
                            <code>@TruncateValue(secret.Value)</code>
                        </div>
                    }
                    else
                    {
                        <div class="secret-value sensitive">
                            <code>••••••••••••••••</code>
                            <span class="sensitive-label">(sensitive)</span>
                        </div>
                    }
                </div>
            }
        </div>

        @if (exportedSecrets.Any())
        {
            <div class="export-actions">
                <button class="btn btn-secondary" @onclick="DownloadEnvFile">
                    <i class="fas fa-download"></i> Download .env file
                </button>
            </div>
            
            <!-- Build Command Section -->
            <div class="build-command-section">
                <h4><i class="fas fa-terminal"></i> Build Command</h4>
                <p class="section-description">Use these commands to build and sign your app in CI. Set the environment variables above, then run:</p>
                
                <div class="shell-tabs">
                    <button class="shell-tab @(selectedShell == "bash" ? "active" : "")" @onclick="@(() => selectedShell = "bash")">
                        <i class="fas fa-terminal"></i> Bash
                    </button>
                    <button class="shell-tab @(selectedShell == "powershell" ? "active" : "")" @onclick="@(() => selectedShell = "powershell")">
                        <i class="fas fa-window-maximize"></i> PowerShell
                    </button>
                    <button class="shell-tab @(selectedShell == "github" ? "active" : "")" @onclick="@(() => selectedShell = "github")">
                        <i class="fab fa-github"></i> GitHub Actions
                    </button>
                </div>
                
                <div class="command-block">
                    <div class="command-header">
                        <span class="command-label">@GetShellLabel()</span>
                        <button class="btn btn-sm btn-outline" @onclick="CopyBuildCommand">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <pre class="command-code"><code>@GetBuildCommand()</code></pre>
                </div>
                
                @if (selectedShell == "github")
                {
                    <div class="github-secrets-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>Add these as <a href="#" @onclick:preventDefault @onclick='() => OpenUrl("https://docs.github.com/en/actions/security-guides/encrypted-secrets")'>GitHub Secrets</a> in your repository settings.</span>
                    </div>
                }
            </div>
            
            <!-- Publish to CI/CD Section -->
            <div class="publish-section">
                <h4><i class="fas fa-rocket"></i> Publish to CI/CD</h4>
                <p class="section-description">Automatically publish these secrets to your CI/CD provider.</p>
                <button class="btn btn-success" @onclick="ShowPublishFlow">
                    <i class="fas fa-cloud-upload-alt"></i> Publish to CI/CD Provider
                </button>
            </div>
        }
    </div>
}}

<style>
    .wizard-dialog {
        background: var(--bg-primary, white);
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 700px;
        width: 95%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .dialog-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .dialog-header {
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color, #e2e8f0);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .dialog-header h2 {
        margin: 0;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--text-muted, #718096);
        padding: 4px 8px;
        border-radius: 4px;
    }

    .close-btn:hover { background: var(--bg-hover, #f7fafc); }

    .step-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: var(--bg-secondary, #f7fafc);
        gap: 8px;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .step-number {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--bg-tertiary, #e2e8f0);
        color: var(--text-muted, #718096);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
    }

    .step.active .step-number {
        background: #8b5cf6;
        color: white;
    }

    .step.completed .step-number {
        background: #10b981;
        color: white;
    }

    .step-label {
        font-size: 11px;
        color: var(--text-muted, #718096);
    }

    .step.active .step-label { color: var(--text-primary, #1a202c); font-weight: 500; }

    .step-line {
        width: 40px;
        height: 2px;
        background: var(--bg-tertiary, #e2e8f0);
        margin-bottom: 20px;
    }

    .step-line.active { background: #10b981; }

    .dialog-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .dialog-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border-color, #e2e8f0);
        display: flex;
        gap: 12px;
    }

    .spacer { flex: 1; }

    .step-content h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
    }

    .step-description {
        color: var(--text-muted, #718096);
        margin-bottom: 20px;
        font-size: 14px;
    }

    /* Option Cards (Platform selection) */
    .option-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .option-card {
        border: 2px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.15s;
    }

    .option-card:hover { border-color: #8b5cf6; }
    .option-card.selected { border-color: #8b5cf6; background: #faf5ff; }
    .option-card input { display: none; }
    .option-card i { font-size: 32px; color: #8b5cf6; margin-bottom: 12px; }
    .option-title { font-weight: 600; margin-bottom: 4px; }
    .option-desc { font-size: 12px; color: var(--text-muted, #718096); }

    /* Option List (Distribution selection) */
    .option-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .option-item {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 14px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .option-item:hover { border-color: #8b5cf6; }
    .option-item.selected { border-color: #8b5cf6; background: #faf5ff; }
    .option-item input[type="radio"] { margin-top: 3px; accent-color: #8b5cf6; }
    .option-content { flex: 1; }
    .option-content .option-title { font-weight: 500; margin-bottom: 2px; }
    .option-content .option-desc { font-size: 13px; color: var(--text-muted, #718096); }

    /* Resource Sections */
    .resource-section {
        margin-bottom: 20px;
        padding: 16px;
        background: var(--bg-secondary, #f7fafc);
        border-radius: 8px;
    }

    .resource-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        font-weight: 600;
    }

    .resource-header i { color: #8b5cf6; }

    .resource-missing {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #fef3c7;
        border-radius: 6px;
        color: #92400e;
        font-size: 13px;
    }

    .resource-missing i { color: #f59e0b; }

    /* Search Box - scoped to wizard */
    .wizard-dialog .search-box {
        display: flex;
        align-items: center;
        position: relative;
        padding: 8px 12px 8px 36px;
        background: white;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        margin-bottom: 10px;
    }
    
    .wizard-dialog .search-box:focus-within {
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
    }

    .wizard-dialog .search-box i.fa-search { 
        position: absolute;
        left: 12px;
        color: var(--text-muted, #718096); 
        font-size: 14px; 
    }
    .wizard-dialog .search-box input {
        flex: 1;
        border: none;
        outline: none !important;
        -webkit-appearance: none;
        font-size: 14px;
        background: transparent;
        padding: 0;
        margin: 0;
        line-height: 1.4;
        min-width: 0;
        width: 100%;
    }
    
    .wizard-dialog .search-box input:focus {
        outline: none !important;
        box-shadow: none !important;
    }
    
    .wizard-dialog .search-box input::placeholder {
        color: var(--text-muted, #a0aec0);
    }
    
    .wizard-dialog .clear-search {
        background: none;
        border: none;
        font-size: 18px;
        color: var(--text-muted, #718096);
        cursor: pointer;
        padding: 0 4px;
        line-height: 1;
    }
    .wizard-dialog .clear-search:hover { color: var(--text-primary, #1a202c); }

    /* Selection List (Bundle IDs) */
    .wizard-dialog .selection-list {
        max-height: 200px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .wizard-dialog .selection-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        background: white;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .wizard-dialog .selection-item:hover { border-color: #8b5cf6; }
    .wizard-dialog .selection-item.selected { border-color: #8b5cf6; background: #faf5ff; }
    .wizard-dialog .selection-item input[type="radio"] { margin-top: 2px; accent-color: #8b5cf6; }

    .wizard-dialog .item-content { flex: 1; }
    .wizard-dialog .item-name { font-weight: 500; font-size: 14px; color: var(--text-primary, #1a202c); }
    .wizard-dialog .item-detail { font-size: 12px; color: var(--text-muted, #718096); margin-top: 2px; font-family: monospace; }
    
    .wizard-dialog .platform-badge {
        display: inline-block;
        margin-top: 6px;
        padding: 2px 8px;
        background: var(--bg-tertiary, #e2e8f0);
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        color: var(--text-muted, #718096);
    }

    .wizard-dialog .empty-list {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 24px;
        color: var(--text-muted, #718096);
        font-size: 13px;
    }
    .empty-list i { font-size: 24px; opacity: 0.5; }

    .form-select, .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        font-size: 14px;
        background: white;
    }

    .form-group {
        margin-bottom: 12px;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .form-hint {
        font-size: 12px;
        color: var(--text-muted, #718096);
        margin-top: 4px;
    }

    /* Certificate List */
    .cert-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .cert-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: white;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        cursor: pointer;
    }

    .cert-item:hover { border-color: #8b5cf6; }
    .cert-item.selected { border-color: #8b5cf6; background: #faf5ff; }
    .cert-item.no-key { opacity: 0.6; }
    .cert-item input { accent-color: #8b5cf6; }
    .cert-info { flex: 1; }
    .cert-name { font-weight: 500; font-size: 14px; }
    .cert-detail { font-size: 12px; color: var(--text-muted, #718096); display: flex; gap: 12px; }

    .key-status {
        font-size: 14px;
        padding: 4px;
    }
    .key-status.has-key { color: #10b981; }
    .key-status.no-key { color: #ef4444; }

    /* Secrets Export */
    .secrets-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .secret-card {
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        padding: 14px;
    }

    .secret-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .secret-name {
        font-weight: 600;
        color: #8b5cf6;
        font-size: 13px;
    }

    .secret-desc {
        font-size: 12px;
        color: var(--text-muted, #718096);
        margin-bottom: 8px;
    }

    .secret-value {
        background: var(--bg-secondary, #f7fafc);
        padding: 8px 10px;
        border-radius: 4px;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .secret-value.sensitive {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sensitive-label {
        font-size: 11px;
        color: var(--text-muted, #718096);
    }

    .export-actions {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color, #e2e8f0);
    }

    /* Build Command Section */
    .build-command-section {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color, #e2e8f0);
    }

    .build-command-section h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-primary);
    }

    .build-command-section .section-description {
        color: var(--text-muted);
        font-size: 13px;
        margin-bottom: 16px;
    }

    .shell-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        background: var(--bg-tertiary, #e2e8f0);
        padding: 4px;
        border-radius: 8px;
        width: fit-content;
    }

    .shell-tab {
        padding: 8px 14px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.15s;
    }

    .shell-tab:hover {
        color: var(--text-primary);
    }

    .shell-tab.active {
        background: var(--bg-primary, white);
        color: var(--text-primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .command-block {
        background: #1e1e2e;
        border-radius: 8px;
        overflow: hidden;
    }

    .command-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: rgba(255,255,255,0.05);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .command-label {
        color: #a6adc8;
        font-size: 12px;
        font-weight: 500;
    }

    .command-header .btn {
        background: rgba(255,255,255,0.1);
        color: #cdd6f4;
        border: none;
        font-size: 12px;
        padding: 4px 10px;
    }

    .command-header .btn:hover {
        background: rgba(255,255,255,0.2);
    }

    .command-code {
        margin: 0;
        padding: 14px 16px;
        font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
        font-size: 12px;
        line-height: 1.6;
        color: #cdd6f4;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-x: auto;
        max-height: 300px;
        overflow-y: auto;
    }

    .command-code code {
        font-family: inherit;
    }

    .github-secrets-hint {
        margin-top: 12px;
        padding: 10px 14px;
        background: #eff6ff;
        border-radius: 6px;
        font-size: 13px;
        color: #1e40af;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .github-secrets-hint a {
        color: #2563eb;
        text-decoration: underline;
    }

    .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .loading-state {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 40px;
        color: var(--text-muted, #718096);
    }

    .badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
    }
    .badge-success { background: #d1fae5; color: #047857; }
    .badge-warning { background: #fef3c7; color: #92400e; }

    /* Buttons */
    .btn { 
        padding: 10px 16px; 
        border-radius: 6px; 
        font-size: 14px; 
        font-weight: 500; 
        cursor: pointer; 
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #8b5cf6; color: white; }
    .btn-primary:hover:not(:disabled) { background: #7c3aed; }
    .btn-secondary { background: var(--bg-tertiary, #e2e8f0); color: var(--text-primary, #1a202c); }
    .btn-secondary:hover:not(:disabled) { background: var(--bg-hover, #cbd5e1); }
    .btn-outline { background: transparent; border: 1px solid var(--border-color, #e2e8f0); }
    .btn-outline:hover:not(:disabled) { background: var(--bg-hover, #f7fafc); }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .btn-link { background: none; border: none; color: #8b5cf6; padding: 0; }
    .btn-link:hover { text-decoration: underline; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover:not(:disabled) { background: #059669; }
    
    /* Publish Section */
    .publish-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color, #e2e8f0);
    }
    .publish-section h4 {
        margin: 0 0 8px 0;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .publish-section .section-description {
        margin: 0 0 16px 0;
        color: var(--text-muted, #718096);
        font-size: 14px;
    }
    
    /* Publish Modal */
    .publish-overlay { z-index: 1100; }
    .publish-dialog {
        background: var(--card-bg, white);
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 600px;
        width: 95%;
        max-height: 85vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }
    .publish-step { padding: 8px 0; }
    .publish-step h3 { margin: 0 0 8px 0; font-size: 18px; }
    
    /* Provider Selection */
    .provider-selection { display: flex; flex-direction: column; gap: 8px; }
    .provider-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        cursor: pointer;
        background: var(--bg-tertiary, #f7fafc);
        transition: all 0.15s;
    }
    .provider-option:hover { border-color: #8b5cf6; background: var(--bg-hover, #f0f0f0); }
    .provider-option.selected {
        border-color: #8b5cf6;
        background: var(--accent-bg, #faf5ff);
    }
    .provider-option .provider-icon { font-size: 24px; color: #8b5cf6; width: 32px; text-align: center; }
    .provider-option .provider-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
    .provider-option .provider-name { font-weight: 600; color: var(--text-primary, #1a202c); }
    .provider-option .provider-type { font-size: 12px; color: var(--text-muted, #718096); }
    .provider-option .selected-icon { color: #8b5cf6; }
    
    /* Repository Selection */
    .repo-search {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 8px;
        background: var(--input-bg, white);
        margin-bottom: 12px;
    }
    .repo-search i { color: var(--text-muted, #718096); }
    .repo-search input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        background: transparent;
        color: var(--text-primary, #1a202c);
    }
    .repo-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 300px;
        overflow-y: auto;
    }
    .repo-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        cursor: pointer;
        background: var(--bg-tertiary, #f7fafc);
        transition: all 0.15s;
    }
    .repo-option:hover { border-color: #8b5cf6; }
    .repo-option.selected { border-color: #8b5cf6; background: var(--accent-bg, #faf5ff); }
    .repo-option .repo-icon { color: var(--text-muted, #718096); }
    .repo-option .repo-info { flex: 1; min-width: 0; }
    .repo-option .repo-name { font-weight: 500; color: var(--text-primary, #1a202c); display: block; }
    .repo-option .repo-desc { 
        font-size: 12px; 
        color: var(--text-muted, #718096); 
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .repo-option .selected-icon { color: #8b5cf6; }
    
    /* Secrets Selection */
    .select-all-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-tertiary, #f7fafc);
        border-radius: 6px;
        margin-bottom: 12px;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
    }
    .selected-count { font-size: 13px; color: var(--text-muted, #718096); }
    .secrets-selection {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 280px;
        overflow-y: auto;
    }
    .secret-checkbox {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #e2e8f0);
        border-radius: 6px;
        cursor: pointer;
        background: var(--bg-tertiary, #f7fafc);
        transition: all 0.15s;
    }
    .secret-checkbox:hover { border-color: #8b5cf6; }
    .secret-checkbox.selected { border-color: #8b5cf6; background: var(--accent-bg, #faf5ff); }
    .secret-checkbox .secret-info { flex: 1; }
    .secret-checkbox .secret-name { font-family: monospace; font-size: 13px; font-weight: 600; color: var(--text-primary, #1a202c); }
    .secret-checkbox .secret-desc { font-size: 12px; color: var(--text-muted, #718096); display: block; margin-top: 2px; }
    
    /* Publish Summary */
    .publish-summary {
        background: var(--bg-tertiary, #f7fafc);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
    }
    .summary-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
    }
    .summary-item:not(:last-child) { border-bottom: 1px solid var(--border-color, #e2e8f0); }
    .summary-label { font-weight: 600; color: var(--text-muted, #718096); min-width: 100px; }
    .summary-value { color: var(--text-primary, #1a202c); display: flex; align-items: center; gap: 6px; }
    .secrets-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 16px;
    }
    .secret-badge {
        background: var(--bg-tertiary, #e2e8f0);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-primary, #1a202c);
    }
    .warning-box {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        color: #92400e;
        font-size: 14px;
    }
    
    /* Publishing Progress */
    .publishing-progress {
        text-align: center;
        padding: 40px 20px;
    }
    .publishing-progress h3 { margin: 16px 0 8px 0; }
    .publishing-progress p { color: var(--text-muted, #718096); margin-bottom: 20px; }
    .progress-bar {
        height: 8px;
        background: var(--bg-tertiary, #e2e8f0);
        border-radius: 4px;
        overflow: hidden;
        max-width: 300px;
        margin: 0 auto;
    }
    .progress-fill {
        height: 100%;
        background: #8b5cf6;
        transition: width 0.3s ease;
    }
    
    /* Publish Success */
    .publish-success {
        text-align: center;
        padding: 40px 20px;
    }
    .publish-success h3 { margin: 16px 0 8px 0; color: #10b981; }
    .publish-success p { color: var(--text-muted, #718096); }
    .text-success { color: #10b981; }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted, #718096);
    }
    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state p { margin: 8px 0; }
    .empty-state .help-text { font-size: 14px; }

    /* Dark mode overrides */
    .theme-dark .option-card.selected { background: rgba(139, 92, 246, 0.15); }
    .theme-dark .option-item.selected { background: rgba(139, 92, 246, 0.15); }

    .theme-dark .resource-missing { background: var(--status-warning-bg, #744210); color: var(--status-warning-text, #fbd38d); }

    .theme-dark .wizard-dialog .selection-item { background: var(--bg-secondary, #2d3748); }
    .theme-dark .wizard-dialog .selection-item.selected { background: rgba(139, 92, 246, 0.15); }

    .theme-dark .form-select,
    .theme-dark .form-input { background: var(--input-bg, #374151); color: var(--text-primary, #e2e8f0); }

    .theme-dark .cert-item { background: var(--bg-secondary, #2d3748); }
    .theme-dark .cert-item.selected { background: rgba(139, 92, 246, 0.15); }

    .theme-dark .badge-success { background: var(--status-success-bg, #276749); color: var(--status-success-text, #9ae6b4); }
    .theme-dark .badge-warning { background: var(--status-warning-bg, #744210); color: var(--status-warning-text, #fbd38d); }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    private async Task OpenUrl(string url)
    {
        await Launcher.Default.OpenAsync(new Uri(url));
    }

    private int currentStep = 1;
    private bool isLoading = false;
    private string loadingMessage = "Loading...";
    private string exportError = "";

    private CISecretsWizardState wizardState = new()
    {
        Platform = ApplePlatformType.iOS,
        Distribution = AppleDistributionType.Development
    };

    // Data
    private List<AppleBundleId> bundleIds = new();
    private List<AppleCertificate> certificates = new();
    private List<AppleProfile> profiles = new();
    private List<LocalSigningIdentity> localIdentities = new();
    private List<CISecretExport> exportedSecrets = new();
    private IReadOnlyList<string> recentBundleIds = Array.Empty<string>();
    
    // Build command shell selection
    private string selectedShell = "bash";
    
    // P12 export password
    private string p12ExportPassword = "";
    
    // Search/filter
    private string bundleIdSearch = "";
    
    // Publish flow state
    private bool showPublishModal = false;
    private int publishStep = 1;
    private bool isLoadingPublishers = false;
    private bool isLoadingRepos = false;
    private bool isPublishing = false;
    private bool publishComplete = false;
    private string publishingStatus = "";
    private int publishingProgress = 0;
    private string repoSearchFilter = "";
    private List<SecretsPublisherConfig> configuredPublishers = new();
    private List<PublisherRepository> allRepositories = new();
    private SecretsPublisherConfig? selectedPublisher = null;
    private PublisherRepository? selectedRepository = null;
    private HashSet<string> selectedSecretNames = new();

    private int TotalSteps => ShowInstallerStep ? 5 : 4;
    
    private bool ShowInstallerStep => 
        wizardState.Distribution == AppleDistributionType.Direct &&
        (wizardState.Platform == ApplePlatformType.MacCatalyst || wizardState.Platform == ApplePlatformType.macOS);

    private bool NeedsProvisioningProfile =>
        !(wizardState.Platform == ApplePlatformType.macOS && wizardState.Distribution == AppleDistributionType.Direct);

    private bool NeedsNotarization =>
        wizardState.Distribution == AppleDistributionType.Direct;

    private bool CanProceed => currentStep switch
    {
        1 => true, // Platform always selected
        2 => true, // Distribution always selected
        3 => ShowInstallerStep ? true : ValidateResourcesStep(), // Either installer choice or resources
        4 => ShowInstallerStep ? ValidateResourcesStep() : true, // Resources or Export
        _ => true
    };

    private bool ValidateResourcesStep()
    {
        if (wizardState.SelectedBundleId == null) return false;
        if (wizardState.SigningCertificate == null || !HasPrivateKey(wizardState.SigningCertificate)) return false;
        if (wizardState.NeedsInstallerCert && (wizardState.InstallerCertificate == null || !HasPrivateKey(wizardState.InstallerCertificate))) return false;
        if (NeedsProvisioningProfile && wizardState.ProvisioningProfile == null) return false;
        return true;
    }
    
    private IEnumerable<AppleBundleId> FilteredBundleIds => bundleIds
        .Where(b => string.IsNullOrEmpty(bundleIdSearch) || 
                    b.Name.Contains(bundleIdSearch, StringComparison.OrdinalIgnoreCase) ||
                    b.Identifier.Contains(bundleIdSearch, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(b => GetBundleIdRecencyScore(b.Identifier))
        .ThenBy(b => b.Name);
    
    private int GetBundleIdRecencyScore(string identifier)
    {
        var index = recentBundleIds.ToList().IndexOf(identifier);
        // Return higher score for more recent items (lower index = more recent)
        // -1 means not in recent list, give it lowest priority
        return index == -1 ? int.MinValue : -index;
    }

    private string GetStepLabel(int step)
    {
        if (ShowInstallerStep)
        {
            return step switch
            {
                1 => "Platform",
                2 => "Distribution",
                3 => "Installer",
                4 => "Resources",
                5 => "Export",
                _ => ""
            };
        }
        else
        {
            return step switch
            {
                1 => "Platform",
                2 => "Distribution",
                3 => "Resources",
                4 => "Export",
                _ => ""
            };
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsVisible && bundleIds.Count == 0)
        {
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        if (IdentityState.SelectedIdentity == null) return;

        isLoading = true;
        loadingMessage = "Loading resources...";
        
        try
        {
            var identityId = IdentityState.SelectedIdentity?.Id ?? "";
            
            // Use mediator for all cached Apple data
            var bundleTask = Mediator.Request(new GetBundleIdsRequest(identityId));
            var certTask = Mediator.Request(new GetCertificatesRequest(identityId));
            var profileTask = Mediator.Request(new GetProfilesRequest(identityId));
            var identityTask = LocalCertService.GetSigningIdentitiesAsync();
            var recentBundleTask = Mediator.Request(new GetRecentBundleIdsRequest(identityId));

            await Task.WhenAll(bundleTask, certTask, profileTask, identityTask, recentBundleTask);

            bundleIds = (await bundleTask).Result.ToList();
            certificates = (await certTask).Result.ToList();
            profiles = (await profileTask).Result.ToList();
            localIdentities = (await identityTask).ToList();
            recentBundleIds = (await recentBundleTask).Result;

            Logger.LogInformation($"Loaded {bundleIds.Count} bundle IDs, {certificates.Count} certs, {profiles.Count} profiles, {localIdentities.Count} local identities, {recentBundleIds.Count} recent bundle IDs");
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load data: {ex.Message}", ex);
            await AlertService.ShowAlertAsync("Error", $"Failed to load data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private IEnumerable<AppleCertificate> FilteredSigningCerts => certificates
        .Where(c => IsSigningCertCompatible(c.CertificateType))
        .Where(c => c.ExpirationDate > DateTime.UtcNow)
        .OrderByDescending(c => HasPrivateKey(c))
        .ThenBy(c => c.Name);

    private IEnumerable<AppleCertificate> InstallerCerts => certificates
        .Where(c => c.CertificateType.Contains("INSTALLER", StringComparison.OrdinalIgnoreCase))
        .Where(c => c.ExpirationDate > DateTime.UtcNow)
        .OrderByDescending(c => HasPrivateKey(c))
        .ThenBy(c => c.Name);

    private IEnumerable<AppleProfile> FilteredProfiles => profiles
        .Where(p => IsProfileCompatible(p.ProfileType))
        .Where(p => p.State == "ACTIVE")
        .OrderBy(p => p.Name);

    private bool IsSigningCertCompatible(string certType)
    {
        var ct = certType.ToUpperInvariant();
        
        return wizardState.Distribution switch
        {
            AppleDistributionType.Development => ct.Contains("DEVELOPMENT"),
            AppleDistributionType.AdHoc => ct.Contains("DISTRIBUTION") && !ct.Contains("DEVELOPER_ID"),
            AppleDistributionType.AppStore => ct.Contains("DISTRIBUTION") && !ct.Contains("DEVELOPER_ID"),
            AppleDistributionType.Direct => ct.Contains("DEVELOPER_ID_APPLICATION"),
            _ => false
        };
    }

    private bool IsProfileCompatible(string profileType)
    {
        var pt = profileType.ToUpperInvariant();
        
        // Check platform
        var platformMatch = wizardState.Platform switch
        {
            ApplePlatformType.iOS => pt.StartsWith("IOS_"),
            ApplePlatformType.MacCatalyst => pt.StartsWith("MAC_CATALYST_"),
            ApplePlatformType.macOS => pt.StartsWith("MAC_APP_"),
            _ => false
        };
        
        if (!platformMatch) return false;
        
        // Check distribution type
        return wizardState.Distribution switch
        {
            AppleDistributionType.Development => pt.Contains("DEVELOPMENT"),
            AppleDistributionType.AdHoc => pt.Contains("ADHOC"),
            AppleDistributionType.AppStore => pt.Contains("STORE"),
            AppleDistributionType.Direct => pt.Contains("DIRECT"),
            _ => false
        };
    }

    private bool HasPrivateKey(AppleCertificate cert)
    {
        // Check if any local identity matches this certificate
        return localIdentities.Any(li =>
            (li.SerialNumber != null && li.SerialNumber.Equals(cert.SerialNumber, StringComparison.OrdinalIgnoreCase)) ||
            li.CommonName.Contains(cert.Name, StringComparison.OrdinalIgnoreCase) ||
            cert.Name.Contains(li.CommonName, StringComparison.OrdinalIgnoreCase));
    }

    private string GetSigningCertLabel() => wizardState.Distribution switch
    {
        AppleDistributionType.Development => "Development Certificate",
        AppleDistributionType.AdHoc => "Distribution Certificate",
        AppleDistributionType.AppStore => "Distribution Certificate",
        AppleDistributionType.Direct => "Developer ID Application Certificate",
        _ => "Signing Certificate"
    };

    private IEnumerable<(AppleDistributionType Type, string Name, string Description)> GetAvailableDistributionTypes()
    {
        yield return (AppleDistributionType.Development, "Development", "Build and test on registered devices");
        
        if (wizardState.Platform == ApplePlatformType.iOS)
        {
            yield return (AppleDistributionType.AdHoc, "Ad Hoc", "Distribute to specific registered devices");
        }
        
        yield return (AppleDistributionType.AppStore, "App Store / TestFlight", "Submit to the App Store or TestFlight");
        
        if (wizardState.Platform != ApplePlatformType.iOS)
        {
            yield return (AppleDistributionType.Direct, "Direct Distribution", "Distribute outside the App Store (notarized)");
        }
    }

    // Event handlers
    private void SelectPlatform(ApplePlatformType platform)
    {
        wizardState = wizardState with 
        { 
            Platform = platform,
            Distribution = AppleDistributionType.Development, // Reset
            SigningCertificate = null,
            ProvisioningProfile = null
        };
    }

    private void SelectDistribution(AppleDistributionType dist)
    {
        wizardState = wizardState with 
        { 
            Distribution = dist,
            SigningCertificate = null,
            ProvisioningProfile = null,
            NeedsInstallerCert = false
        };
    }

    private void SetNeedsInstaller(bool needs)
    {
        wizardState = wizardState with { NeedsInstallerCert = needs };
    }

    private async void SelectBundleId(AppleBundleId bundle)
    {
        wizardState = wizardState with { SelectedBundleId = bundle };
        
        // Track usage for sorting by recency (per identity)
        var identityId = IdentityState.SelectedIdentity?.Id ?? "";
        await Mediator.Send(new TrackBundleIdUsageRequest(identityId, bundle.Identifier));
    }

    private void SelectSigningCert(AppleCertificate cert)
    {
        wizardState = wizardState with { SigningCertificate = cert };
    }

    private void SelectInstallerCert(AppleCertificate cert)
    {
        wizardState = wizardState with { InstallerCertificate = cert };
    }

    private void OnProfileChanged(ChangeEventArgs e)
    {
        var id = e.Value?.ToString();
        wizardState = wizardState with 
        { 
            ProvisioningProfile = profiles.FirstOrDefault(p => p.Id == id) 
        };
    }

    private void UpdateNotarization(string? appleId = null, string? password = null)
    {
        wizardState = wizardState with
        {
            NotarizationAppleId = appleId ?? wizardState.NotarizationAppleId,
            NotarizationPassword = password ?? wizardState.NotarizationPassword
        };
    }

    private async Task NextStep()
    {
        currentStep++;

        if (currentStep == TotalSteps)
        {
            await GenerateSecrets();
        }
    }

    private void PreviousStep()
    {
        currentStep--;
    }

    private async Task GenerateSecrets()
    {
        isLoading = true;
        loadingMessage = "Generating secrets...";
        exportError = "";
        exportedSecrets.Clear();

        try
        {
            // TODO: Implement P12 export
            // For now, show placeholder secrets
            
            var teamId = IdentityState.SelectedIdentity?.IssuerId ?? "TEAM_ID";
            var exportPassword = string.IsNullOrEmpty(p12ExportPassword) ? "changeit" : p12ExportPassword;
            
            // Export signing certificate P12
            if (wizardState.SigningCertificate != null)
            {
                var signingIdentity = FindMatchingIdentity(wizardState.SigningCertificate);
                if (signingIdentity != null)
                {
                    try
                    {
                        loadingMessage = "Exporting signing certificate...";
                        StateHasChanged();
                        
                        var p12Data = await LocalCertService.ExportP12Async(signingIdentity.Identity, exportPassword);
                        var p12Base64 = Convert.ToBase64String(p12Data);
                        
                        exportedSecrets.Add(new CISecretExport(
                            "APPLE_CERTIFICATE_P12",
                            p12Base64,
                            $"Base64-encoded signing certificate ({wizardState.SigningCertificate.Name})",
                            true
                        ));
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError($"Failed to export signing certificate: {ex.Message}", ex);
                        exportedSecrets.Add(new CISecretExport(
                            "APPLE_CERTIFICATE_P12",
                            $"[Export failed: {ex.Message}]",
                            $"Base64-encoded signing certificate ({wizardState.SigningCertificate.Name})",
                            true
                        ));
                    }
                }
                else
                {
                    exportedSecrets.Add(new CISecretExport(
                        "APPLE_CERTIFICATE_P12",
                        "[No matching local identity found]",
                        $"Base64-encoded signing certificate ({wizardState.SigningCertificate.Name})",
                        true
                    ));
                }
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_CERTIFICATE_PASSWORD",
                    exportPassword,
                    "Password for the P12 certificate",
                    true
                ));
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_CODESIGN_IDENTITY",
                    signingIdentity?.Identity ?? wizardState.SigningCertificate.Name,
                    "Code signing identity name",
                    false
                ));
            }
            
            // Export installer certificate P12
            if (wizardState.NeedsInstallerCert && wizardState.InstallerCertificate != null)
            {
                var installerIdentity = FindMatchingIdentity(wizardState.InstallerCertificate);
                if (installerIdentity != null)
                {
                    try
                    {
                        loadingMessage = "Exporting installer certificate...";
                        StateHasChanged();
                        
                        var p12Data = await LocalCertService.ExportP12Async(installerIdentity.Identity, exportPassword);
                        var p12Base64 = Convert.ToBase64String(p12Data);
                        
                        exportedSecrets.Add(new CISecretExport(
                            "APPLE_INSTALLER_CERTIFICATE_P12",
                            p12Base64,
                            $"Base64-encoded installer certificate ({wizardState.InstallerCertificate.Name})",
                            true
                        ));
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError($"Failed to export installer certificate: {ex.Message}", ex);
                        exportedSecrets.Add(new CISecretExport(
                            "APPLE_INSTALLER_CERTIFICATE_P12",
                            $"[Export failed: {ex.Message}]",
                            $"Base64-encoded installer certificate ({wizardState.InstallerCertificate.Name})",
                            true
                        ));
                    }
                }
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_INSTALLER_CERTIFICATE_PASSWORD",
                    exportPassword,
                    "Password for the installer P12 certificate",
                    true
                ));
            }
            
            if (NeedsProvisioningProfile && wizardState.ProvisioningProfile != null)
            {
                loadingMessage = "Downloading provisioning profile...";
                StateHasChanged();
                
                // Download and base64 encode the profile
                var profileData = await AppleService.DownloadProfileAsync(wizardState.ProvisioningProfile.Id);
                var profileBase64 = Convert.ToBase64String(profileData);
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_PROVISIONING_PROFILE",
                    profileBase64,
                    $"Base64-encoded provisioning profile ({wizardState.ProvisioningProfile.Name})",
                    true
                ));
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_PROVISIONING_PROFILE_NAME",
                    wizardState.ProvisioningProfile.Name,
                    "Provisioning profile name",
                    false
                ));
            }
            
            if (NeedsNotarization)
            {
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_NOTARIZATION_APPLE_ID",
                    wizardState.NotarizationAppleId ?? "",
                    "Apple ID for notarization",
                    false
                ));
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_NOTARIZATION_PASSWORD",
                    wizardState.NotarizationPassword ?? "",
                    "App-specific password for notarization",
                    true
                ));
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_NOTARIZATION_TEAM_ID",
                    teamId,
                    "Team ID for notarization",
                    false
                ));
            }
            
            // API Key (optional but useful)
            if (IdentityState.SelectedIdentity != null)
            {
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_API_KEY_ID",
                    IdentityState.SelectedIdentity.KeyId,
                    "App Store Connect API Key ID",
                    false
                ));
                
                exportedSecrets.Add(new CISecretExport(
                    "APPLE_API_ISSUER_ID",
                    IdentityState.SelectedIdentity.IssuerId,
                    "App Store Connect API Issuer ID",
                    false
                ));
            }
        }
        catch (Exception ex)
        {
            exportError = $"Failed to generate secrets: {ex.Message}";
            Logger.LogError(exportError, ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private LocalSigningIdentity? FindMatchingIdentity(AppleCertificate cert)
    {
        return localIdentities.FirstOrDefault(li =>
            (li.SerialNumber != null && li.SerialNumber.Equals(cert.SerialNumber, StringComparison.OrdinalIgnoreCase)) ||
            li.CommonName.Contains(cert.Name, StringComparison.OrdinalIgnoreCase) ||
            cert.Name.Contains(li.CommonName, StringComparison.OrdinalIgnoreCase));
    }

    private async Task CopySecret(CISecretExport secret)
    {
        await DialogService.CopyToClipboardAsync(secret.Value);
        await AlertService.ShowToastAsync($"Copied {secret.Name} to clipboard");
    }

    private async Task CopyAllSecrets()
    {
        var allSecrets = string.Join("\n", exportedSecrets.Select(s => $"{s.Name}={s.Value}"));
        await DialogService.CopyToClipboardAsync(allSecrets);
        await AlertService.ShowToastAsync("Copied all secrets to clipboard");
    }

    private async Task DownloadEnvFile()
    {
        try
        {
            var content = string.Join("\n", exportedSecrets.Select(s => $"{s.Name}=\"{s.Value}\""));
            var downloadsFolder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.UserProfile), "Downloads");
            var filePath = Path.Combine(downloadsFolder, "apple-ci-secrets.env");
            
            await File.WriteAllTextAsync(filePath, content);
            await AlertService.ShowToastAsync($"Saved to {Path.GetFileName(filePath)}");
        }
        catch (Exception ex)
        {
            await AlertService.ShowAlertAsync("Error", $"Failed to save file: {ex.Message}");
        }
    }

    private string TruncateValue(string value)
    {
        if (value.Length <= 60) return value;
        return value.Substring(0, 57) + "...";
    }

    private void NavigateTo(string path)
    {
        Navigation.NavigateTo(path);
        _ = Close();
    }

    private void HandleOverlayClick()
    {
        // Don't close on overlay click during loading
        if (!isLoading)
        {
            _ = Close();
        }
    }

    private async Task Close()
    {
        IsVisible = false;
        await IsVisibleChanged.InvokeAsync(false);
        
        // Reset state
        currentStep = 1;
        exportedSecrets.Clear();
        exportError = "";
        selectedShell = "bash";
        p12ExportPassword = "";
    }

    private string GetShellLabel() => selectedShell switch
    {
        "bash" => "Bash / macOS Terminal",
        "powershell" => "PowerShell",
        "github" => "GitHub Actions Workflow",
        _ => "Shell"
    };

    private string GetBuildCommand()
    {
        var tfm = GetTargetFramework();
        var props = GetMSBuildProperties();
        
        return selectedShell switch
        {
            "bash" => GenerateBashCommand(tfm, props),
            "powershell" => GeneratePowerShellCommand(tfm, props),
            "github" => GenerateGitHubActionsCommand(tfm, props),
            _ => ""
        };
    }

    private string GetTargetFramework() => wizardState.Platform switch
    {
        ApplePlatformType.iOS => "net9.0-ios",
        ApplePlatformType.MacCatalyst => "net9.0-maccatalyst",
        ApplePlatformType.macOS => "net9.0-macos",
        _ => "net9.0-ios"
    };

    private List<(string Property, string EnvVar, string Description)> GetMSBuildProperties()
    {
        var props = new List<(string Property, string EnvVar, string Description)>();
        
        // Code signing identity
        if (exportedSecrets.Any(s => s.Name == "APPLE_CODESIGN_IDENTITY"))
        {
            props.Add(("CodesignKey", "APPLE_CODESIGN_IDENTITY", "Signing identity"));
        }
        
        // Provisioning profile
        if (exportedSecrets.Any(s => s.Name == "APPLE_PROVISIONING_PROFILE_NAME"))
        {
            props.Add(("CodesignProvision", "APPLE_PROVISIONING_PROFILE_NAME", "Provisioning profile"));
        }
        
        // Archive on build for iOS/Mac Catalyst
        if (wizardState.Platform is ApplePlatformType.iOS or ApplePlatformType.MacCatalyst)
        {
            props.Add(("ArchiveOnBuild", "true", "Create archive"));
        }
        
        // Mac Catalyst specific
        if (wizardState.Platform == ApplePlatformType.MacCatalyst)
        {
            if (wizardState.Distribution == AppleDistributionType.AppStore)
            {
                props.Add(("CreatePackage", "true", "Create .pkg installer"));
            }
            else if (wizardState.Distribution == AppleDistributionType.Direct && wizardState.NeedsInstallerCert)
            {
                props.Add(("CreatePackage", "true", "Create .pkg installer"));
                if (exportedSecrets.Any(s => s.Name == "APPLE_INSTALLER_CERTIFICATE_P12"))
                {
                    props.Add(("PackageSigningKey", "APPLE_INSTALLER_IDENTITY", "Installer signing identity"));
                }
            }
        }
        
        // Notarization
        if (NeedsNotarization)
        {
            props.Add(("NotarizeAcUsername", "APPLE_NOTARIZATION_APPLE_ID", "Notarization Apple ID"));
            props.Add(("NotarizeAcPassword", "APPLE_NOTARIZATION_PASSWORD", "Notarization password"));
        }
        
        return props;
    }

    private string GenerateBashCommand(string tfm, List<(string Property, string EnvVar, string Description)> props)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("# Set environment variables first");
        sb.AppendLine("# export APPLE_CODESIGN_IDENTITY=\"Apple Distribution: ...\"");
        sb.AppendLine("# export APPLE_PROVISIONING_PROFILE_NAME=\"My Profile\"");
        sb.AppendLine();
        sb.AppendLine("dotnet publish -f " + tfm + " -c Release \\");
        
        for (int i = 0; i < props.Count; i++)
        {
            var (property, envVar, _) = props[i];
            var isLast = i == props.Count - 1;
            var value = envVar == "true" ? "true" : $"\"${envVar}\"";
            sb.AppendLine($"  -p:{property}={value}" + (isLast ? "" : " \\"));
        }
        
        return sb.ToString();
    }

    private string GeneratePowerShellCommand(string tfm, List<(string Property, string EnvVar, string Description)> props)
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("# Set environment variables first");
        sb.AppendLine("# $env:APPLE_CODESIGN_IDENTITY = \"Apple Distribution: ...\"");
        sb.AppendLine("# $env:APPLE_PROVISIONING_PROFILE_NAME = \"My Profile\"");
        sb.AppendLine();
        sb.AppendLine("dotnet publish -f " + tfm + " -c Release `");
        
        for (int i = 0; i < props.Count; i++)
        {
            var (property, envVar, _) = props[i];
            var isLast = i == props.Count - 1;
            var value = envVar == "true" ? "true" : $"\"$env:{envVar}\"";
            sb.AppendLine($"  -p:{property}={value}" + (isLast ? "" : " `"));
        }
        
        return sb.ToString();
    }

    private string GenerateGitHubActionsCommand(string tfm, List<(string Property, string EnvVar, string Description)> props)
    {
        var sb = new System.Text.StringBuilder();
        var hasP12 = exportedSecrets.Any(s => s.Name == "APPLE_CERTIFICATE_P12");
        var hasProfile = exportedSecrets.Any(s => s.Name == "APPLE_PROVISIONING_PROFILE");
        var hasInstallerP12 = exportedSecrets.Any(s => s.Name == "APPLE_INSTALLER_CERTIFICATE_P12");
        
        sb.AppendLine("# Add these steps to your workflow (runs-on: macos-latest)");
        sb.AppendLine();
        
        // Certificate installation step
        if (hasP12)
        {
            sb.AppendLine("- name: Install Apple Certificate");
            sb.AppendLine("  env:");
            sb.AppendLine("    P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12 }}");
            sb.AppendLine("    P12_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}");
            sb.AppendLine("  run: |");
            sb.AppendLine("    # Create temporary keychain");
            sb.AppendLine("    KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db");
            sb.AppendLine("    KEYCHAIN_PASSWORD=$(openssl rand -base64 32)");
            sb.AppendLine("    security create-keychain -p \"$KEYCHAIN_PASSWORD\" $KEYCHAIN_PATH");
            sb.AppendLine("    security set-keychain-settings -lut 21600 $KEYCHAIN_PATH");
            sb.AppendLine("    security unlock-keychain -p \"$KEYCHAIN_PASSWORD\" $KEYCHAIN_PATH");
            sb.AppendLine("    ");
            sb.AppendLine("    # Import certificate");
            sb.AppendLine("    echo \"$P12_BASE64\" | base64 --decode > $RUNNER_TEMP/certificate.p12");
            sb.AppendLine("    security import $RUNNER_TEMP/certificate.p12 -P \"$P12_PASSWORD\" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH");
            sb.AppendLine("    security set-key-partition-list -S apple-tool:,apple: -k \"$KEYCHAIN_PASSWORD\" $KEYCHAIN_PATH");
            sb.AppendLine("    security list-keychain -d user -s $KEYCHAIN_PATH");
            sb.AppendLine();
        }
        
        // Installer certificate if needed
        if (hasInstallerP12)
        {
            sb.AppendLine("- name: Install Installer Certificate");
            sb.AppendLine("  env:");
            sb.AppendLine("    P12_BASE64: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12 }}");
            sb.AppendLine("    P12_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}");
            sb.AppendLine("  run: |");
            sb.AppendLine("    KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db");
            sb.AppendLine("    KEYCHAIN_PASSWORD=$(cat $RUNNER_TEMP/.keychain_password 2>/dev/null || echo \"\")");
            sb.AppendLine("    echo \"$P12_BASE64\" | base64 --decode > $RUNNER_TEMP/installer.p12");
            sb.AppendLine("    security import $RUNNER_TEMP/installer.p12 -P \"$P12_PASSWORD\" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH");
            sb.AppendLine();
        }
        
        // Provisioning profile installation step
        if (hasProfile)
        {
            sb.AppendLine("- name: Install Provisioning Profile");
            sb.AppendLine("  env:");
            sb.AppendLine("    PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE }}");
            sb.AppendLine("  run: |");
            sb.AppendLine("    mkdir -p ~/Library/MobileDevice/Provisioning\\ Profiles");
            sb.AppendLine("    echo \"$PROFILE_BASE64\" | base64 --decode > ~/Library/MobileDevice/Provisioning\\ Profiles/profile.mobileprovision");
            sb.AppendLine();
        }
        
        // Build step
        sb.AppendLine("- name: Publish App");
        sb.AppendLine("  run: |");
        sb.Append("    dotnet publish -f " + tfm + " -c Release");
        
        foreach (var (property, envVar, _) in props)
        {
            var value = envVar == "true" ? "true" : $"\"${{{{ secrets.{envVar} }}}}\"";
            sb.Append($" \\\n      -p:{property}={value}");
        }
        
        sb.AppendLine();
        
        // Cleanup step
        if (hasP12)
        {
            sb.AppendLine();
            sb.AppendLine("- name: Cleanup Keychain");
            sb.AppendLine("  if: always()");
            sb.AppendLine("  run: |");
            sb.AppendLine("    security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true");
            sb.AppendLine("    rm -f $RUNNER_TEMP/certificate.p12 $RUNNER_TEMP/installer.p12 || true");
        }
        
        sb.AppendLine();
        sb.AppendLine("# Required GitHub Secrets:");
        foreach (var secret in exportedSecrets.Where(s => s.IsSensitive))
        {
            sb.AppendLine($"# - {secret.Name}: {secret.Description}");
        }
        
        return sb.ToString();
    }

    private async Task CopyBuildCommand()
    {
        var command = GetBuildCommand();
        await DialogService.CopyToClipboardAsync(command);
        await AlertService.ShowToastAsync("Build command copied to clipboard");
    }
    
    // ==================== Publish Flow Methods ====================
    
    private List<PublisherRepository> filteredRepositories => allRepositories
        .Where(r => string.IsNullOrEmpty(repoSearchFilter) || 
                    r.FullName.Contains(repoSearchFilter, StringComparison.OrdinalIgnoreCase) ||
                    (r.Description?.Contains(repoSearchFilter, StringComparison.OrdinalIgnoreCase) ?? false))
        .OrderBy(r => r.FullName)
        .Take(50)
        .ToList();
    
    private bool AreAllSecretsSelected => selectedSecretNames.Count == exportedSecrets.Count;
    
    private bool CanProceedPublish => publishStep switch
    {
        1 => selectedPublisher != null,
        2 => selectedRepository != null,
        3 => selectedSecretNames.Count > 0,
        4 => true,
        _ => true
    };
    
    private async Task ShowPublishFlow()
    {
        showPublishModal = true;
        publishStep = 1;
        publishComplete = false;
        isPublishing = false;
        selectedPublisher = null;
        selectedRepository = null;
        selectedSecretNames = new HashSet<string>(exportedSecrets.Select(s => s.Name));
        allRepositories.Clear();
        repoSearchFilter = "";
        
        await LoadPublishers();
    }
    
    private void ClosePublishModal()
    {
        showPublishModal = false;
        publishStep = 1;
        publishComplete = false;
    }
    
    private async Task LoadPublishers()
    {
        isLoadingPublishers = true;
        StateHasChanged();
        
        try
        {
            configuredPublishers = (await SecretsPublisherService.GetPublishersAsync()).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load publishers: {ex.Message}", ex);
            configuredPublishers = new();
        }
        finally
        {
            isLoadingPublishers = false;
            StateHasChanged();
        }
    }
    
    private void SelectPublisher(SecretsPublisherConfig publisher)
    {
        selectedPublisher = publisher;
        selectedRepository = null;
        allRepositories.Clear();
    }
    
    private void SelectRepository(PublisherRepository repo)
    {
        selectedRepository = repo;
    }
    
    private void ToggleSecret(string name)
    {
        if (selectedSecretNames.Contains(name))
            selectedSecretNames.Remove(name);
        else
            selectedSecretNames.Add(name);
    }
    
    private void ToggleAllSecrets()
    {
        if (AreAllSecretsSelected)
            selectedSecretNames.Clear();
        else
            selectedSecretNames = new HashSet<string>(exportedSecrets.Select(s => s.Name));
    }
    
    private async Task NextPublishStep()
    {
        publishStep++;
        
        if (publishStep == 2 && selectedPublisher != null)
        {
            await LoadRepositories();
        }
    }
    
    private void PreviousPublishStep()
    {
        publishStep--;
    }
    
    private async Task LoadRepositories()
    {
        if (selectedPublisher == null) return;
        
        isLoadingRepos = true;
        StateHasChanged();
        
        try
        {
            // Use mediator for cached + offline-available repository loading
            var response = await Mediator.Request(new ListPublisherRepositoriesRequest(selectedPublisher.Id));
            allRepositories = response.Result.ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to load repositories: {ex.Message}", ex);
            allRepositories = new();
            await AlertService.ShowAlertAsync("Error", $"Failed to load repositories: {ex.Message}");
        }
        finally
        {
            isLoadingRepos = false;
            StateHasChanged();
        }
    }
    
    private void OnRepoSearchKeyUp(KeyboardEventArgs e)
    {
        // Just trigger re-render for filtering
        StateHasChanged();
    }
    
    private async Task ExecutePublish()
    {
        if (selectedPublisher == null || selectedRepository == null) return;
        
        isPublishing = true;
        publishingProgress = 0;
        publishingStatus = "Preparing secrets...";
        StateHasChanged();
        
        try
        {
            var secretsToPublish = exportedSecrets
                .Where(s => selectedSecretNames.Contains(s.Name))
                .ToDictionary(s => s.Name, s => s.Value);
            
            var total = secretsToPublish.Count;
            var current = 0;
            
            var progress = new Progress<string>(status =>
            {
                current++;
                publishingProgress = (int)((current / (double)total) * 100);
                publishingStatus = status;
                InvokeAsync(StateHasChanged);
            });
            
            await SecretsPublisherService.PublishSecretsAsync(
                selectedPublisher.Id, 
                selectedRepository.FullName, 
                secretsToPublish,
                progress);
            
            publishComplete = true;
            publishingProgress = 100;
            publishingStatus = "Complete!";
        }
        catch (Exception ex)
        {
            Logger.LogError($"Failed to publish secrets: {ex.Message}", ex);
            await AlertService.ShowAlertAsync("Error", $"Failed to publish secrets: {ex.Message}");
        }
        finally
        {
            isPublishing = false;
            StateHasChanged();
        }
    }
    
    private void GoToSettings()
    {
        ClosePublishModal();
        Close();
        Navigation.NavigateTo("/settings");
    }
    
    private string GetPublisherIcon(string providerId) => providerId switch
    {
        "github" => "fa-brands fa-github",
        "gitlab" => "fa-brands fa-gitlab",
        "azuredevops" => "fa-brands fa-microsoft",
        "gitea" => "fa-solid fa-code-branch",
        _ => "fa-solid fa-cloud"
    };
    
    private string GetPublisherDisplayName(string providerId) => providerId switch
    {
        "github" => "GitHub Actions",
        "gitlab" => "GitLab CI/CD",
        "azuredevops" => "Azure DevOps",
        "gitea" => "Gitea",
        _ => providerId
    };
    
    private string TruncateDescription(string? desc)
    {
        if (string.IsNullOrEmpty(desc)) return "";
        return desc.Length > 60 ? desc[..57] + "..." : desc;
    }
}
