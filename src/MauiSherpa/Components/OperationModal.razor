@using MauiSherpa.Core.Interfaces
@using MauiSherpa.Core.Services
@using MauiSherpa.Services
@inject OperationModalService ModalService
@inject ICopilotContextService CopilotContext
@inject IJSRuntime JS
@implements IDisposable

@if (ModalService.IsVisible)
{
    <div class="operation-modal-overlay" id="operation-modal">
        <div class="operation-modal @(ModalService.IsRunning ? "" : "completed")" role="dialog" aria-modal="true" aria-labelledby="operation-modal-title">
            <div class="modal-header">
                <h2 id="operation-modal-title">
                    @if (ModalService.IsRunning)
                    {
                        <i class="fas fa-spinner fa-spin"></i>
                    }
                    else if (ModalService.CurrentState == OperationState.Completed)
                    {
                        <i class="fas fa-check-circle success-icon"></i>
                    }
                    else if (ModalService.CurrentState == OperationState.Failed)
                    {
                        <i class="fas fa-times-circle error-icon"></i>
                    }
                    else if (ModalService.CurrentState == OperationState.Cancelled)
                    {
                        <i class="fas fa-ban warning-icon"></i>
                    }
                    @ModalService.Title
                </h2>
                @if (!ModalService.IsRunning)
                {
                    <button class="close-btn" @onclick="HandleClose"><i class="fas fa-times"></i></button>
                }
            </div>

            <div class="modal-body">
                <div class="description">@ModalService.Description</div>

                @if (ModalService.IsRunning)
                {
                    <div class="progress-section">
                        @if (!string.IsNullOrEmpty(ModalService.CurrentStatus))
                        {
                            <div class="status-text">@ModalService.CurrentStatus</div>
                        }
                        <div class="progress-bar-container">
                            @if (ModalService.CurrentProgress.HasValue)
                            {
                                <div class="progress-bar" style="width: @(ModalService.CurrentProgress)%"></div>
                                <span class="progress-text">@(ModalService.CurrentProgress)%</span>
                            }
                            else
                            {
                                <div class="progress-bar indeterminate"></div>
                            }
                        </div>
                        <div class="elapsed-time">
                            <i class="fas fa-clock"></i> @ElapsedTime
                        </div>
                    </div>
                }
                else
                {
                    <div class="result-section">
                        <div class="result-status @GetResultClass()">
                            <i class="fas @GetResultIcon()"></i>
                            <span>@GetResultText()</span>
                        </div>
                        <div class="result-details">
                            <span><i class="fas fa-clock"></i> Duration: @Duration</span>
                        </div>
                    </div>
                }

                <div class="log-section">
                    <div class="log-header">
                        <span><i class="fas fa-list"></i> Activity Log</span>
                        <button class="btn-icon" @onclick="CopyLog" title="Copy log">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="log-container" @ref="_logContainer">
                        @foreach (var entry in ModalService.LogEntries)
                        {
                            <div class="log-entry @GetLogLevelClass(entry.Level)">
                                <span class="log-time">@entry.Timestamp.ToString("HH:mm:ss")</span>
                                <i class="fas @GetLogLevelIcon(entry.Level)"></i>
                                <span class="log-message">@entry.Message</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                @if (ModalService.IsRunning && ModalService.CanCancel)
                {
                    <button class="btn btn-warning" @onclick="HandleCancel">
                        <i class="fas fa-stop"></i> Cancel
                    </button>
                }
                @if (!ModalService.IsRunning)
                {
                    @if (ModalService.CurrentState == OperationState.Failed)
                    {
                        <button class="btn btn-copilot" @onclick="HandleTryWithCopilot">
                            <i class="fas fa-robot"></i> Try with Copilot
                        </button>
                    }
                    <button class="btn btn-primary" @onclick="HandleClose">
                        <i class="fas fa-check"></i> Close
                    </button>
                }
            </div>
        </div>
    </div>
}

<style>
    .operation-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        backdrop-filter: blur(2px);
    }

    .operation-modal {
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 1.25rem 3.75rem rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a202c;
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .modal-header h2 i { font-size: 1.25rem; }
    .modal-header h2 .success-icon { color: #38a169; }
    .modal-header h2 .error-icon { color: #e53e3e; }
    .modal-header h2 .warning-icon { color: #d69e2e; }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.125rem;
        color: #a0aec0;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
    }

    .close-btn:hover { color: #4a5568; }

    .modal-body {
        flex: 1;
        padding: 1.25rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .description {
        color: #4a5568;
        font-size: 0.875rem;
    }

    .progress-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .status-text {
        font-size: 0.875rem;
        color: #2d3748;
        font-weight: 500;
    }

    .progress-bar-container {
        height: 0.5rem;
        background: #e2e8f0;
        border-radius: 0.25rem;
        overflow: hidden;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #4299e1, #667eea);
        border-radius: 0.25rem;
        transition: width 0.3s ease;
    }

    .progress-bar.indeterminate {
        width: 30%;
        animation: indeterminate 1.5s infinite ease-in-out;
    }

    @@keyframes indeterminate {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(400%); }
    }

    .progress-text {
        position: absolute;
        right: 0;
        top: -20px;
        font-size: 0.75rem;
        color: #718096;
    }

    .elapsed-time {
        font-size: 0.8125rem;
        color: #718096;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .result-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .result-status {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.875rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
    }

    .result-status.success {
        background: #f0fff4;
        border: 1px solid #68d391;
        color: #276749;
    }

    .result-status.error {
        background: #fff5f5;
        border: 1px solid #fc8181;
        color: #c53030;
    }

    .result-status.cancelled {
        background: #fffbeb;
        border: 1px solid #f6e05e;
        color: #975a16;
    }

    .result-details {
        font-size: 0.8125rem;
        color: #718096;
        display: flex;
        gap: 1rem;
    }

    .result-details span {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .log-section {
        flex: 1;
        min-height: 150px;
        max-height: 250px;
        display: flex;
        flex-direction: column;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: #f7fafc;
        border-bottom: 1px solid #e2e8f0;
        font-size: 0.8125rem;
        font-weight: 500;
        color: #4a5568;
    }

    .log-header span {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }

    .log-container {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        font-family: "SF Mono", Menlo, Monaco, monospace;
        font-size: 0.75rem;
        background: #1e1e1e;
    }

    .log-entry {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }

    .log-entry:hover { background: #2d2d2d; }

    .log-time {
        color: #718096;
        flex-shrink: 0;
    }

    .log-entry i {
        flex-shrink: 0;
        width: 0.875rem;
        text-align: center;
    }

    .log-message {
        color: #e2e8f0;
        word-break: break-word;
    }

    .log-entry.info i { color: #4299e1; }
    .log-entry.success i { color: #48bb78; }
    .log-entry.warning i { color: #ed8936; }
    .log-entry.error i { color: #fc8181; }
    .log-entry.debug i { color: #a0aec0; }

    .log-entry.success .log-message { color: #9ae6b4; }
    .log-entry.warning .log-message { color: #fbd38d; }
    .log-entry.error .log-message { color: #feb2b2; }

    .modal-footer {
        padding: 1rem 1.25rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        border: none;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary { background: #4299e1; color: white; }
    .btn-primary:hover:not(:disabled) { background: #3182ce; }

    .btn-warning { background: #ed8936; color: white; }
    .btn-warning:hover:not(:disabled) { background: #dd6b20; }

    .btn-copilot { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
    .btn-copilot:hover:not(:disabled) { background: linear-gradient(135deg, #4f46e5, #7c3aed); }

    .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        color: #718096;
        padding: 0.25rem;
    }

    .btn-icon:hover { color: #2d3748; }

    /* Dark mode overrides */
    .theme-dark .operation-modal { background: var(--bg-secondary, #2d3748); }
    .theme-dark .modal-header { border-bottom-color: var(--border-color, #4a5568); }
    .theme-dark .modal-header h2 { color: var(--text-primary, #e2e8f0); }
    .theme-dark .close-btn { color: #a0aec0; }
    .theme-dark .close-btn:hover { color: #e2e8f0; }
    .theme-dark .operation-message { color: var(--text-secondary, #a0aec0); }
    .theme-dark .status-text { color: var(--text-primary, #e2e8f0); }
    .theme-dark .progress-bar-bg { background: var(--bg-tertiary, #374151); }
    .theme-dark .elapsed-time { color: #a0aec0; }
    .theme-dark .percentage-text { color: #a0aec0; }
    .theme-dark .result-status.success { background: rgba(72, 187, 120, 0.15); border-color: #38a169; color: #9ae6b4; }
    .theme-dark .result-status.error { background: rgba(245, 101, 101, 0.15); border-color: #fc8181; color: #feb2b2; }
    .theme-dark .result-status.cancelled { background: rgba(237, 137, 54, 0.15); border-color: #ed8936; color: #fbd38d; }
    .theme-dark .result-details { color: #a0aec0; }
    .theme-dark .log-section { border-color: var(--border-color, #4a5568); }
    .theme-dark .log-header { background: var(--bg-tertiary, #374151); border-bottom-color: var(--border-color, #4a5568); color: var(--text-secondary, #a0aec0); }
    .theme-dark .btn-icon { color: #a0aec0; }
    .theme-dark .btn-icon:hover { color: #e2e8f0; }
    .theme-dark .btn-secondary { background: var(--bg-tertiary, #374151); color: var(--text-primary, #e2e8f0); }
    .theme-dark .btn-secondary:hover:not(:disabled) { background: #4a5568; }
</style>

@code {
    private ElementReference _logContainer;
    private System.Timers.Timer? _elapsedTimer;
    private DateTime _startTime;
    private DotNetObjectReference<OperationModal>? _dotNetRef;
    private bool _modalInitialized;
    private string ElapsedTime { get; set; } = "00:00";
    private string Duration { get; set; } = "00:00";

    protected override void OnInitialized()
    {
        ModalService.OnShowRequested += HandleShowRequested;
        ModalService.OnLogEntry += HandleLogEntry;
        ModalService.OnStateChanged += HandleStateChanged;
        ModalService.OnStatusChanged += HandleStatusChanged;
        ModalService.OnProgressChanged += HandleProgressChanged;
        _dotNetRef = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (ModalService.IsVisible && !_modalInitialized)
        {
            _modalInitialized = true;
            await JS.InvokeVoidAsync("modalInterop.initialize", "operation-modal", _dotNetRef);
        }
        else if (!ModalService.IsVisible && _modalInitialized)
        {
            _modalInitialized = false;
            await JS.InvokeVoidAsync("modalInterop.dispose", "operation-modal");
        }
    }

    [JSInvokable]
    public void OnEscapePressed()
    {
        if (!ModalService.IsRunning)
            HandleClose();
    }

    private void HandleShowRequested(string title, string description, bool canCancel)
    {
        _startTime = DateTime.Now;
        ElapsedTime = "00:00";

        _elapsedTimer = new System.Timers.Timer(1000);
        _elapsedTimer.Elapsed += (_, _) =>
        {
            var elapsed = DateTime.Now - _startTime;
            ElapsedTime = elapsed.ToString(@"mm\:ss");
            InvokeAsync(StateHasChanged);
        };
        _elapsedTimer.Start();

        InvokeAsync(StateHasChanged);
    }

    private void HandleLogEntry(OperationLogEntry entry)
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await Task.Delay(50);
            // Auto-scroll to bottom
            await ScrollToBottom();
        });
    }

    private void HandleStateChanged(OperationState state)
    {
        if (state != OperationState.Running)
        {
            _elapsedTimer?.Stop();
            _elapsedTimer?.Dispose();
            _elapsedTimer = null;
            Duration = (DateTime.Now - _startTime).ToString(@"mm\:ss\.fff");
        }
        InvokeAsync(async () =>
        {
            StateHasChanged();
            if (state != OperationState.Running)
                await JS.InvokeVoidAsync("modalInterop.focusFirst", "operation-modal");
        });
    }

    private void HandleStatusChanged(string status)
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleProgressChanged(int? progress)
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToBottom()
    {
        try
        {
            // Scroll log container to bottom
            await Task.CompletedTask; // JS interop would go here if needed
        }
        catch { }
    }

    private void HandleCancel()
    {
        ModalService.RequestCancellation();
    }

    private void HandleClose()
    {
        ModalService.Close();
    }

    private void HandleTryWithCopilot()
    {
        // Get error details from log
        var errorLogs = ModalService.LogEntries
            .Where(e => e.Level == OperationLogLevel.Error)
            .Select(e => e.Message)
            .ToList();
        
        var lastError = errorLogs.LastOrDefault() ?? "Operation failed";
        var allLogs = string.Join("\n", ModalService.LogEntries.Select(e => $"[{e.Level}] {e.Message}"));
        
        // Build context and open overlay
        var context = CopilotContextService.BuildOperationFailureContext(
            ModalService.Title ?? "Unknown operation",
            lastError,
            allLogs.Length > 2000 ? allLogs.Substring(0, 2000) + "..." : allLogs
        );
        
        CopilotContext.OpenWithContext(context);
        
        // Close the modal - use HandleClose which handles proper cleanup
        HandleClose();
    }

    private async Task CopyLog()
    {
        var logText = string.Join("\n", ModalService.LogEntries.Select(e => 
            $"[{e.Timestamp:HH:mm:ss}] [{e.Level}] {e.Message}"));
        // Would use JS interop to copy to clipboard
        await Task.CompletedTask;
    }

    private string GetResultClass() => ModalService.CurrentState switch
    {
        OperationState.Completed => "success",
        OperationState.Failed => "error",
        OperationState.Cancelled => "cancelled",
        _ => ""
    };

    private string GetResultIcon() => ModalService.CurrentState switch
    {
        OperationState.Completed => "fa-check-circle",
        OperationState.Failed => "fa-times-circle",
        OperationState.Cancelled => "fa-ban",
        _ => "fa-circle"
    };

    private string GetResultText() => ModalService.CurrentState switch
    {
        OperationState.Completed => "Operation completed successfully",
        OperationState.Failed => "Operation failed",
        OperationState.Cancelled => "Operation was cancelled",
        _ => ""
    };

    private string GetLogLevelClass(OperationLogLevel level) => level switch
    {
        OperationLogLevel.Debug => "debug",
        OperationLogLevel.Info => "info",
        OperationLogLevel.Warning => "warning",
        OperationLogLevel.Error => "error",
        OperationLogLevel.Success => "success",
        _ => "info"
    };

    private string GetLogLevelIcon(OperationLogLevel level) => level switch
    {
        OperationLogLevel.Debug => "fa-bug",
        OperationLogLevel.Info => "fa-info-circle",
        OperationLogLevel.Warning => "fa-exclamation-triangle",
        OperationLogLevel.Error => "fa-times-circle",
        OperationLogLevel.Success => "fa-check-circle",
        _ => "fa-info-circle"
    };

    public void Dispose()
    {
        ModalService.OnShowRequested -= HandleShowRequested;
        ModalService.OnLogEntry -= HandleLogEntry;
        ModalService.OnStateChanged -= HandleStateChanged;
        ModalService.OnStatusChanged -= HandleStatusChanged;
        ModalService.OnProgressChanged -= HandleProgressChanged;
        _elapsedTimer?.Dispose();
        if (_modalInitialized)
            _ = JS.InvokeVoidAsync("modalInterop.dispose", "operation-modal");
        _dotNetRef?.Dispose();
    }
}
