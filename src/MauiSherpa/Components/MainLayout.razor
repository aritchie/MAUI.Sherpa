@inherits LayoutComponentBase
@using MauiSherpa.Core.Interfaces
@inject IThemeService ThemeService
@inject ISplashService SplashService
@inject ISettingsMigrationService MigrationService
@inject ILoggingService Logger
@implements IDisposable

<div class="main-layout @ThemeClass">
    <nav class="sidebar">
        <div class="sidebar-menu">
            <NavLink class="nav-item" href="" Match="NavLinkMatch.All">
                <i class="fas fa-home nav-icon"></i>
                <span>Dashboard</span>
            </NavLink>
            <NavLink class="nav-item" href="doctor">
                <i class="fas fa-stethoscope nav-icon"></i>
                <span>Doctor</span>
            </NavLink>
            <NavLink class="nav-item" href="settings">
                <i class="fas fa-cog nav-icon"></i>
                <span>Settings</span>
            </NavLink>
            
            <div class="nav-section"><i class="fab fa-android nav-section-icon"></i> Android</div>
            <NavLink class="nav-item" href="android-sdk">
                <i class="fas fa-cube nav-icon"></i>
                <span>SDK Packages</span>
            </NavLink>
            <NavLink class="nav-item" href="devices">
                <i class="fas fa-mobile-alt nav-icon"></i>
                <span>Devices</span>
            </NavLink>
            <NavLink class="nav-item" href="emulators">
                <i class="fas fa-desktop nav-icon"></i>
                <span>Emulators</span>
            </NavLink>
            
            <div class="nav-section"><i class="fab fa-apple nav-section-icon"></i> Apple</div>
            <NavLink class="nav-item" href="bundle-ids">
                <i class="fas fa-fingerprint nav-icon"></i>
                <span>Bundle IDs</span>
            </NavLink>
            <NavLink class="nav-item" href="apple-devices">
                <i class="fas fa-mobile-alt nav-icon"></i>
                <span>Devices</span>
            </NavLink>
            <NavLink class="nav-item" href="certificates">
                <i class="fas fa-certificate nav-icon"></i>
                <span>Certificates</span>
            </NavLink>
            <NavLink class="nav-item" href="profiles">
                <i class="fas fa-id-card nav-icon"></i>
                <span>Provisioning Profiles</span>
            </NavLink>
            <NavLink class="nav-item" href="root-certificates">
                <i class="fas fa-shield-alt nav-icon"></i>
                <span>Root Certificates</span>
            </NavLink>
        </div>
    </nav>
    <main class="content">
        @Body
    </main>
</div>

<!-- Global Process Execution Modal -->
<MauiSherpa.Components.ProcessExecutionModal />

<!-- Global Operation Modal -->
<MauiSherpa.Components.OperationModal />

<!-- Global Multi-Operation Modal -->
<MauiSherpa.Components.MultiOperationModal />

<!-- Global Copilot Overlay -->
<MauiSherpa.Components.CopilotOverlay />

<!-- Global Toast Notifications -->
<MauiSherpa.Components.ToastContainer />

@code {
    private string ThemeClass => ThemeService.IsDarkMode ? "theme-dark" : "theme-light";

    protected override void OnInitialized()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
    }
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Notify MAUI that Blazor is ready - splash can be hidden
            SplashService.NotifyBlazorReady();
            
            // Run settings migration in background
            _ = RunMigrationAsync();
        }
    }

    private async Task RunMigrationAsync()
    {
        try
        {
            if (await MigrationService.NeedsMigrationAsync())
            {
                Logger.LogInformation("Running settings migration...");
                await MigrationService.MigrateAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Settings migration failed: {ex.Message}", ex);
        }
    }

    private void OnThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

<style>
    .main-layout {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    .sidebar {
        width: 250px;
        background-color: #2d3748;
        color: white;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    .sidebar-menu {
        flex: 1;
        padding: 20px 0;
    }

    .nav-section {
        padding: 20px 20px 8px 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #718096;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .nav-section-icon {
        font-size: 14px;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        color: #cbd5e0;
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .nav-icon {
        width: 18px;
        text-align: center;
        font-size: 14px;
        opacity: 0.8;
    }

    .nav-item:hover {
        background-color: #4a5568;
        color: white;
    }
    
    .nav-item:hover .nav-icon {
        opacity: 1;
    }

    .nav-item.active {
        background-color: #4a5568;
        color: white;
        border-left-color: #8b5cf6;
    }
    
    .nav-item.active .nav-icon {
        opacity: 1;
        color: #8b5cf6;
    }

    .content {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
        background-color: var(--bg-primary);
        color: var(--text-primary);
    }

    /* Light theme (default) */
    .theme-light {
        --bg-primary: #f7fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #edf2f7;
        --text-primary: #2d3748;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff;
        --input-border: #e2e8f0;
        --hover-bg: #f7fafc;
        --accent-bg: #faf5ff;
    }

    /* Dark theme */
    .theme-dark {
        --bg-primary: #1a202c;
        --bg-secondary: #2d3748;
        --bg-tertiary: #4a5568;
        --text-primary: #e2e8f0;
        --text-secondary: #cbd5e0;
        --text-muted: #a0aec0;
        --border-color: #4a5568;
        --card-bg: #2d3748;
        --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        --input-bg: #2d3748;
        --input-border: #4a5568;
        --hover-bg: #4a5568;
        --accent-bg: #312e81;
    }

    .theme-dark .sidebar {
        background-color: #171923;
    }

    .theme-dark .nav-section {
        color: #a0aec0;
    }
</style>
