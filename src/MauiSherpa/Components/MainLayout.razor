@inherits LayoutComponentBase
@using MauiSherpa.Core.Interfaces
@inject IThemeService ThemeService
@inject IEncryptedSettingsService EncryptedSettings
@inject ISplashService SplashService
@inject ISettingsMigrationService MigrationService
@inject IAdbDeviceWatcherService DeviceWatcher
@inject ILoggingService Logger
@inject IEncryptedSettingsService SettingsService
@inject IJSRuntime JS
@implements IDisposable

<div class="main-layout @ThemeClass">
    <nav class="sidebar">
        <div class="sidebar-drag-region"></div>
        <div class="sidebar-menu">
            <NavLink class="nav-item" href="" Match="NavLinkMatch.All">
                <i class="fas fa-home nav-icon"></i>
                <span>Dashboard</span>
            </NavLink>
            <NavLink class="nav-item" href="doctor">
                <i class="fas fa-stethoscope nav-icon"></i>
                <span>Doctor</span>
            </NavLink>
            <NavLink class="nav-item" href="settings">
                <i class="fas fa-cog nav-icon"></i>
                <span>Settings</span>
            </NavLink>
            
            <div class="nav-section"><i class="fab fa-android nav-section-icon"></i> Android</div>
            <NavLink class="nav-item" href="devices">
                <i class="fas fa-mobile-alt nav-icon"></i>
                <span>Devices</span>
            </NavLink>
            <NavLink class="nav-item" href="emulators">
                <i class="fas fa-desktop nav-icon"></i>
                <span>Emulators</span>
            </NavLink>
            <NavLink class="nav-item" href="android-sdk">
                <i class="fas fa-cube nav-icon"></i>
                <span>SDK Packages</span>
            </NavLink>
            <NavLink class="nav-item" href="keystores">
                <i class="fas fa-key nav-icon"></i>
                <span>Keystores</span>
            </NavLink>
            
            <div class="nav-section"><i class="fab fa-apple nav-section-icon"></i> Apple</div>
            <NavLink class="nav-item" href="apple-simulators">
                <i class="fas fa-tablet-screen-button nav-icon"></i>
                <span>Devices</span>
            </NavLink>
            <NavLink class="nav-item" href="apple-devices">
                <i class="fas fa-mobile-alt nav-icon"></i>
                <span>Registered Devices</span>
            </NavLink>
            <NavLink class="nav-item" href="bundle-ids">
                <i class="fas fa-fingerprint nav-icon"></i>
                <span>Bundle IDs</span>
            </NavLink>
            <NavLink class="nav-item" href="certificates">
                <i class="fas fa-certificate nav-icon"></i>
                <span>Certificates</span>
            </NavLink>
            <NavLink class="nav-item" href="profiles">
                <i class="fas fa-id-card nav-icon"></i>
                <span>Provisioning Profiles</span>
            </NavLink>
            <NavLink class="nav-item" href="root-certificates">
                <i class="fas fa-shield-alt nav-icon"></i>
                <span>Root Certificates</span>
            </NavLink>

            @if (isDebugBuild && !isDemoMode)
            {
                <div class="nav-section"><i class="fas fa-flask nav-section-icon"></i> Development</div>
                <NavLink class="nav-item" href="debug">
                    <i class="fas fa-bug nav-icon"></i>
                    <span>Debug UI</span>
                </NavLink>
            }
        </div>
    </nav>
    <main class="content">
        <div class="content-drag-region"></div>
        @Body
    </main>
</div>

<!-- Global Process Execution Modal -->
<MauiSherpa.Components.ProcessExecutionModal />

<!-- Global Operation Modal -->
<MauiSherpa.Components.OperationModal />

<!-- Global Multi-Operation Modal -->
<MauiSherpa.Components.MultiOperationModal />

<!-- Global Copilot Overlay -->
<MauiSherpa.Components.CopilotOverlay />

<!-- Global Toast Notifications -->
<MauiSherpa.Components.ToastContainer />

<!-- Global Logcat Panel -->
<MauiSherpa.Components.LogcatPanel />

<!-- Global iOS Simulator Log Panel -->
<MauiSherpa.Components.SimLogPanel />

@code {
    private string ThemeClass => ThemeService.IsDarkMode ? "theme-dark" : "theme-light";
    private bool isDemoMode;

#if DEBUG
    private bool isDebugBuild = true;
#else
    private bool isDebugBuild = false;
#endif

    protected override void OnInitialized()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
    }
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            // Notify MAUI that Blazor is ready - splash can be hidden
            SplashService.NotifyBlazorReady();
            
            // Sync theme class to body for modals rendered outside layout
            _ = SyncBodyThemeAsync();
            
            // Apply persisted font scale
            _ = SyncFontScaleAsync();
            
            // Run settings migration in background
            _ = RunMigrationAsync();

            // Start watching for ADB device changes
            _ = DeviceWatcher.StartAsync();

            // Load demo mode setting
            _ = LoadDemoModeAsync();
        }
    }

    private async Task RunMigrationAsync()
    {
        try
        {
            if (await MigrationService.NeedsMigrationAsync())
            {
                Logger.LogInformation("Running settings migration...");
                await MigrationService.MigrateAsync();
            }
            
            // Restore persisted font scale
            var settings = await EncryptedSettings.GetSettingsAsync();
            if (Math.Abs(settings.Preferences.FontScale - 1.0) > 0.001)
            {
                ThemeService.SetFontScale(settings.Preferences.FontScale);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError($"Settings migration failed: {ex.Message}", ex);
        }
    }

    private async Task LoadDemoModeAsync()
    {
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            isDemoMode = settings.Preferences.DemoMode;
            await InvokeAsync(StateHasChanged);
        }
        catch { }
    }

    private async void OnThemeChanged()
    {
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await SyncBodyThemeAsync();
            await SyncFontScaleAsync();
        });
    }

    private async Task SyncBodyThemeAsync()
    {
        try
        {
            var cls = ThemeService.IsDarkMode ? "theme-dark" : "theme-light";
            await JS.InvokeVoidAsync("eval", $"document.body.className = '{cls}'");
        }
        catch { }
    }

    private async Task SyncFontScaleAsync()
    {
        try
        {
            var sizePx = 16.0 * ThemeService.FontScale;
            await JS.InvokeVoidAsync("eval", $"document.documentElement.style.fontSize = '{sizePx:F1}px'");
        }
        catch { }
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

<style>
    .main-layout {
        display: flex;
        height: 100vh;
        width: 100vw;
        --titlebar-height: 28px;
    }

    .sidebar {
        width: 250px;
        min-height: 0;
        max-height: 100vh;
        overflow: hidden;
        background-color: #2d3748;
        color: white;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 0.3125rem rgba(0, 0, 0, 0.1);
    }

    .sidebar-drag-region {
        height: var(--titlebar-height);
        -webkit-app-region: drag;
        flex-shrink: 0;
    }

    .sidebar-menu {
        flex: 1;
        overflow-y: auto;
        padding: 1.25rem 0 5rem 0;
        scrollbar-width: none;
    }

    .sidebar-menu::-webkit-scrollbar {
        width: 0;
    }

    .sidebar-menu:hover {
        scrollbar-width: thin;
        scrollbar-color: rgba(255,255,255,0.2) transparent;
    }

    .sidebar-menu:hover::-webkit-scrollbar {
        width: 6px;
    }

    .sidebar-menu:hover::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
    }

    .sidebar-menu:hover::-webkit-scrollbar-track {
        background: transparent;
    }

    .nav-section {
        padding: 1.25rem 1.25rem 0.5rem 1.25rem;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #718096;
        letter-spacing: 0.05em;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .nav-section-icon {
        font-size: 0.875rem;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1.25rem;
        color: #cbd5e0;
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .nav-icon {
        width: 18px;
        text-align: center;
        font-size: 0.875rem;
        opacity: 0.8;
    }

    .nav-item:hover {
        background-color: #4a5568;
        color: white;
    }
    
    .nav-item:hover .nav-icon {
        opacity: 1;
    }

    .nav-item.active {
        background-color: #4a5568;
        color: white;
        border-left-color: #8b5cf6;
    }
    
    .nav-item.active .nav-icon {
        opacity: 1;
        color: #8b5cf6;
    }

    .content {
        flex: 1;
        padding: 30px;
        padding-top: calc(var(--titlebar-height) + 10px);
        overflow-y: auto;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        position: relative;
        scrollbar-width: none;
    }

    .content::-webkit-scrollbar {
        width: 0;
    }

    .content:hover {
        scrollbar-width: thin;
        scrollbar-color: rgba(128,128,128,0.3) transparent;
    }

    .content:hover::-webkit-scrollbar {
        width: 6px;
    }

    .content:hover::-webkit-scrollbar-thumb {
        background: rgba(128,128,128,0.3);
        border-radius: 3px;
    }

    .content:hover::-webkit-scrollbar-track {
        background: transparent;
    }

    .content-drag-region {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: var(--titlebar-height);
        -webkit-app-region: drag;
    }

    /* Light theme (default) */
    .theme-light {
        --bg-primary: #f7fafc;
        --bg-secondary: #ffffff;
        --bg-tertiary: #edf2f7;
        --text-primary: #2d3748;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --border-color: #e2e8f0;
        --card-bg: #ffffff;
        --card-shadow: 0 2px 0.25rem rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff;
        --input-border: #e2e8f0;
        --hover-bg: #f7fafc;
        --accent-bg: #faf5ff;
    }

    /* Dark theme */
    .theme-dark {
        --bg-primary: #1a202c;
        --bg-secondary: #2d3748;
        --bg-tertiary: #4a5568;
        --text-primary: #e2e8f0;
        --text-secondary: #cbd5e0;
        --text-muted: #a0aec0;
        --border-color: #4a5568;
        --card-bg: #2d3748;
        --card-shadow: 0 2px 0.25rem rgba(0, 0, 0, 0.3);
        --input-bg: #2d3748;
        --input-border: #4a5568;
        --hover-bg: #4a5568;
        --accent-bg: #312e81;
    }

    .theme-dark .sidebar {
        background-color: #171923;
    }

    .theme-dark .nav-section {
        color: #a0aec0;
    }
</style>
